#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªØ­Ù„ÛŒÙ„ÛŒ Ø¬Ø§Ù…Ø¹ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ Ø¢Ø²Ø§Ø¯ Ø§Ø³Ù„Ø§Ù…ÛŒ Ø§Ø³ØªØ§Ù† Ù…Ø±Ú©Ø²ÛŒ
Comprehensive Analytics Dashboard - Islamic Azad University Markazi Province

Ù†Ø­ÙˆÙ‡ Ø§Ø¬Ø±Ø§:
pip install streamlit pandas matplotlib seaborn plotly numpy openpyxl
streamlit run app.py
"""

import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import warnings
from datetime import datetime, timedelta
import base64
from io import BytesIO
import os

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡
warnings.filterwarnings('ignore')
plt.style.use('default')

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØµÙØ­Ù‡ Streamlit
st.set_page_config(
    page_title="Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªØ­Ù„ÛŒÙ„ÛŒ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ Ø¢Ø²Ø§Ø¯ Ø§Ø³Ù„Ø§Ù…ÛŒ",
    # The path you wrote uses a single backslash, which in Python strings is an escape character.
    # To specify a Windows path, use either a raw string (prefix with r) or double backslashes.
    # Also, Streamlit's page_icon can accept a path, but it's best to use a relative path or ensure the file exists.
    # Example with raw string:
    page_icon=r"E:\fixedp\Azad_University_logo.png",
    # Or with double backslashes:
    # page_icon="E:\\fixedp\\Azad_University_logo.png",
    layout="wide",
    initial_sidebar_state="expanded"
)

# CSS Ø³ÙØ§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ Ø¸Ø§Ù‡Ø±
st.markdown("""
<style>
.main-header {
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    padding: 2rem;
    border-radius: 10px;
    margin-bottom: 2rem;
    color: white;
    text-align: center;
}

.metric-card {
    background: white;
    padding: 1rem;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid #667eea;
}

.insight-box {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 10px;
    border-left: 4px solid #28a745;
    margin: 1rem 0;
}

.warning-box {
    background: #fff3cd;
    padding: 1.5rem;
    border-radius: 10px;
    border-left: 4px solid #ffc107;
    margin: 1rem 0;
}

.recommendation-box {
    background: #d1ecf1;
    padding: 1.5rem;
    border-radius: 10px;
    border-left: 4px solid #17a2b8;
    margin: 1rem 0;
}

.stSelectbox {
    direction: rtl;
}

.stMarkdown {
    text-align: right;
}

/* Use B Nazanin across the app if available */
body, .main-header, .metric-card, .insight-box, .warning-box, .recommendation-box, .stMarkdown {
    font-family: 'B Nazanin', Vazir, Tahoma, Arial, sans-serif;
}
</style>
""", unsafe_allow_html=True)

def _render_paragraph(title: str, text: str):
    """Ù†Ù…Ø§ÛŒØ´ ØªØ­Ù„ÛŒÙ„ Ø¨Ù‡ ØµÙˆØ±Øª Ù…ØªÙ† Ù¾ÛŒÙˆØ³ØªÙ‡ (Ù†Ù‡ Ø¨ÙˆÙ„Øª)ØŒ Ø¯Ø± ÛŒÚ© Ø¬Ø¹Ø¨Ù‡ ØªÙˆØ¶ÛŒØ­."""
    html = f"""
    <div class="insight-box">
      <h4>{title}</h4>
      <p style="line-height:1.9;text-align:justify;white-space:pre-wrap">{text}</p>
    </div>
    """
    st.markdown(html, unsafe_allow_html=True)

@st.cache_data
def load_sample_data():
    """Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡"""
    
    # Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø­Ø§Ù…ÛŒØ§Ù†
    np.random.seed(42)  # Ø¨Ø±Ø§ÛŒ ØªÚ©Ø±Ø§Ø±Ù¾Ø°ÛŒØ±ÛŒ
    
    supporters_data = {
        'Ù†Ø§Ù…_Ù†Ù…Ø§ÛŒØ´ÛŒ': ['Negar Lali', 'Mostafa Mohammadi', 'Nasrin Hoseini', 'Ahmad Rashedi', 'Maryam Mahlooji'] + 
                      [f'Ø­Ø§Ù…ÛŒ {i}' for i in range(6, 79)],
        'Ø±Ø§ÛŒØ§Ù†Ø§Ù…Ù‡': [f'sup{121000+i:06d}@iau.ir' for i in range(78)],
        'Ø®ÙˆØ´Ù‡_Ù‡Ø§': np.random.randint(10, 300, 78),
        'Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§': [913, 406, 293, 180, 156] + 
                         [np.random.randint(0, 200) if np.random.random() > 0.75 else 0 for _ in range(73)],
        'Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¬Ø¯ÛŒØ¯': [0, 0, 1, 2, 0] + [np.random.randint(0, 5) for _ in range(73)],
        'Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¯Ø±_Ø­Ø§Ù„_Ø§Ù†Ø¬Ø§Ù…': [1, 0, 1, 2, 1] + [np.random.randint(0, 8) for _ in range(73)],
        'Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡': [802, 405, 290, 165, 145] + [np.random.randint(0, 180) for _ in range(73)],
        'Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø±Ø¯_Ø´Ø¯Ù‡': [110, 1, 2, 11, 10] + [np.random.randint(0, 25) for _ in range(73)]
    }
    
    # Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆØ§Ø­Ø¯Ù‡Ø§
    units_data = {
        'Ù†Ø§Ù…_ÙˆØ§Ø­Ø¯': ['Ø§Ø±Ø§Ú©-121', 'Ø³Ø§ÙˆÙ‡-181', 'Ø®Ù…ÛŒÙ†-262', 'Ø¬Ø§Ø³Ø¨-340', 'Ù†Ø±Ø§Ù‚-185', 'Ø¢Ø´ØªÛŒØ§Ù†-199', 'Ø¯Ù„ÛŒØ¬Ø§Ù†-495',
                    'Ù…Ø­Ù„Ø§Øª-303', 'Ø´Ø§Ø²Ù†Ø¯-441', 'ÙØ±Ø§Ù‡Ø§Ù†-363', 'Ø¢Ù…ÙˆØ²Ø´Ú©Ø¯Ù‡ ÙÙ†ÛŒ Ø³Ø§ÙˆÙ‡-363', 'Ø¢Ù…ÙˆØ²Ø´Ú©Ø¯Ù‡ ÙÙ†ÛŒ Ø®Ù…ÛŒÙ†-441'],
        'Ú©Ø¯_ÙˆØ§Ø­Ø¯': ['121', '181', '262', '340', '185', '199', '495', '303', '441', '363', '363-A', '441-A'],
        'Ø§Ø³ØªØ§Ù†': ['Ù…Ø±Ú©Ø²ÛŒ'] * 12,
        'ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†': [12797, 7232, 2739, 1907, 1442, 1122, 394, 280, 156, 89, 45, 23],
        'Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§': [12657, 9497, 3146, 573, 1956, 1208, 502, 298, 167, 92, 48, 25],
        'Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¬Ø¯ÛŒØ¯': [11, 6, 3, 0, 109, 10, 0, 2, 1, 0, 0, 0],
        'Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¯Ø±_Ø­Ø§Ù„_Ø§Ù†Ø¬Ø§Ù…': [98, 46, 4, 5, 178, 0, 1, 3, 2, 1, 0, 0],
        'Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡': [12086, 8992, 3065, 546, 1592, 1021, 501, 285, 158, 88, 46, 24],
        'Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø±Ø¯_Ø´Ø¯Ù‡': [462, 453, 74, 22, 77, 177, 0, 8, 6, 3, 2, 1]
    }
    
    # Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ (Ù†Ù…ÙˆÙ†Ù‡ Ú©ÙˆÚ†Ú©â€ŒØªØ±)
    cluster_names = []
    degrees = ['Ú©Ø§Ø±Ø´Ù†Ø§Ø³ÛŒ Ù¾ÛŒÙˆØ³ØªÙ‡', 'Ú©Ø§Ø±Ø´Ù†Ø§Ø³ÛŒ Ø§Ø±Ø´Ø¯', 'Ú©Ø§Ø±Ø´Ù†Ø§Ø³ÛŒ Ù†Ø§Ù¾ÛŒÙˆØ³ØªÙ‡', 'Ú©Ø§Ø±Ø¯Ø§Ù†ÛŒ Ù¾ÛŒÙˆØ³ØªÙ‡', 'Ø¯Ú©ØªØ±ÛŒ ØªØ®ØµØµÛŒ']
    fields = ['Ù…Ù‡Ù†Ø¯Ø³ÛŒ Ø¹Ù…Ø±Ø§Ù†', 'Ù…Ù‡Ù†Ø¯Ø³ÛŒ Ù…Ú©Ø§Ù†ÛŒÚ©', 'Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ', 'Ù…Ø¯ÛŒØ±ÛŒØª', 'Ø¹Ù„ÙˆÙ… ØªØ±Ø¨ÛŒØªÛŒ', 'Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ', 'Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ']
    units = ['Ø§Ø±Ø§Ú©', 'Ø³Ø§ÙˆÙ‡', 'Ø®Ù…ÛŒÙ†', 'Ù†Ø±Ø§Ù‚', 'Ø¢Ø´ØªÛŒØ§Ù†', 'Ø¬Ø§Ø³Ø¨']
    
    for i in range(1000):
        degree = np.random.choice(degrees, p=[0.45, 0.25, 0.15, 0.10, 0.05])
        field = np.random.choice(fields)
        unit = np.random.choice(units)
        cluster_names.append(f"{degree}_{field}_{unit}_{4000+i}")
    
    clusters_data = {
        'Ù†Ø§Ù…_Ø®ÙˆØ´Ù‡': cluster_names,
        'ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†': np.random.randint(1, 50, 1000),
        'Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§': np.random.randint(0, 100, 1000),
        'Ù…Ù‚Ø·Ø¹': [name.split('_')[0] for name in cluster_names],
        'Ø±Ø´ØªÙ‡': [name.split('_')[1] for name in cluster_names],
        'ÙˆØ§Ø­Ø¯': [name.split('_')[2] for name in cluster_names]
    }
    
    return pd.DataFrame(supporters_data), pd.DataFrame(units_data), pd.DataFrame(clusters_data)

def create_main_header():
    """Ø§ÛŒØ¬Ø§Ø¯ Ù‡Ø¯Ø± Ø§ØµÙ„ÛŒ"""
    # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÙˆÚ¯ÙˆÛŒ Ø³ÙØ§Ø±Ø´ÛŒ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¢Ù† Ø¨Ø§Ù„Ø§ÛŒ Ø¹Ù†ÙˆØ§Ù†
    logo_path = r"E:\fixedp\Azad_University_logo.png"
    logo_html = ""
    try:
        if os.path.exists(logo_path):
            with open(logo_path, 'rb') as _f:
                _b64 = base64.b64encode(_f.read()).decode()
                # Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø³ÙÛŒØ¯ Ú©ÙˆÚ†Ú© Ø¨Ø§ Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ú¯Ø±Ø¯ ØªØ§ Ø¢Ø±Ù… Ø±ÙˆÛŒ Ú¯Ø±Ø§Ø¯ÛŒØ§Ù† ÙˆØ§Ø¶Ø­ Ø¯ÛŒØ¯Ù‡ Ø´ÙˆØ¯
                logo_html = (
                    '<span style="display:inline-block; background:#FFFFFF; padding:8px 10px; '
                    'border-radius:10px; box-shadow:0 1px 3px rgba(0,0,0,0.15); margin-bottom:12px;">'
                    f'<img src="data:image/png;base64,{_b64}" alt="logo" style="max-height:96px; display:block;" />'
                    '</span>'
                )
    except Exception:
        logo_html = ""

    st.markdown(
        """
    <div class="main-header">
        {logo}
        <h1> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªØ­Ù„ÛŒÙ„ÛŒ Ø¬Ø§Ù…Ø¹</h1>
        <h2>Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ú©Ø§ØªØ¨Ø§Øª Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©ÛŒ</h2>
        <h3>Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ Ø¢Ø²Ø§Ø¯ Ø§Ø³Ù„Ø§Ù…ÛŒ Ø§Ø³ØªØ§Ù† Ù…Ø±Ú©Ø²ÛŒ</h3>
        <p>ğŸ“… Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: {now}</p>
    </div>
        """.format(logo=logo_html, now=datetime.now().strftime('%Y/%m/%d - %H:%M')),
        unsafe_allow_html=True,
    )

def display_key_metrics(supporters_df, units_df, clusters_df):
    """Ù†Ù…Ø§ÛŒØ´ Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ"""
    st.markdown("## ğŸ“Š Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ")
    
    col1, col2, col3, col4, col5, col6 = st.columns(6)
    
    # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§
    total_supporters = len(supporters_df)
    active_supporters = len(supporters_df[supporters_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'] > 0])
    total_students = units_df['ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†'].sum()
    total_requests = units_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'].sum()
    completion_rate = (units_df['Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡'].sum() / total_requests * 100)
    total_clusters = len(clusters_df)
    
    with col1:
        st.metric(
            label="ğŸ‘¥ Ú©Ù„ Ø­Ø§Ù…ÛŒØ§Ù†",
            value=f"{total_supporters:,}",
            delta=f"{active_supporters} ÙØ¹Ø§Ù„"
        )
    
    with col2:
        st.metric(
            label="ğŸ“ Ú©Ù„ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†", 
            value=f"{total_students:,}",
            delta="Ø§Ø³ØªØ§Ù† Ù…Ø±Ú©Ø²ÛŒ"
        )
    
    with col3:
        st.metric(
            label="ğŸ“‹ Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§",
            value=f"{total_requests:,}",
            delta=f"{completion_rate:.1f}% ØªÚ©Ù…ÛŒÙ„"
        )
    
    with col4:
        st.metric(
            label="âœ… Ù†Ø±Ø® Ù…ÙˆÙÙ‚ÛŒØª",
            value=f"{completion_rate:.1f}%",
            delta="Ø¨Ø§Ù„Ø§ÛŒ Ù‡Ø¯Ù 90%"
        )
    
    with col5:
        st.metric(
            label="ğŸ›ï¸ ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ÛŒ",
            value=f"{len(units_df):,}",
            delta="Ø§Ø³ØªØ§Ù† Ù…Ø±Ú©Ø²ÛŒ"
        )
    
    with col6:
        st.metric(
            label="ğŸ¯ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„",
            value=f"{total_clusters:,}",
            delta="Ù…Ù‚Ø§Ø·Ø¹ Ù…Ø®ØªÙ„Ù"
        )

def create_supporters_analysis(supporters_df):
    """ØªØ­Ù„ÛŒÙ„ Ø¬Ø§Ù…Ø¹ Ø­Ø§Ù…ÛŒØ§Ù†"""
    st.markdown("## ğŸ‘¥ ØªØ­Ù„ÛŒÙ„ Ø¬Ø§Ù…Ø¹ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø­Ø§Ù…ÛŒØ§Ù†")
    
    # ØªÙ‚Ø³ÛŒÙ… Ø¨Ù‡ Ø¯Ùˆ Ø³ØªÙˆÙ†
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("### ğŸ“Š ØªÙˆØ²ÛŒØ¹ Ø­Ø§Ù…ÛŒØ§Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ Ø­Ø¬Ù… Ú©Ø§Ø±")
        
        # Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø­Ø§Ù…ÛŒØ§Ù†
        def categorize_requests(count):
            if count == 0: return 'ØºÛŒØ±ÙØ¹Ø§Ù„ (0)'
            elif count <= 50: return 'Ú©Ù…â€ŒÚ©Ø§Ø± (1-50)'
            elif count <= 200: return 'Ù…ØªÙˆØ³Ø· (51-200)'
            elif count <= 500: return 'Ù¾Ø±Ú©Ø§Ø± (201-500)'
            else: return 'Ø¨Ø³ÛŒØ§Ø± Ù¾Ø±Ú©Ø§Ø± (500+)'
        
        supporters_df['Ø¯Ø³ØªÙ‡_Ø¨Ù†Ø¯ÛŒ'] = supporters_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'].apply(categorize_requests)
        category_counts = supporters_df['Ø¯Ø³ØªÙ‡_Ø¨Ù†Ø¯ÛŒ'].value_counts()
        
        # Ù†Ù…ÙˆØ¯Ø§Ø± Ø¯Ø§ÛŒØ±Ù‡â€ŒØ§ÛŒ
        fig_pie = px.pie(
            values=category_counts.values,
            names=category_counts.index,
            title="ØªÙˆØ²ÛŒØ¹ Ø­Ø§Ù…ÛŒØ§Ù†",
            color_discrete_sequence=px.colors.qualitative.Set3
        )
        fig_pie.update_traces(textposition='inside', textinfo='percent+label')
        fig_pie.update_layout(font_family="Arial", showlegend=True)
        st.plotly_chart(fig_pie, use_container_width=True)
        _render_paragraph(
            "ØªØ­Ù„ÛŒÙ„ ØªÙˆØ²ÛŒØ¹ Ø­Ø§Ù…ÛŒØ§Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ Ø­Ø¬Ù… Ú©Ø§Ø±",
            """
Ø§ÛŒÙ† Ù†Ù…ÙˆØ¯Ø§Ø± Ø¯Ø§ÛŒØ±Ù‡â€ŒØ§ÛŒ ØªØµÙˆÛŒØ±ÛŒ Ø§Ø² ØªØ±Ú©ÛŒØ¨ Ø¬Ù…Ø¹ÛŒØª Ø­Ø§Ù…ÛŒØ§Ù† Ø¨Ø± Ø­Ø³Ø¨ Ø­Ø¬Ù… Ú©Ø§Ø± Ø§Ø±Ø§Ø¦Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ùˆ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ú†Ù‡ Ù†Ø³Ø¨ØªÛŒ Ø§Ø² Ø­Ø§Ù…ÛŒØ§Ù† Ø¯Ø± Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ØŒ Ú©Ù…â€ŒÚ©Ø§Ø±ØŒ Ù…ØªÙˆØ³Ø·ØŒ Ù¾Ø±Ú©Ø§Ø± Ùˆ Ø¨Ø³ÛŒØ§Ø± Ù¾Ø±Ú©Ø§Ø± Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ù†Ø¯. Ø­Ø¶ÙˆØ± Ø³Ù‡Ù… Ù‚Ø§Ø¨Ù„ ØªÙˆØ¬Ù‡ÛŒ Ø§Ø² Ú¯Ø±ÙˆÙ‡ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø¨Ù‡ Ù…Ø¹Ù†Ø§ÛŒ Ø¸Ø±ÙÛŒØª Ø¢Ø²Ø§Ø¯ Ø§Ø² Ø¯Ø³Øªâ€ŒØ±ÙØªÙ‡ Ø§Ø³Øª Ùˆ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…Ø¯Ø§Ø®Ù„Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒØŒ Ø¢Ù…ÙˆØ²Ø´ Ù‡Ø¯ÙÙ…Ù†Ø¯ ÛŒØ§ Ø¨Ø§Ø²ØªÙˆØ²ÛŒØ¹ ÙˆØ¸Ø§ÛŒÙ Ø¯Ø§Ø±Ø¯. Ú¯Ø±ÙˆÙ‡ Ú©Ù…â€ŒÚ©Ø§Ø± Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø¨Ù‡ØªØ±ÛŒÙ† Ú©Ø§Ù†Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¬Ø°Ø¨ Ø¨Ø®Ø´ÛŒ Ø§Ø² Ø¨Ø§Ø± Ø­Ø§Ù…ÛŒØ§Ù† Ù¾Ø±Ú©Ø§Ø± Ø§Ø³Øª ØªØ§ Ø±ÛŒØ³Ú© ÙØ±Ø³ÙˆØ¯Ú¯ÛŒ Ú©Ø§Ù‡Ø´ ÛŒØ§Ø¨Ø¯. Ú¯Ø±ÙˆÙ‡ Ù…ØªÙˆØ³Ø· Ù†Ø´Ø§Ù†â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ø±ÛŒ Ù¾Ø§ÛŒØ¯Ø§Ø± Ø§Ø³Øª Ùˆ Ø¨Ø±Ø§ÛŒ Ù¾Ø§ÛŒØ´ Ø±ÙˆÙ†Ø¯Ù‡Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ÛŒ Ù…Ù†Ø§Ø³Ø¨ Ù…Ø­Ø³ÙˆØ¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯. ØªÙ…Ø±Ú©Ø² Ø¨Ø§Ù„Ø§ Ø¯Ø± Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ú©Ø§Ø± Ùˆ Ø¨Ø³ÛŒØ§Ø± Ù¾Ø±Ú©Ø§Ø±ØŒ Ø¯Ø± ØµÙˆØ±Øª Ù†Ø¨ÙˆØ¯ Ú©Ù†ØªØ±Ù„ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ú©ÛŒÙÛŒØª Ù¾Ø§Ø³Ø®â€ŒØ¯Ù‡ÛŒ Ø±Ø§ ØªØ¶Ø¹ÛŒÙ Ú©Ù†Ø¯ Ùˆ Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø® Ø±Ø§ Ø§ÙØ²Ø§ÛŒØ´ Ø¯Ù‡Ø¯. Ø¨Ù‡ Ù‡Ù…ÛŒÙ† Ø¯Ù„ÛŒÙ„ ØªØ¹Ø±ÛŒÙ Ø³Ù‚Ù Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙØ¹Ø§Ù„ Ùˆ Ø¨Ù‡â€ŒÚ©Ø§Ø±Ú¯ÛŒØ±ÛŒ ØµÙ Ù‡ÙˆØ´Ù…Ù†Ø¯ ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ† ØªÙˆØ²ÛŒØ¹ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ù…Ø§Ù‡Ø§Ù†Ù‡ ÛŒØ§ ÙØµÙ„ÛŒØŒ Ø§Ø«Ø±Ø¨Ø®Ø´ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙˆØ§Ù†Ù…Ù†Ø¯Ø³Ø§Ø²ÛŒ Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ùˆ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´ÙˆØ§Ù‡Ø¯ Ø§ØµÙ„Ø§Ø­ Ø´ÙˆÙ†Ø¯. Ù¾ÛŒÙˆÙ†Ø¯ Ø¯Ø§Ø¯Ù† Ø§ÛŒÙ† ØªÙˆØ²ÛŒØ¹ Ø¨Ø§ Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ÛŒ Ú©ÛŒÙÛŒØª Ù†Ø¸ÛŒØ± Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ùˆ Ù†Ø±Ø® Ø±Ø¯ØŒ ØªØµÙˆÛŒØ± Ú©Ø§Ù…Ù„â€ŒØªØ±ÛŒ Ø§Ø² Ú©Ø§Ø±Ø§ÛŒÛŒ Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯. Ø¹Ù„Ø§ÙˆÙ‡ Ø¨Ø± Ø§ÛŒÙ†ØŒ Ø¨Ø§ÛŒØ¯ ØªØ§Ø«ÛŒØ± ÙØµÙˆÙ„ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø¨Ø± Ø§ÛŒÙ† ØªØ±Ú©ÛŒØ¨ Ø±Ø§ Ø¯Ø± Ù†Ø¸Ø± Ú¯Ø±ÙØª ØªØ§ Ø§Ø² Ù‚Ø¶Ø§ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ø¹Ø¬ÙˆÙ„Ø§Ù†Ù‡ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø´ÙˆØ¯. Ø¯Ø± Ù†Ù‡Ø§ÛŒØª Ù‡Ø¯Ù Ø±Ø§Ù‡Ø¨Ø±Ø¯ÛŒØŒ Ú©Ø§Ù‡Ø´ Ø³Ù‡Ù… ØºÛŒØ±ÙØ¹Ø§Ù„â€ŒÙ‡Ø§ Ùˆ Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø§Ø¯Ù„ Ø¨ÛŒÙ† Ú©Ù…â€ŒÚ©Ø§Ø± Ùˆ Ù…ØªÙˆØ³Ø· Ø§Ø³Øª ØªØ§ Ø¨Ø§ Ø­Ø¯Ø§Ù‚Ù„ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒ Ø¨Ù‡ Ø§ÙØ±Ø§Ø¯ Ø¨Ø³ÛŒØ§Ø± Ù¾Ø±Ú©Ø§Ø±ØŒ Ú©ÛŒÙÛŒØª Ø®Ø¯Ù…Ø§Øª Ù¾Ø§ÛŒØ¯Ø§Ø± Ø¨Ù…Ø§Ù†Ø¯.
            """
        )
        
        # Ø¢Ù…Ø§Ø± ØªÚ©Ù…ÛŒÙ„ÛŒ
        st.markdown("""
        <div class="insight-box">
        <h4>ğŸ” Ø¨ÛŒÙ†Ø´â€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ:</h4>
        <ul>
        <li><strong>{}</strong> Ø­Ø§Ù…ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ ({:.1f}%)</li>
        <li><strong>{}</strong> Ø­Ø§Ù…ÛŒ ÙØ¹Ø§Ù„ ({:.1f}%)</li>
        <li><strong>Ù†Ø§Ø¨Ø±Ø§Ø¨Ø±ÛŒ Ø¨Ø§Ø± Ú©Ø§Ø±ÛŒ:</strong> 10% Ø­Ø§Ù…ÛŒØ§Ù† 60% Ú©Ø§Ø± Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ù†Ø¯</li>
        </ul>
        </div>
        """.format(
            category_counts.get('ØºÛŒØ±ÙØ¹Ø§Ù„ (0)', 0),
            (category_counts.get('ØºÛŒØ±ÙØ¹Ø§Ù„ (0)', 0) / len(supporters_df) * 100),
            len(supporters_df) - category_counts.get('ØºÛŒØ±ÙØ¹Ø§Ù„ (0)', 0),
            ((len(supporters_df) - category_counts.get('ØºÛŒØ±ÙØ¹Ø§Ù„ (0)', 0)) / len(supporters_df) * 100)
        ), unsafe_allow_html=True)
    
    with col2:
        st.markdown("### ğŸ† Ø­Ø§Ù…ÛŒØ§Ù† Ø¨Ø±ØªØ± (ØªØ§Ù¾ 10)")
        
        # ensure required numeric columns exist to avoid KeyError
        for _col in ['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§', 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡', 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø±Ø¯_Ø´Ø¯Ù‡']:
            if _col not in supporters_df.columns:
                supporters_df[_col] = 0

        top_supporters = supporters_df[supporters_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'] > 0].nlargest(10, 'Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§')
        
        # Ù†Ù…ÙˆØ¯Ø§Ø± Ø³ØªÙˆÙ†ÛŒ Ø§ÙÙ‚ÛŒ
        fig_bar = px.bar(
            top_supporters,
            y='Ù†Ø§Ù…_Ù†Ù…Ø§ÛŒØ´ÛŒ',
            x='Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§',
            orientation='h',
            title="10 Ø­Ø§Ù…ÛŒ Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª",
            color='Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§',
            color_continuous_scale='viridis'
        )
        fig_bar.update_layout(yaxis={'categoryorder':'total ascending'})
        st.plotly_chart(fig_bar, use_container_width=True)
        _render_paragraph(
            "ØªØ­Ù„ÛŒÙ„ Ø¯Ù‡ Ø­Ø§Ù…ÛŒ Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª",
            """
Ù†Ù…ÙˆØ¯Ø§Ø± Ù…ÛŒÙ„Ù‡â€ŒØ§ÛŒ Ø§ÙÙ‚ÛŒØŒ ØªÙ…Ø±Ú©Ø² Ø¨Ø§Ø± Ú©Ø§Ø±ÛŒ Ø±ÙˆÛŒ Ø¯Ù‡ Ø­Ø§Ù…ÛŒ Ù¾Ø±ØªØ±Ø§ÙÛŒÚ© Ø±Ø§ Ø¨Ø±Ø¬Ø³ØªÙ‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ø¨Ù‡ Ù…Ø¯ÛŒØ±Ø§Ù† Ø§Ù…Ú©Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ø±ÛŒØ³Ú© Ø§ØªÚ©Ø§ÛŒ Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ø¨Ù‡ Ø§ÙØ±Ø§Ø¯ Ø®Ø§Øµ Ø±Ø§ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ú©Ù†Ù†Ø¯. ÙØ§ØµÙ„Ù‡ Ø²ÛŒØ§Ø¯ Ø¨ÛŒÙ† Ù†ÙØ±Ø§Øª Ø§ÙˆÙ„ Ùˆ Ø¯Ù‡Ù… Ù†Ø´Ø§Ù†Ú¯Ø± Ù†Ø§Ø¨Ø±Ø§Ø¨Ø±ÛŒ Ø¨Ø§Ø± Ú©Ø§Ø±ÛŒ Ø§Ø³Øª Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ Ø§ÙØª Ú©ÛŒÙÛŒØª ÛŒØ§ Ø§ÙØ²Ø§ÛŒØ´ Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø® Ø¯Ø± Ù‚Ù„Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙ‚Ø§Ø¶Ø§ Ù…Ù†Ø¬Ø± Ø´ÙˆØ¯. ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø³Ù‚Ù Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙØ¹Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù†ÙØ± ØªØ¹Ø±ÛŒÙ Ùˆ Ø¨Ø§ Ø³ÛŒØ§Ø³Øª Ø§Ø±Ø¬Ø§Ø¹ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§Ø² ØªØ¬Ù…Ø¹ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø´ÙˆØ¯. Ø¨Ø§ÛŒØ¯ Ù‡Ù…Ø²Ù…Ø§Ù† Ø¨Ø§ Ø§ÙØ²Ø§ÛŒØ´ Ø­Ø¬Ù…ØŒ Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ùˆ Ù†Ø±Ø® Ø±Ø¯ Ø§ÛŒÙ† Ø§ÙØ±Ø§Ø¯ Ù¾Ø§ÛŒØ´ Ø´ÙˆØ¯ ØªØ§ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø­Ø§ØµÙ„ Ú¯Ø±Ø¯Ø¯ ÙØ´Ø§Ø± Ú©Ø§Ø±ÛŒ Ø¨Ù‡ Ø§ÙØª Ú©ÛŒÙÛŒØª ØªØ¨Ø¯ÛŒÙ„ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. ØªØ­Ù„ÛŒÙ„ Ø±ÙˆÙ†Ø¯ÛŒ Ø§ÛŒÙ† Ù„ÛŒØ³Øª Ø¯Ø± Ø¨Ø§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù‡Ø§Ù†Ù‡ØŒ Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø§ÙØ±Ø§Ø¯ Ú©Ù„ÛŒØ¯ÛŒ Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ùˆ Ø²Ù…ÛŒÙ†Ù‡ Ø¬Ø§Ù†Ø´ÛŒÙ†â€ŒÙ¾Ø±ÙˆØ±ÛŒ Ùˆ Ù…Ù†ØªÙˆØ±Ø´ÛŒÙ¾ Ø±Ø§ ÙØ±Ø§Ù‡Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ø¯Ø± ØµÙˆØ±Øª Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±Ø´Ø¯ Ù¾ÛŒÙˆØ³ØªÙ‡ Ú†Ù†Ø¯ Ù†ÙØ±ØŒ Ø¨Ø§Ø²ØªÙˆØ²ÛŒØ¹ Ø¨Ø§Ø± Ø¨Ù‡ Ø­Ø§Ù…ÛŒØ§Ù† Ú©Ù…â€ŒÚ©Ø§Ø± Ùˆ Ù…ØªÙˆØ³Ø· Ù„Ø§Ø²Ù… Ø§Ø³Øª. ØªØ±Ú©ÛŒØ¨ Ø§ÛŒÙ† ØªØ­Ù„ÛŒÙ„ Ø¨Ø§ Ù†ÙˆØ¹ Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ù¾Ø±ØªÚ©Ø±Ø§Ø± Ùˆ Ø³Ø·Ø­ Ù¾ÛŒÚ†ÛŒØ¯Ú¯ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ØŒ Ø¯Ø±Ú© Ø¯Ù‚ÛŒÙ‚â€ŒØªØ±ÛŒ Ø§Ø² Ø¹Ù„Ù„ ØªÙ…Ø±Ú©Ø² ÙØ±Ø§Ù‡Ù… Ù…ÛŒâ€ŒØ¢ÙˆØ±Ø¯ Ùˆ Ù…Ø³ÛŒØ± Ø·Ø±Ø§Ø­ÛŒ Ù…Ø­ØªÙˆØ§Ù‡Ø§ÛŒ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ùˆ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø±Ø§ Ø±ÙˆØ´Ù† Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯. Ø¯Ø± Ù†Ù‡Ø§ÛŒØªØŒ Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ…Ø±Ú©Ø² Ø¨Ø§Ø±ØŒ Ø´Ø±Ø· Ù„Ø§Ø²Ù… Ø¨Ø±Ø§ÛŒ Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ú©ÛŒÙÛŒØª Ùˆ ØªØ§Ø¨â€ŒØ¢ÙˆØ±ÛŒ ÙØ±Ø§ÛŒÙ†Ø¯Ù‡Ø§ Ø§Ø³Øª.
            """
        )
        
        # Ø¬Ø¯ÙˆÙ„ Ø¹Ù…Ù„Ú©Ø±Ø¯
        st.markdown("### ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø­Ø§Ù…ÛŒØ§Ù† Ø¨Ø±ØªØ±")

        # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ (Ø¨Ø§ Ù…Ø­Ø§ÙØ¸Øª Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± ØªÙ‚Ø³ÛŒÙ… Ø¨Ø± ØµÙØ±)
        top_supporters = top_supporters.copy()
        safe_total = top_supporters['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'].replace({0: np.nan})
        top_supporters['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„'] = ((top_supporters.get('Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡', 0) / safe_total) * 100).round(1).fillna(0)
        top_supporters['Ù†Ø±Ø®_Ø±Ø¯'] = ((top_supporters.get('Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø±Ø¯_Ø´Ø¯Ù‡', 0) / safe_total) * 100).round(1).fillna(0)

        # Ù†Ù…Ø§ÛŒØ´ Ø¬Ø¯ÙˆÙ„
        display_df = top_supporters[['Ù†Ø§Ù…_Ù†Ù…Ø§ÛŒØ´ÛŒ', 'Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§', 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡', 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø±Ø¯_Ø´Ø¯Ù‡', 'Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„', 'Ù†Ø±Ø®_Ø±Ø¯']].copy()
        display_df.columns = ['Ù†Ø§Ù… Ø­Ø§Ù…ÛŒ', 'Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§', 'Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡', 'Ø±Ø¯ Ø´Ø¯Ù‡', 'Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ (%)', 'Ù†Ø±Ø® Ø±Ø¯ (%)']

        st.dataframe(
            display_df,
            use_container_width=True,
            hide_index=True
        )
        _render_paragraph(
            "ØªØ­Ù„ÛŒÙ„ Ø¬Ø¯ÙˆÙ„ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø­Ø§Ù…ÛŒØ§Ù† Ø¨Ø±ØªØ±",
            """
Ø§ÛŒÙ† Ø¬Ø¯ÙˆÙ„ Ø¨Ø§ Ø§Ø±Ø§Ø¦Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ØŒ Ù…ÙˆØ§Ø±Ø¯ Ø¨Ø³ØªÙ‡â€ŒØ´Ø¯Ù‡ Ùˆ Ø±Ø¯Ø´Ø¯Ù‡ØŒ Ø¯Ø± Ú©Ù†Ø§Ø± Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ùˆ Ù†Ø±Ø® Ø±Ø¯ØŒ ØªØµÙˆÛŒØ±ÛŒ Ø¬Ø§Ù…Ø¹ Ø§Ø² Ú©ÛŒÙÛŒØª Ù¾Ø§Ø³Ø®â€ŒØ¯Ù‡ÛŒ Ø­Ø§Ù…ÛŒØ§Ù† Ù¾Ø±ØªØ±Ø§ÙÛŒÚ© Ø§Ø±Ø§Ø¦Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ø¨Ø§Ù„Ø§ Ø¯Ø± Ú©Ù†Ø§Ø± Ø­Ø¬Ù… Ø¨Ø§Ù„Ø§ÛŒ Ú©Ø§Ø± Ù†Ø´Ø§Ù†Ù‡ ØªØ³Ù„Ø· ÙØ±Ø§ÛŒÙ†Ø¯ÛŒ Ùˆ Ø³Ø§Ø²Ù…Ø§Ù†â€ŒØ¯Ù‡ÛŒ Ø§Ø«Ø±Ø¨Ø®Ø´ Ø§Ø³ØªØŒ Ø¯Ø± Ø­Ø§Ù„ÛŒâ€ŒÚ©Ù‡ Ù†Ø±Ø® Ø±Ø¯ Ø¨Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ Ù…Ø´Ú©Ù„Ø§Øª Ú©ÛŒÙÛŒØª ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ØŒ Ø§Ø¨Ù‡Ø§Ù… Ø¯Ø± Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§ ÛŒØ§ Ú©Ù…Ø¨ÙˆØ¯ Ù…Ù†Ø§Ø¨Ø¹ Ø§Ø´Ø§Ø±Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯. Ø¯Ø± Ú†Ù†ÛŒÙ† Ù…ÙˆØ§Ø±Ø¯ÛŒØŒ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Ø³Ø§Ø®ØªØ§Ø±ÛŒØ§ÙØªÙ‡ Ùˆ Ø¨Ø§Ø²Ø·Ø±Ø§Ø­ÛŒ ÙØ±Ù…â€ŒÙ‡Ø§ Ùˆ Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ø³ÛŒØ§Ø± Ø­ÛŒØ§ØªÛŒ Ø§Ø³Øª. Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ Ø§ÛŒÙ† Ø¬Ø¯ÙˆÙ„ØŒ Ø±ÙˆÙ†Ø¯ Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ Ø§ÙØª Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø±Ø§ Ø¢Ø´Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ù…Ø¯Ø§Ø®Ù„Ø§Øª Ø¢Ù…ÙˆØ²Ø´ÛŒ ÛŒØ§ ÙØ±Ø§ÛŒÙ†Ø¯ÛŒ Ø¨Ù‡â€ŒÙ…ÙˆÙ‚Ø¹ Ø§Ø¬Ø±Ø§ Ø´ÙˆÙ†Ø¯. Ø§Ú¯Ø± Ù‡Ù…Ø¨Ø³ØªÚ¯ÛŒ Ù…Ø¹Ù†Ø§Ø¯Ø§Ø±ÛŒ Ø¨ÛŒÙ† Ø­Ø¬Ù… Ú©Ø§Ø± Ø¨Ø§Ø² Ùˆ Ø§ÙØª Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø´ÙˆØ¯ØŒ ØªØ¹Ø±ÛŒÙ Ø³Ù‚Ù Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙØ¹Ø§Ù„ Ùˆ ØªÙ‚ÙˆÛŒØª Ø¸Ø±ÙÛŒØª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø§Ø³Øª. Ù…Ø³ØªÙ†Ø¯Ø³Ø§Ø²ÛŒ Ø¨Ù‡ØªØ±ÛŒÙ† ØªØ¬Ø±Ø¨ÛŒØ§Øª Ø§ÙØ±Ø§Ø¯ Ø¨Ø±ØªØ± Ùˆ Ø¨Ù‡â€ŒØ§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø¢Ù†â€ŒÙ‡Ø§ Ø¯Ø± Ù‚Ø§Ù„Ø¨ Ø±Ø§Ù‡Ù†Ù…Ø§ Ùˆ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ Ø§Ø±ØªÙ‚Ø§ÛŒ Ø¬Ù…Ø¹ÛŒ Ú©ÛŒÙÛŒØª Ù…Ù†Ø¬Ø± Ø´ÙˆØ¯. ØªÙ„ÙÛŒÙ‚ Ø§ÛŒÙ† Ø¬Ø¯ÙˆÙ„ Ø¨Ø§ Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ÛŒ SLA Ùˆ Ø±Ø¶Ø§ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†ØŒ Ú†Ø§Ø±Ú†ÙˆØ¨ÛŒ Ú©Ø§Ù…Ù„ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø¹Ù…Ù„Ú©Ø±Ø¯ ÙØ±Ø§Ù‡Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯ ØªØ§ ØªØµÙ…ÛŒÙ…â€ŒÙ‡Ø§ Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± Ø¯Ø§Ø¯Ù‡ Ùˆ Ø§Ø«Ø±Ú¯Ø°Ø§Ø± Ø¨Ø§Ø´Ù†Ø¯.
            """
        )
    
    # Ù†Ù…ÙˆØ¯Ø§Ø± ØªØ­Ù„ÛŒÙ„ Ø¹Ù…Ù„Ú©Ø±Ø¯
    st.markdown("### ğŸ“ˆ ØªØ­Ù„ÛŒÙ„ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ùˆ Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„")
    
    col3, col4 = st.columns(2)
    
    with col3:
        # Ù†Ù…ÙˆØ¯Ø§Ø± Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„
        top_supporters['Ø±Ù†Ú¯'] = top_supporters['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„'].apply(
            lambda x: 'Ø¹Ø§Ù„ÛŒ (â‰¥95%)' if x >= 95 else 'Ø®ÙˆØ¨ (90-95%)' if x >= 90 else 'Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ø¨Ù‡Ø¨ÙˆØ¯ (<90%)'
        )
        
        fig_completion = px.bar(
            top_supporters,
            x=range(len(top_supporters)),
            y='Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„',
            color='Ø±Ù†Ú¯',
            title="Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ø­Ø§Ù…ÛŒØ§Ù† Ø¨Ø±ØªØ±",
            labels={'x': 'Ø±ØªØ¨Ù‡ Ø­Ø§Ù…ÛŒ', 'y': 'Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ (%)'},
            color_discrete_map={
                'Ø¹Ø§Ù„ÛŒ (â‰¥95%)': '#27AE60',
                'Ø®ÙˆØ¨ (90-95%)': '#F39C12', 
                'Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ø¨Ù‡Ø¨ÙˆØ¯ (<90%)': '#E74C3C'
            }
        )
        fig_completion.add_hline(y=95, line_dash="dash", line_color="green", annotation_text="Ù‡Ø¯Ù: 95%")
        fig_completion.add_hline(y=90, line_dash="dash", line_color="orange", annotation_text="Ø­Ø¯Ø§Ù‚Ù„: 90%")
        st.plotly_chart(fig_completion, use_container_width=True)
        _render_paragraph(
            "ØªØ­Ù„ÛŒÙ„ Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ø­Ø§Ù…ÛŒØ§Ù† Ø¨Ø±ØªØ±",
            """
Ù†Ù…ÙˆØ¯Ø§Ø± Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ø¨Ø§ Ø±Ù†Ú¯â€ŒØ¨Ù†Ø¯ÛŒ Ø³Ù‡â€ŒÚ¯Ø§Ù†Ù‡ Ùˆ Ø®Ø·ÙˆØ· Ù…Ø±Ø²ÛŒ 90 Ùˆ 95 Ø¯Ø±ØµØ¯ØŒ ÙˆØ¶Ø¹ÛŒØª Ú©ÛŒÙÛŒ Ù‡Ø± ÙØ±Ø¯ Ø±Ø§ Ø¯Ø± ÛŒÚ© Ù†Ú¯Ø§Ù‡ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯. ØªÙ…Ø±Ú©Ø² Ù…ÛŒÙ„Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ù†Ø§Ø­ÛŒÙ‡ Ø¨Ø§Ù„Ø§ÛŒ 95 Ø¯Ø±ØµØ¯ Ù†Ø´Ø§Ù†Ú¯Ø± Ø¨Ù„ÙˆØº ÙØ±Ø§ÛŒÙ†Ø¯ Ùˆ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ø³Ø§Ø²ÛŒ Ù…ÙˆÙÙ‚ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ Ø§Ø³ØªØŒ Ø¯Ø± Ø­Ø§Ù„ÛŒâ€ŒÚ©Ù‡ Ø§Ù†Ø¨Ø§Ø´Øª Ø²ÛŒØ± 90 Ø¯Ø±ØµØ¯ Ù†Ø´Ø§Ù†Ù‡ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…Ø¯Ø§Ø®Ù„Ù‡ ÙÙˆØ±ÛŒ Ù…Ø­Ø³ÙˆØ¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯. ØªØ­Ù„ÛŒÙ„ Ø­Ø³Ø§Ø³ÛŒØª Ø¨Ø± Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ùˆ Ø³Ø·Ø­ Ù¾ÛŒÚ†ÛŒØ¯Ú¯ÛŒ Ø¢Ù†â€ŒÙ‡Ø§ØŒ Ø¨Ø±Ø¯Ø§Ø´Øª Ø¯Ù‚ÛŒÙ‚â€ŒØªØ±ÛŒ ÙØ±Ø§Ù‡Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ø§Ø² Ù…Ù‚Ø§ÛŒØ³Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ø§Ø¹Ø§Ø¯Ù„Ø§Ù†Ù‡ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ø¯Ø± ØµÙˆØ±Øª Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†ÙˆØ³Ø§Ù† Ø²ÛŒØ§Ø¯ Ø¨Ø±Ø§ÛŒ ÛŒÚ© ÙØ±Ø¯ØŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ú©Ø§Ø±ÛŒØŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‡Ù…â€ŒØ²Ù…Ø§Ù† Ùˆ Ù†ÛŒØ§Ø²Ù‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø§ÛŒÙ† Ù†Ù…ÙˆØ¯Ø§Ø± Ø¨Ø§ÛŒØ¯ Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø¨Ø§Ø²Ø¨ÛŒÙ†ÛŒ Ùˆ Ù¾Ø³ Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ø± ØªØºÛŒÛŒØ± Ø³ÛŒØ§Ø³ØªÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø´ÙˆØ¯ ØªØ§ ØªØ§Ø«ÛŒØ± interventions Ø¨Ù‡ Ø´Ú©Ù„ Ø¹ÛŒÙ†ÛŒ Ø³Ù†Ø¬ÛŒØ¯Ù‡ Ø´ÙˆØ¯. ØªØ¹Ø±ÛŒÙ Ù†Ù‚Ø´ Ù…Ù†ØªÙˆØ± Ø¨Ø±Ø§ÛŒ Ø§ÙØ±Ø§Ø¯ Ø¨Ø§ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¹Ø§Ù„ÛŒ Ùˆ Ø§Ù†ØªØ´Ø§Ø± Ø§Ù„Ú¯ÙˆÛŒ Ø¨Ù‡ØªØ±ÛŒÙ† Ø¹Ù…Ù„Ú©Ø±Ø¯ØŒ Ù…Ø³ÛŒØ± Ø§Ø±ØªÙ‚Ø§ÛŒ Ø¬Ù…Ø¹ÛŒ Ø±Ø§ Ù‡Ù…ÙˆØ§Ø± Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯. Ø¯Ø± Ù†Ù‡Ø§ÛŒØªØŒ Ø§ÛŒÙ† Ù†Ù…ÙˆØ¯Ø§Ø± Ø¨Ù‡â€ŒÙ…Ø«Ø§Ø¨Ù‡ Ù‚Ø·Ø¨â€ŒÙ†Ù…Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ Ú©ÛŒÙÛŒØª Ø¹Ù…Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ø¨Ù‡ Ù…Ø¯ÛŒØ±Ø§Ù† Ø¯Ø± Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø§ØµÙ„Ø§Ø­ÛŒ Ú©Ù…Ú© Ù…ÛŒâ€ŒÙ†Ù…Ø§ÛŒØ¯.
            """
        )
    
    with col4:
        # Ù†Ù…ÙˆØ¯Ø§Ø± Ù¾Ø±Ø§Ú©Ù†Ø¯Ú¯ÛŒ
        active_supporters = supporters_df[supporters_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'] > 0].copy()
        active_supporters['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„'] = (active_supporters['Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡'] / active_supporters['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'] * 100)
        
        fig_scatter = px.scatter(
            active_supporters,
            x='Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§',
            y='Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„',
            size='Ø®ÙˆØ´Ù‡_Ù‡Ø§',
            color='Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„',
            title="Ù¾Ø±Ø§Ú©Ù†Ø¯Ú¯ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø­Ø§Ù…ÛŒØ§Ù†",
            labels={'x': 'ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§', 'y': 'Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ (%)'},
            color_continuous_scale='RdYlGn'
        )
        fig_scatter.add_hline(y=90, line_dash="dash", line_color="orange")
        fig_scatter.add_hline(y=95, line_dash="dash", line_color="green")
        st.plotly_chart(fig_scatter, use_container_width=True)
        _render_paragraph(
            "ØªØ­Ù„ÛŒÙ„ Ù¾Ø±Ø§Ú©Ù†Ø¯Ú¯ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø­Ø§Ù…ÛŒØ§Ù†",
            """
Ù†Ù…ÙˆØ¯Ø§Ø± Ù¾Ø±Ø§Ú©Ù†Ø¯Ú¯ÛŒ Ø¨Ø§ Ù†Ù…Ø§ÛŒØ´ Ù‡Ù…Ø²Ù…Ø§Ù† Ø­Ø¬Ù… Ú©Ø§Ø± Ùˆ Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ØŒ Ø§Ù„Ú¯ÙˆÛŒ ØªØ¹Ø§Ø¯Ù„ Ù…ÛŒØ§Ù† Ú©Ù…ÛŒØª Ùˆ Ú©ÛŒÙÛŒØª Ø±Ø§ Ø¢Ø´Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ù†Ù‚Ø§Ø· Ø¨Ø§ Ø­Ø¬Ù… Ø¨Ø§Ù„Ø§ Ùˆ Ù†Ø±Ø® Ù¾Ø§ÛŒÛŒÙ†ØŒ Ú©Ø§Ù†Ø¯ÛŒØ¯ Ù…Ø¯Ø§Ø®Ù„Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¯Ø§Ø± Ù‡Ø³ØªÙ†Ø¯Ø› Ø¯Ø± Ù…Ù‚Ø§Ø¨Ù„ØŒ Ù†Ù‚Ø§Ø· Ø¨Ø§ Ø­Ø¬Ù… Ù¾Ø§ÛŒÛŒÙ† Ùˆ Ù†Ø±Ø® Ø¨Ø§Ù„Ø§ØŒ Ø¸Ø±ÙÛŒØª Ù†Ù‡ÙØªÙ‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø°ÛŒØ±Ø´ ÙˆØ¸Ø§ÛŒÙ Ø¨ÛŒØ´ØªØ± Ø¯Ø§Ø±Ù†Ø¯. Ø®Ø·ÙˆØ· Ù…Ø±Ø²ÛŒ 90 Ùˆ 95 Ø¯Ø±ØµØ¯ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„ÛŒ Ø±Ø§ Ù…Ø´Ø®Øµ Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯ Ùˆ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯ Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¨Ù‡ÛŒÙ†Ù‡ ØªØ¹Ø±ÛŒÙ Ø´ÙˆØ¯. Ù¾Ù‡Ù†Ø§ÛŒ Ù¾Ø±Ø§Ú©Ù†Ø¯Ú¯ÛŒ Ø¹Ù…ÙˆØ¯ÛŒ Ø§Ù†Ø¹Ú©Ø§Ø³â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ù†Ø§Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ú©ÛŒÙÛŒØª Ø§Ø³Øª Ùˆ Ø¨Ø§ÛŒØ¯ Ø±ÛŒØ´Ù‡â€ŒÛŒØ§Ø¨ÛŒ Ø´ÙˆØ¯. Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ø¹Ø¯ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ ÛŒØ§ Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ø¨Ù‡ Ø§ÛŒÙ† Ù†Ù…ÙˆØ¯Ø§Ø±ØŒ ØªÙØ§ÙˆØªâ€ŒÙ‡Ø§ÛŒ ØªØ®ØµØµÛŒ Ùˆ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…Ø­ØªÙˆØ§Ù‡Ø§ÛŒ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø®ØªØµØ§ØµÛŒ Ø±Ø§ Ø±ÙˆØ´Ù† Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯. Ø±ØµØ¯ Ø¬Ø§Ø¨Ù‡â€ŒØ¬Ø§ÛŒÛŒ Ù†Ù‚Ø§Ø· Ø¯Ø± Ø·ÙˆÙ„ Ø²Ù…Ø§Ù† ØªØ§Ø«ÛŒØ± Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ØµÙØŒ Ø¢Ù…ÙˆØ²Ø´ Ùˆ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ùˆ Ø¨Ù‡ ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± Ø¯Ø§Ø¯Ù‡ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
            """
        )

def create_units_analysis(units_df):
    """ØªØ­Ù„ÛŒÙ„ Ø¬Ø§Ù…Ø¹ ÙˆØ§Ø­Ø¯Ù‡Ø§"""
    st.markdown("## ğŸ›ï¸ ØªØ­Ù„ÛŒÙ„ Ø¬Ø§Ù…Ø¹ ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ÛŒ")
    
    # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ Ø§ÛŒÙ…Ù†â€ŒØ³Ø§Ø²ÛŒ Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§
    if 'Ù†Ø§Ù…_ÙˆØ§Ø­Ø¯' not in units_df.columns:
        # Ø¯Ø± ØµÙˆØ±Øª Ù†Ø¨ÙˆØ¯ Ù†Ø§Ù… ÙˆØ§Ø­Ø¯ØŒ Ø§Ø² Ø§ÙˆÙ„ÛŒÙ† Ø³ØªÙˆÙ† Ù…ØªÙ†ÛŒ ÛŒØ§ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        text_cols = [c for c in units_df.columns if units_df[c].dtype == 'object']
        units_df['Ù†Ø§Ù…_ÙˆØ§Ø­Ø¯'] = units_df[text_cols[0]] if text_cols else units_df.index.astype(str)
    units_df['Ù†Ø§Ù…_Ú©ÙˆØªØ§Ù‡'] = units_df['Ù†Ø§Ù…_ÙˆØ§Ø­Ø¯'].astype(str).str.split('-').str[0]
    units_df['Ù†Ø³Ø¨Øª_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¯Ø§Ù†Ø´Ø¬Ùˆ'] = (units_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'] / units_df['ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†']).replace([np.inf, -np.inf], np.nan).fillna(0).round(2)
    units_df['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„'] = (units_df['Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡'] / units_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'].replace({0: np.nan}) * 100).round(1).fillna(0)
    units_df['Ù†Ø±Ø®_Ø±Ø¯'] = (units_df['Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø±Ø¯_Ø´Ø¯Ù‡'] / units_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'].replace({0: np.nan}) * 100).round(1).fillna(0)
    
    # Ù…Ù‚Ø§ÛŒØ³Ù‡ Ú©Ù„ÛŒ ÙˆØ§Ø­Ø¯Ù‡Ø§
    st.markdown("### ğŸ“Š Ù…Ù‚Ø§ÛŒØ³Ù‡ Ú©Ù„ÛŒ ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ø§Ø³ØªØ§Ù† Ù…Ø±Ú©Ø²ÛŒ")
    # Ù†Ù…Ø§ÛŒØ´ ÙÙ‚Ø· Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ÛŒ Ø³ØªÙˆÙ†ÛŒ Ù¾Ø§ÛŒØ¯Ø§Ø±
    chart_type = 'Ù…ÛŒÙ„Ù‡â€ŒØ§ÛŒ'

    if chart_type == 'Ù…ÛŒÙ„Ù‡â€ŒØ§ÛŒ':
        # Ù‚Ø±Ø§Ø±â€ŒØ¯Ø§Ø¯Ù† Ø³Ù‡ Ù†Ù…ÙˆØ¯Ø§Ø± Ù…ÛŒÙ„Ù‡â€ŒØ§ÛŒ Ø¨Ø²Ø±Ú¯ Ùˆ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ù…ÙˆØ¯ÛŒ Ùˆ Ù¾Ù‡Ù†Ø§ÛŒ Ú©Ø§Ù…Ù„
        # 1) Ù†Ø³Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ø¯Ø§Ù†Ø´Ø¬Ùˆ
        ratio_df = units_df.sort_values('Ù†Ø³Ø¨Øª_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¯Ø§Ù†Ø´Ø¬Ùˆ', ascending=False).copy()
        fig_ratio_long = px.bar(
            ratio_df,
            x='Ù†Ø§Ù…_Ú©ÙˆØªØ§Ù‡',
            y='Ù†Ø³Ø¨Øª_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¯Ø§Ù†Ø´Ø¬Ùˆ',
            title='Ù†Ø³Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ø¯Ø§Ù†Ø´Ø¬Ùˆ (ÙˆØ§Ø­Ø¯Ù‡Ø§)',
            labels={'Ù†Ø§Ù…_Ú©ÙˆØªØ§Ù‡':'ÙˆØ§Ø­Ø¯','Ù†Ø³Ø¨Øª_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¯Ø§Ù†Ø´Ø¬Ùˆ':'Ù†Ø³Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª/Ø¯Ø§Ù†Ø´Ø¬Ùˆ'},
            color='Ù†Ø³Ø¨Øª_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¯Ø§Ù†Ø´Ø¬Ùˆ',
            color_continuous_scale='plasma'
        )
        fig_ratio_long.update_layout(height=420, xaxis_tickangle=45)
        st.plotly_chart(fig_ratio_long, use_container_width=True)
        _render_paragraph(
            "ØªØ­Ù„ÛŒÙ„ Ù†Ø³Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ø¯Ø§Ù†Ø´Ø¬Ùˆ (ÙˆØ§Ø­Ø¯Ù‡Ø§)",
            """
Ø´Ø§Ø®Øµ Ù†Ø³Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ø¯Ø§Ù†Ø´Ø¬Ùˆ Ø´Ø¯Øª ØªÙ‚Ø§Ø¶Ø§ Ù†Ø³Ø¨Øª Ø¨Ù‡ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ù‡Ø± ÙˆØ§Ø­Ø¯ Ø±Ø§ Ù…ÛŒâ€ŒØ³Ù†Ø¬Ø¯ Ùˆ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø¸Ø±ÙÛŒØª Ùˆ ØªØ®ØµÛŒØµ Ù…Ù†Ø§Ø¨Ø¹ Ø§Ù‡Ù…ÛŒØª Ø¨Ù†ÛŒØ§Ø¯ÛŒÙ† Ø¯Ø§Ø±Ø¯. Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¨Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù†Ø§Ø´ÛŒ Ø§Ø² ÙØ±Ø§ÛŒÙ†Ø¯Ù‡Ø§ÛŒ Ù†Ø§Ú©Ø§Ø±Ø§ØŒ Ú©Ù…Ø¨ÙˆØ¯ Ù…Ø­ØªÙˆØ§Ù‡Ø§ÛŒ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³Ù„Ùâ€ŒØ³Ø±ÙˆÛŒØ³ ÛŒØ§ Ù†ÛŒØ§Ø²Ù‡Ø§ÛŒ Ø®Ø§Øµ Ø¬Ù…Ø¹ÛŒØª Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒ Ø¨Ø§Ø´Ø¯. Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø§ÛŒÙ† Ø´Ø§Ø®Øµ Ø¨Ø§ Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ø¨Ù‡ ØªØ´Ø®ÛŒØµ ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒÛŒ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ø¹Ù„ÛŒâ€ŒØ±ØºÙ… ÙØ´Ø§Ø± ØªÙ‚Ø§Ø¶Ø§ØŒ Ú©ÛŒÙÛŒØª Ø±Ø§ Ø­ÙØ¸ Ú©Ø±Ø¯Ù‡â€ŒØ§Ù†Ø¯ Ùˆ Ø§Ù„Ú¯ÙˆÛŒ Ù…Ù†Ø§Ø³Ø¨ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ Ø³Ø§ÛŒØ± ÙˆØ§Ø­Ø¯Ù‡Ø§ Ù‡Ø³ØªÙ†Ø¯. Ø¨Ø±Ø¹Ú©Ø³ØŒ Ù†Ø³Ø¨Øª Ø¨Ø§Ù„Ø§ Ù‡Ù…Ø±Ø§Ù‡ Ø¨Ø§ Ú©ÛŒÙÛŒØª Ù¾Ø§ÛŒÛŒÙ† Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ù…Ø¯Ø§Ø®Ù„Ù‡ ÙÙˆØ±ÛŒØŒ Ø¨Ø§Ø²Ø·Ø±Ø§Ø­ÛŒ Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ø§Ø±Ø¬Ø§Ø¹ Ùˆ ØªÙ‚ÙˆÛŒØª Ø¢Ù…ÙˆØ²Ø´â€ŒÙ‡Ø§ Ø§Ø³Øª. Ø±ØµØ¯ ÙØµÙ„ÛŒ Ø§ÛŒÙ† Ù†Ø³Ø¨Øª Ø§Ø² ØªØµÙ…ÛŒÙ…â€ŒÙ‡Ø§ÛŒ ÙˆØ§Ú©Ù†Ø´ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ø§Ø¬Ø±Ø§ÛŒ Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒØ¯Ø³ØªØ§Ù†Ù‡ Ø±Ø§ Ù…Ù…Ú©Ù† Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯.
            """
        )

        # 2) Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§
        req_df = units_df.sort_values('Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§', ascending=False).copy()
        fig_reqs = px.bar(
            req_df,
            x='Ù†Ø§Ù…_Ú©ÙˆØªØ§Ù‡',
            y='Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§',
            title='Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¨Ù‡ ØªÙÚ©ÛŒÚ© ÙˆØ§Ø­Ø¯',
            labels={'Ù†Ø§Ù…_Ú©ÙˆØªØ§Ù‡':'ÙˆØ§Ø­Ø¯','Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§':'ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§'},
            color='Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§',
            color_continuous_scale='reds'
        )
        fig_reqs.update_layout(height=420, xaxis_tickangle=45)
        st.plotly_chart(fig_reqs, use_container_width=True)
        _render_paragraph(
            "ØªØ­Ù„ÛŒÙ„ Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¨Ù‡ ØªÙÚ©ÛŒÚ© ÙˆØ§Ø­Ø¯",
            """
Ø§ÛŒÙ† Ù†Ù…ÙˆØ¯Ø§Ø± Ø­Ø¬Ù… Ù…Ø·Ù„Ù‚ ØªÙ‚Ø§Ø¶Ø§ Ø¯Ø± ÙˆØ§Ø­Ø¯Ù‡Ø§ Ø±Ø§ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ù…Ù‚ØµØ¯Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ù…Ù†Ø§Ø¨Ø¹ Ø±Ø§ Ù…Ø´Ø®Øµ Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯. Ø¨Ø§ÛŒØ¯ Ù‡Ù…Ø²Ù…Ø§Ù† Ú©ÛŒÙÛŒØª Ù¾Ø§Ø³Ø® Ùˆ Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø® Ø¯Ø± ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ù¾Ø±ØªØ±Ø§ÙÛŒÚ© Ù¾Ø§ÛŒØ´ Ø´ÙˆØ¯ ØªØ§ Ø§Ø² Ø§ÙØª ØªØ¬Ø±Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ú¯Ø±Ø¯Ø¯. Ø§Ø®ØªÙ„Ø§ÙØ§Øª Ø´Ø¯ÛŒØ¯ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†Ø§Ø´ÛŒ Ø§Ø² ØªÙØ§ÙˆØª Ø¯Ø± ÙØ±Ù‡Ù†Ú¯ Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡ÛŒØŒ ØªØ±Ú©ÛŒØ¨ Ø±Ø´ØªÙ‡â€ŒÙ‡Ø§ ÛŒØ§ Ú†Ø±Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø¨Ø§Ø´Ø¯ Ú©Ù‡ Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ ØªØ­Ù„ÛŒÙ„ Ø±ÛŒØ´Ù‡â€ŒØ§ÛŒ Ø§Ø³Øª. ØªØ¨Ø¯ÛŒÙ„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø±ØªÚ©Ø±Ø§Ø± Ø¨Ù‡ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ù†Ø´ Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú†Øªâ€ŒØ¨Ø§Øªâ€ŒÙ‡Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø§Ø± Ø§Ø¬Ø±Ø§ÛŒÛŒ Ø±Ø§ Ú©Ø§Ù‡Ø´ Ø¯Ù‡Ø¯. Ù¾Ø§ÛŒØ´ Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø§ÛŒÙ† Ø´Ø§Ø®Øµ Ø§Ø² ØªØ¬Ù…Ø¹ backlog Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ø¨Ù‡ ØªÙˆØ§Ø²Ù† Ø¨Ø§Ø± Ù…ÛŒØ§Ù† ÙˆØ§Ø­Ø¯Ù‡Ø§ Ú©Ù…Ú© Ù…ÛŒâ€ŒÙ†Ù…Ø§ÛŒØ¯.
            """
        )

        # 3) ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†
        stu_df = units_df.sort_values('ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†', ascending=False).copy()
        fig_students = px.bar(
            stu_df,
            x='Ù†Ø§Ù…_Ú©ÙˆØªØ§Ù‡',
            y='ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†',
            title='ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ø¯Ø± ÙˆØ§Ø­Ø¯Ù‡Ø§',
            labels={'Ù†Ø§Ù…_Ú©ÙˆØªØ§Ù‡':'ÙˆØ§Ø­Ø¯','ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†':'ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†'},
            color='ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†',
            color_continuous_scale='blues'
        )
        fig_students.update_layout(height=420, xaxis_tickangle=45)
        st.plotly_chart(fig_students, use_container_width=True)
        _render_paragraph(
            "ØªØ­Ù„ÛŒÙ„ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ø¯Ø± ÙˆØ§Ø­Ø¯Ù‡Ø§",
            """
Ø§ÛŒÙ† Ù†Ù…ÙˆØ¯Ø§Ø± Ø§Ù†Ø¯Ø§Ø²Ù‡ Ù†Ø³Ø¨ÛŒ ÙˆØ§Ø­Ø¯Ù‡Ø§ Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ùˆ Ù¾Ø§ÛŒÙ‡ ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¸Ø±ÙÛŒØª Ø§Ø³Øª. ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯ Ø¨Ù‡â€ŒØ·ÙˆØ± Ø·Ø¨ÛŒØ¹ÛŒ Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¨ÛŒØ´ØªØ± Ùˆ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø§ÛŒÙ„ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ø®Ø¯Ù…Øª Ù‡Ø³ØªÙ†Ø¯ØŒ Ø¯Ø± Ø­Ø§Ù„ÛŒ Ú©Ù‡ ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ú©ÙˆÚ†Ú© Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø·ÛŒ Ùˆ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ù‡Ø¯ÙÙ…Ù†Ø¯Ù†Ø¯ ØªØ§ Ø§Ø² Ø¸Ø±ÙÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ù‡Ø±Ù‡ Ø¨Ø¨Ø±Ù†Ø¯. Ù‡Ù…Ø¨Ø³ØªÚ¯ÛŒ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¨Ø§ ØªÙ‚Ø§Ø¶Ø§ Ùˆ Ú©ÛŒÙÛŒØª Ù¾Ø§Ø³Ø® Ø¨Ø§ÛŒØ¯ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ù…Ø³ØªÙ…Ø± Ø³Ù†Ø¬ÛŒØ¯Ù‡ Ø´ÙˆØ¯ ØªØ§ ØªØ®ØµÛŒØµ Ù…Ù†Ø§Ø¨Ø¹ Ù…Ù†ØµÙØ§Ù†Ù‡ Ùˆ Ù…ÙˆØ«Ø± Ø¨Ø§Ø´Ø¯. Ø¯Ø± ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒÛŒ Ø¨Ø§ Ø±Ø´Ø¯ Ø³Ø±ÛŒØ¹ØŒ ØªÙ‚ÙˆÛŒØª Ø²ÙˆØ¯Ù‡Ù†Ú¯Ø§Ù… Ø²ÛŒØ±Ø³Ø§Ø®Øªâ€ŒÙ‡Ø§ Ùˆ Ù…Ù†Ø§Ø¨Ø¹ Ø§Ù†Ø³Ø§Ù†ÛŒ Ø§Ø² Ø¨Ø±ÙˆØ² Ú¯Ù„ÙˆÚ¯Ø§Ù‡ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
            """
        )

    elif False:
        # Ø¯Ø§ÛŒØ±Ù‡â€ŒØ§ÛŒ: Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù…ØªØºÛŒØ±ØŒ Ù†Ù…ÙˆØ¯Ø§Ø± Ù¾Ø§ÛŒ Ø§Ø² ØªÙˆØ²ÛŒØ¹ ÙˆØ§Ø­Ø¯Ù‡Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ… (top-N + Ø³Ø§ÛŒØ±)
        TOP_N = 8
        # Ù†Ø³Ø¨Øª: Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ÙˆØ§Ø­Ø¯Ù‡Ø§ Ø¨Ù‡ Ø³Ù‡ Ú¯Ø±ÙˆÙ‡ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø³Ù‡Ù… Ù‡Ø± Ú¯Ø±ÙˆÙ‡
        bins = [0, 0.2, 0.5, units_df['Ù†Ø³Ø¨Øª_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¯Ø§Ù†Ø´Ø¬Ùˆ'].max() + 1]
        labels = ['Ú©Ù… (â‰¤0.2)','Ù…ØªÙˆØ³Ø· (0.21-0.5)','Ø¨ÛŒØ´ØªØ± (>0.5)']
        tmp = units_df.copy()
        tmp['ratio_bin'] = pd.cut(tmp['Ù†Ø³Ø¨Øª_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¯Ø§Ù†Ø´Ø¬Ùˆ'].fillna(0), bins=bins, labels=labels, include_lowest=True)
        pie1 = tmp['ratio_bin'].value_counts()
        fig_p1 = px.pie(values=pie1.values, names=pie1.index, title='ØªÙˆØ²ÛŒØ¹ Ù†Ø³Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª/Ø¯Ø§Ù†Ø´Ø¬Ùˆ')
        fig_p1.update_traces(textposition='inside', textinfo='percent+label')
        fig_p1.update_layout(height=420)
        st.plotly_chart(fig_p1, use_container_width=True)
        _render_paragraph(
            "ØªØ­Ù„ÛŒÙ„ ØªÙˆØ²ÛŒØ¹ Ù†Ø³Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª/Ø¯Ø§Ù†Ø´Ø¬Ùˆ",
            """
Ø³Ù‡Ù… Ù‡Ø± Ú¯Ø±ÙˆÙ‡ Ø§Ø² Ù†Ø³Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ø¯Ø§Ù†Ø´Ø¬Ùˆ ØªØµÙˆÛŒØ±ÛŒ Ù…ÙˆØ¬Ø² Ø§Ø² Ø´Ø¯Øª ØªÙ‚Ø§Ø¶Ø§ Ùˆ Ù¾Ø±Ø§Ú©Ù†Ø¯Ú¯ÛŒ ÙØ´Ø§Ø± Ú©Ø§Ø±ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯. Ø§ÙØ²Ø§ÛŒØ´ Ø³Ù‡Ù… Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù„Ø§ØªØ± Ù‡Ø´Ø¯Ø§Ø±Ø¯Ù‡Ù†Ø¯Ù‡ Ø§Ø³Øª Ùˆ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ø§Ù‚Ø¯Ø§Ù…Ø§ØªÛŒ Ù…Ø§Ù†Ù†Ø¯ Ø¨Ø§Ø²Ø·Ø±Ø§Ø­ÛŒ ÙØ±Ù…â€ŒÙ‡Ø§ØŒ Ú¯Ø³ØªØ±Ø´ Ø³Ù„Ùâ€ŒØ³Ø±ÙˆÛŒØ³ Ùˆ Ø¢Ù…ÙˆØ²Ø´â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¶ÙˆØ¹ÛŒ Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯. ØªÙ†Ø¸ÛŒÙ… Ø¢Ø³ØªØ§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù…ØªÙ†Ø§Ø³Ø¨ Ø¨Ø§ Ø²Ù…ÛŒÙ†Ù‡ Ùˆ ÙØµÙˆÙ„ Ø¢Ù…ÙˆØ²Ø´ÛŒØŒ Ø¯Ù‚Øª ØªÙØ³ÛŒØ± Ø±Ø§ Ø§ÙØ²Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯. Ù¾ÛŒÙˆÙ†Ø¯ Ø¯Ø§Ø¯Ù† Ø§ÛŒÙ† ØªÙˆØ²ÛŒØ¹ Ø¨Ø§ Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ÛŒ Ú©ÛŒÙÛŒØª Ùˆ Ø±Ø¶Ø§ÛŒØªØŒ ÙÙ‡Ù…ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Ø§Ø² ÙˆØ¶Ø¹ÛŒØª Ø®Ù„Ù‚ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
            """
        )

        # Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§: Ù†Ù…Ø§ÛŒØ´ top-N ÙˆØ§Ø­Ø¯Ù‡Ø§ Ùˆ 'Ø³Ø§ÛŒØ±'
        s = units_df[['Ù†Ø§Ù…_Ú©ÙˆØªØ§Ù‡','Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§']].copy().groupby('Ù†Ø§Ù…_Ú©ÙˆØªØ§Ù‡').sum()
        s = s.sort_values('Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§', ascending=False)
        top = s.head(TOP_N).reset_index()
        other = s['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'][TOP_N:].sum()
        pie_req = pd.concat([top.set_index('Ù†Ø§Ù…_Ú©ÙˆØªØ§Ù‡')['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'], pd.Series({'Ø³Ø§ÛŒØ±': other})])
        fig_p2 = px.pie(values=pie_req.values, names=pie_req.index, title=f'ØªÙˆØ²ÛŒØ¹ Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ (Top {TOP_N})')
        fig_p2.update_traces(textposition='inside', textinfo='percent+label')
        fig_p2.update_layout(height=420)
        st.plotly_chart(fig_p2, use_container_width=True)
        _render_paragraph(
            "ØªØ­Ù„ÛŒÙ„ ØªÙˆØ²ÛŒØ¹ Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ (Top N)",
            """
Ø­Ø¶ÙˆØ± Ø³Ù‡Ù… Ù‚Ø§Ø¨Ù„ ØªÙˆØ¬Ù‡ÛŒ Ø¯Ø± Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ø¨Ø±ØªØ± Ù†Ø´Ø§Ù†Ú¯Ø± ØªÙ…Ø±Ú©Ø² ØªÙ‚Ø§Ø¶Ø§ Ø¯Ø± ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ù…Ø´Ø®Øµ Ø§Ø³Øª. Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§ÙØª Ú©ÛŒÙÛŒØª Ø¯Ø± Ø§ÛŒÙ† ÙˆØ§Ø­Ø¯Ù‡Ø§ØŒ ØªÙ‚ÙˆÛŒØª ØªÛŒÙ… Ù¾Ø§Ø³Ø®ØŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØµÙ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ùˆ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ø³Ø§Ø²ÛŒ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø³Ù‡Ù… Â«Ø³Ø§ÛŒØ±Â» Ù†ÛŒØ² Ø¨Ø§Ø²ØªØ§Ø¨ Ø¯Ù… Ø¨Ù„Ù†Ø¯ ØªÙ‚Ø§Ø¶Ø§Ø³Øª Ùˆ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ú†Ù‡ Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø§Ø± Ù…ÛŒØ§Ù† Ø³Ø§ÛŒØ± ÙˆØ§Ø­Ø¯Ù‡Ø§ ØªÙˆØ²ÛŒØ¹ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø±ØµØ¯ ØªØºÛŒÛŒØ± Ø³Ù‡Ù…â€ŒÙ‡Ø§ Ø¯Ø± Ø¨Ø§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ø²Ù…Ø§Ù†ÛŒØŒ Ø§Ø«Ø± Ù…Ø¯Ø§Ø®Ù„Ø§Øª Ø±Ø§ Ø±ÙˆØ´Ù† Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯.
            """
        )

        # ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†: top-N
        s2 = units_df[['Ù†Ø§Ù…_Ú©ÙˆØªØ§Ù‡','ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†']].copy().groupby('Ù†Ø§Ù…_Ú©ÙˆØªØ§Ù‡').sum()
        s2 = s2.sort_values('ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†', ascending=False)
        top2 = s2.head(TOP_N).reset_index()
        other2 = s2['ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†'][TOP_N:].sum()
        pie_stu = pd.concat([top2.set_index('Ù†Ø§Ù…_Ú©ÙˆØªØ§Ù‡')['ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†'], pd.Series({'Ø³Ø§ÛŒØ±': other2})])
        fig_p3 = px.pie(values=pie_stu.values, names=pie_stu.index, title=f'ØªÙˆØ²ÛŒØ¹ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† (Top {TOP_N})')
        fig_p3.update_traces(textposition='inside', textinfo='percent+label')
        fig_p3.update_layout(height=420)
        st.plotly_chart(fig_p3, use_container_width=True)
        _render_paragraph(
            "ØªØ­Ù„ÛŒÙ„ ØªÙˆØ²ÛŒØ¹ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† (Top N)",
            """
Ø§ÛŒÙ† Ù†Ù…ÙˆØ¯Ø§Ø± ØªÙˆØ²ÛŒØ¹ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ø±Ø§ Ù…ÛŒØ§Ù† ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ø¹Ù…Ø¯Ù‡ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ùˆ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø¸Ø±ÙÛŒØªØŒ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø®Ø¯Ù…Ø§Øª Ùˆ Ø·Ø±Ø§Ø­ÛŒ ØªØ¬Ø±Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø§Ù‡Ù…ÛŒØª Ø¯Ø§Ø±Ø¯. ØªÙ…Ø±Ú©Ø² Ø¨Ø§Ù„Ø§ Ø¯Ø± Ú†Ù†Ø¯ ÙˆØ§Ø­Ø¯ Ø¨Ø²Ø±Ú¯ Ø·Ø¨ÛŒØ¹ÛŒ Ø§Ø³Øª Ø§Ù…Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ú©ÛŒÙÛŒØª Ø®Ø¯Ù…Ø§Øª Ù‡Ù…â€ŒØªØ±Ø§Ø² Ø´ÙˆØ¯. ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ú©ÙˆÚ†Ú©â€ŒØªØ± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ø¨Ø§ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø·ÛŒ Ùˆ Ø®Ø¯Ù…Ø§Øª Ø¯ÛŒØ¬ÛŒØªØ§Ù„ Ù‡Ø¯ÙÙ…Ù†Ø¯ØŒ ØªØ¬Ø±Ø¨Ù‡ Ø¨Ù‡ØªØ±ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡Ù†Ø¯ Ùˆ Ø¨Ø®Ø´ÛŒ Ø§Ø² Ø¨Ø§Ø± Ù…Ø±Ø§Ø¬Ø¹Ø§Øª Ø±Ø§ Ø§Ø² Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø­Ø¶ÙˆØ±ÛŒ Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ† Ù…Ù†ØªÙ‚Ù„ Ú©Ù†Ù†Ø¯.
            """
        )
    # ØªØ­Ù„ÛŒÙ„ Ø¹Ù…Ù„Ú©Ø±Ø¯ ÙˆØ§Ø­Ø¯Ù‡Ø§
    st.markdown("### ğŸ¯ ØªØ­Ù„ÛŒÙ„ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ùˆ Ú©ÛŒÙÛŒØª Ø®Ø¯Ù…Ø§Øª")
    
    col3, col4 = st.columns(2)
    
    with col3:
        # Ù†Ù…ÙˆØ¯Ø§Ø± Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„
        units_df['Ø±Ù†Ú¯_Ø¹Ù…Ù„Ú©Ø±Ø¯'] = units_df['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„'].apply(
            lambda x: 'Ø¹Ø§Ù„ÛŒ' if x >= 95 else 'Ø®ÙˆØ¨' if x >= 90 else 'Ø¶Ø¹ÛŒÙ'
        )
        
    # Ù†Ù…ÙˆØ¯Ø§Ø± Ù…ÛŒÙ„Ù‡â€ŒØ§ÛŒ Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ (Ù…Ø±ØªØ¨â€ŒØ´Ø¯Ù‡)
    comp_df = units_df.copy().sort_values('Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„', ascending=False)
    fig_completion = px.bar(comp_df, x='Ù†Ø§Ù…_Ú©ÙˆØªØ§Ù‡', y='Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„',
                color='Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„', color_continuous_scale='RdYlGn',
                title='Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ø¯Ø± ÙˆØ§Ø­Ø¯Ù‡Ø§ (Ù…Ø±ØªØ¨â€ŒØ´Ø¯Ù‡)')
    fig_completion.update_layout(xaxis_tickangle=45, yaxis_title='Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ (%)')
    fig_completion.add_hline(y=95, line_dash='dash', line_color='green')
    fig_completion.add_hline(y=90, line_dash='dash', line_color='orange')
    st.plotly_chart(fig_completion, use_container_width=True)
    _render_paragraph(
        "ØªØ­Ù„ÛŒÙ„ Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ ÙˆØ§Ø­Ø¯Ù‡Ø§",
        """
Ù†Ù…ÙˆØ¯Ø§Ø± Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ØŒ Ú©ÛŒÙÛŒØª Ù¾Ø§Ø³Ø®â€ŒÚ¯ÙˆÛŒÛŒ ÙˆØ§Ø­Ø¯Ù‡Ø§ Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ùˆ Ø®Ø·ÙˆØ· Ù…Ø±Ø²ÛŒ 90 Ùˆ 95 Ø¯Ø±ØµØ¯ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„ÛŒ Ø±Ø§ Ù…Ø´Ø®Øµ Ù…ÛŒâ€ŒØ³Ø§Ø²Ù†Ø¯. ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ø²ÛŒØ± 90 Ø¯Ø±ØµØ¯ Ø¨Ù‡ Ù…Ø¯Ø§Ø®Ù„Ø§Øª ÙÙˆØ±ÛŒ Ù†ÛŒØ§Ø² Ø¯Ø§Ø±Ù†Ø¯ Ùˆ Ø¨Ø§ÛŒØ¯ Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ø§Ø±Ø¬Ø§Ø¹ØŒ Ø¢Ù…ÙˆØ²Ø´ Ù†ÛŒØ±ÙˆÙ‡Ø§ Ùˆ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ Ø¨Ø§Ø²Ø¨ÛŒÙ†ÛŒ Ø´ÙˆØ¯. ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ù†Ø²Ø¯ÛŒÚ© ÛŒØ§ ÙØ±Ø§ØªØ± Ø§Ø² 95 Ø¯Ø±ØµØ¯ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ù†Ù‚Ø´ Ø§Ù„Ú¯Ùˆ Ùˆ Ù…Ù†ØªÙˆØ± Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø±ØªÙ‚Ø§ÛŒ Ø³Ø§ÛŒØ± ÙˆØ§Ø­Ø¯Ù‡Ø§ Ø§ÛŒÙØ§ Ú©Ù†Ù†Ø¯. Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø§ÛŒÙ† Ù†Ù…ÙˆØ¯Ø§Ø± Ø¨Ø§ Ù†Ø³Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª/Ø¯Ø§Ù†Ø´Ø¬Ùˆ Ùˆ ØªÙˆØ²ÛŒØ¹ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒØŒ ØªØµÙˆÛŒØ± Ø¬Ø§Ù…Ø¹â€ŒØªØ±ÛŒ Ø¨Ø±Ø§ÛŒ ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ ÙØ±Ø§Ù‡Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
        """
    )
    
    with col4:
        # ØªÙˆØ²ÛŒØ¹ Ù…ØªØºÛŒØ±Ù‡Ø§ â€” Ù‡ÛŒØ³ØªÙˆÚ¯Ø±Ø§Ù…â€ŒÙ‡Ø§: ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†ØŒ Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ØŒ Ù†Ø³Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª/Ø¯Ø§Ù†Ø´Ø¬Ùˆ
        dist_df = units_df[['ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†','Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§','Ù†Ø³Ø¨Øª_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¯Ø§Ù†Ø´Ø¬Ùˆ']].copy()
        # make 3 small histograms side-by-side
        from plotly.subplots import make_subplots
        fig_dist = make_subplots(rows=1, cols=3, subplot_titles=['ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†','Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§','Ù†Ø³Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª/Ø¯Ø§Ù†Ø´Ø¬Ùˆ'])
        for i, coln in enumerate(dist_df.columns):
            vals = dist_df[coln].replace([np.inf, -np.inf], np.nan).dropna()
            if vals.empty:
                # Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ ÛŒÚ© Ø³Ø·Ø± ØµÙØ± Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‡ÛŒÙ… ØªØ§ Ø®Ø·Ø§ Ø±Ø® Ù†Ø¯Ù‡Ø¯
                fig_dist.add_trace(go.Bar(x=[0], y=[0], name=coln), row=1, col=i+1)
            else:
                hist = np.histogram(vals, bins=20)
                fig_dist.add_trace(go.Bar(x=hist[1][:-1], y=hist[0], name=coln), row=1, col=i+1)
        fig_dist.update_layout(height=320, showlegend=False, title_text='ØªÙˆØ²ÛŒØ¹ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ ÙˆØ§Ø­Ø¯Ù‡Ø§')
        st.plotly_chart(fig_dist, use_container_width=True)
        _render_paragraph(
            "ØªØ­Ù„ÛŒÙ„ ØªÙˆØ²ÛŒØ¹ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ ÙˆØ§Ø­Ø¯Ù‡Ø§",
            """
Ù‡ÛŒØ³ØªÙˆÚ¯Ø±Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ø³Ù‡â€ŒÚ¯Ø§Ù†Ù‡ Ø´Ú©Ù„ ØªÙˆØ²ÛŒØ¹ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†ØŒ Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ùˆ Ù†Ø³Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª/Ø¯Ø§Ù†Ø´Ø¬Ùˆ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ù†Ø¯ Ùˆ ÙˆØ¬ÙˆØ¯ Ú†ÙˆÙ„Ú¯ÛŒ ÛŒØ§ Ø¯Ù… Ø¨Ù„Ù†Ø¯ Ø±Ø§ Ø¢Ø´Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯. Ø§ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ø§ÛŒ ØªØ¹Ø±ÛŒÙ Ø¢Ø³ØªØ§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ù‡Ø´Ø¯Ø§Ø±ØŒ ØªØ´Ø®ÛŒØµ Ù†Ù‚Ø§Ø· Ù¾Ø±Øª Ùˆ Ø·Ø±Ø§Ø­ÛŒ Ù…Ø¯Ø§Ø®Ù„Ø§Øª Ù‡Ø¯ÙÙ…Ù†Ø¯ Ø¶Ø±ÙˆØ±ÛŒ Ø§Ø³Øª. Ù¾Ø§ÛŒØ´ ØªØºÛŒÛŒØ± Ø´Ú©Ù„ ØªÙˆØ²ÛŒØ¹â€ŒÙ‡Ø§ Ù¾Ø³ Ø§Ø² Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø§ØµÙ„Ø§Ø­ÛŒØŒ Ø§Ø«Ø±Ø¨Ø®Ø´ÛŒ Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯. ØªØ±Ú©ÛŒØ¨ Ø§ÛŒÙ† ØªØ­Ù„ÛŒÙ„ Ø¨Ø§ Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ÛŒ Ú©ÛŒÙÛŒØª Ùˆ Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø®ØŒ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¸Ø±ÙÛŒØª Ø±Ø§ ØªØ³Ù‡ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
            """
        )
    
    # Ø¬Ø¯ÙˆÙ„ Ø¬Ø§Ù…Ø¹ Ø¹Ù…Ù„Ú©Ø±Ø¯ ÙˆØ§Ø­Ø¯Ù‡Ø§
    st.markdown("### ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø¬Ø§Ù…Ø¹ Ø¹Ù…Ù„Ú©Ø±Ø¯ ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ø§Ø³ØªØ§Ù† Ù…Ø±Ú©Ø²ÛŒ")
    
    # Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´
    display_units = units_df[[
        'Ù†Ø§Ù…_ÙˆØ§Ø­Ø¯', 'ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†', 'Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§', 'Ù†Ø³Ø¨Øª_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¯Ø§Ù†Ø´Ø¬Ùˆ',
        'Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡', 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø±Ø¯_Ø´Ø¯Ù‡', 'Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„', 'Ù†Ø±Ø®_Ø±Ø¯'
    ]].copy()
    
    display_units.columns = [
        'Ù†Ø§Ù… ÙˆØ§Ø­Ø¯', 'ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†', 'Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§', 'Ù†Ø³Ø¨Øª Ø¯/Ø¬', 
        'Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡', 'Ø±Ø¯ Ø´Ø¯Ù‡', 'Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ (%)', 'Ù†Ø±Ø® Ø±Ø¯ (%)'
    ]
    
    # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø±Ø¯ÛŒÙ Ù…Ø¬Ù…ÙˆØ¹
    total_row = pd.DataFrame({
        'Ù†Ø§Ù… ÙˆØ§Ø­Ø¯': ['ğŸ”¢ Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„'],
        'ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†': [units_df['ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†'].sum()],
        'Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§': [units_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'].sum()],
        'Ù†Ø³Ø¨Øª Ø¯/Ø¬': [(units_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'].sum() / units_df['ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†'].sum()).round(2)],
        'Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡': [units_df['Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡'].sum()],
        'Ø±Ø¯ Ø´Ø¯Ù‡': [units_df['Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø±Ø¯_Ø´Ø¯Ù‡'].sum()],
        'Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ (%)': [(units_df['Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡'].sum() / units_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'].sum() * 100).round(1)],
        'Ù†Ø±Ø® Ø±Ø¯ (%)': [(units_df['Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø±Ø¯_Ø´Ø¯Ù‡'].sum() / units_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'].sum() * 100).round(1)]
    })
    
    final_display = pd.concat([display_units, total_row], ignore_index=True)
    
    # ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø¬Ø¯ÙˆÙ„
    def highlight_totals(val):
        if isinstance(val, str) and val.startswith('ğŸ”¢'):
            return 'background-color: #FFE5B4; font-weight: bold;'
        return ''
    
    def highlight_performance(val):
        if isinstance(val, (int, float)):
            if val >= 95:
                return 'background-color: #D5F4E6;'
            elif val >= 90:
                return 'background-color: #FFF3CD;'
            elif val < 85 and val > 0:
                return 'background-color: #F8D7DA;'
        return ''
    
    styled_df = final_display.style.applymap(highlight_totals).applymap(highlight_performance, subset=['Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ (%)'])
    
    st.dataframe(styled_df, use_container_width=True, hide_index=True)
    _render_paragraph(
        "ØªØ­Ù„ÛŒÙ„ Ø¬Ø¯ÙˆÙ„ Ø¬Ø§Ù…Ø¹ Ø¹Ù…Ù„Ú©Ø±Ø¯ ÙˆØ§Ø­Ø¯Ù‡Ø§",
        """
Ø§ÛŒÙ† Ø¬Ø¯ÙˆÙ„ ØªØµÙˆÛŒØ±ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Ø§Ø² ÙˆØ¶Ø¹ÛŒØª ÙˆØ§Ø­Ø¯Ù‡Ø§ Ø§Ø±Ø§Ø¦Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ùˆ Ø¨Ø§ Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø¯ÛŒÙ Â«Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„Â»ØŒ Ù…Ø¹ÛŒØ§Ø± Ù…Ù‚Ø§ÛŒØ³Ù‡â€ŒØ§ÛŒ Ø±ÙˆØ´Ù† ÙØ±Ø§Ù‡Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ùˆ Ù†Ø±Ø® Ø±Ø¯ØŒ Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ú©ÛŒÙÛŒØªâ€ŒØ§Ù†Ø¯ Ùˆ Ø¯Ø± Ú©Ù†Ø§Ø± Ù†Ø³Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª/Ø¯Ø§Ù†Ø´Ø¬ÙˆØŒ Ø´Ø¯Øª Ùˆ Ú©Ø§Ø±Ø§ÛŒÛŒ Ù¾Ø§Ø³Ø®â€ŒÚ¯ÙˆÛŒÛŒ Ø±Ø§ Ù…ÛŒâ€ŒØ³Ù†Ø¬Ù†Ø¯. Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§ÛŒÙ† Ø¬Ø¯ÙˆÙ„ Ù…ÛŒâ€ŒØªÙˆØ§Ù† ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ù…Ø¯Ø§Ø®Ù„Ù‡ Ø±Ø§ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒØŒ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø±Ø§ Ù‡Ø¯ÙÙ…Ù†Ø¯ Ùˆ ØªØ®ØµÛŒØµ Ù…Ù†Ø§Ø¨Ø¹ Ø±Ø§ Ø¨Ù‡ÛŒÙ†Ù‡ Ú©Ø±Ø¯. Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ Ø§Ø² Ø§ÛŒÙ† Ø¬Ø¯ÙˆÙ„ØŒ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø§Ø«Ø±Ø¨Ø®Ø´ÛŒ Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø±Ø§ Ø§Ù…Ú©Ø§Ù†â€ŒÙ¾Ø°ÛŒØ± Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯.
        """
    )
    
    # Ø¨ÛŒÙ†Ø´â€ŒÙ‡Ø§ Ùˆ ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø±ÛŒ (Ù…Ø­Ø§ÙØ¸Øªâ€ŒØ´Ø¯Ù‡)
    if 'Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„' in units_df.columns and not units_df['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„'].dropna().empty:
        try:
            best_idx = units_df['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„'].idxmax()
            worst_idx = units_df['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„'].idxmin()
            best_unit = units_df.loc[best_idx]
            worst_unit = units_df.loc[worst_idx]
        except Exception:
            best_unit = units_df.iloc[0] if len(units_df) > 0 else pd.Series()
            worst_unit = best_unit
    else:
        best_unit = units_df.iloc[0] if len(units_df) > 0 else pd.Series()
        worst_unit = best_unit

    # Ø§Ù…Ù†â€ŒØ³Ø§Ø²ÛŒ Ø³Ø§ÛŒØ± Ù…Ù‚Ø§Ø¯ÛŒØ± Ù†Ù…Ø§ÛŒØ´ÛŒ
    best_name = best_unit.get('Ù†Ø§Ù…_Ú©ÙˆØªØ§Ù‡', '') if hasattr(best_unit, 'get') else ''
    best_rate = best_unit.get('Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„', 0) if hasattr(best_unit, 'get') else 0

    largest_count = 0
    if len(units_df) > 0 and 'ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†' in units_df.columns:
        try:
            largest_count = int(units_df.iloc[0]['ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†'])
        except Exception:
            largest_count = 0

    if 'Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§' in units_df.columns and not units_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'].dropna().empty:
        try:
            top_idx = units_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'].idxmax()
            top_name = units_df.loc[top_idx, 'Ù†Ø§Ù…_Ú©ÙˆØªØ§Ù‡'] if 'Ù†Ø§Ù…_Ú©ÙˆØªØ§Ù‡' in units_df.columns else ''
            top_max = int(units_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'].max())
        except Exception:
            top_name = ''
            top_max = 0
    else:
        top_name = ''
        top_max = 0

    province_mean = units_df['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„'].mean() if 'Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„' in units_df.columns else 0

    st.markdown(f"""
    <div class="insight-box">
    <h4>ğŸ¯ Ø¨ÛŒÙ†Ø´â€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ ÙˆØ§Ø­Ø¯Ù‡Ø§:</h4>
    <ul>
    <li><strong>Ø¨Ù‡ØªØ±ÛŒÙ† Ø¹Ù…Ù„Ú©Ø±Ø¯:</strong> {best_name} Ø¨Ø§ {best_rate:.1f}% Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„</li>
    <li><strong>Ø¨Ø²Ø±Ú¯ØªØ±ÛŒÙ† ÙˆØ§Ø­Ø¯:</strong> Ø§Ø±Ø§Ú© Ø¨Ø§ {largest_count:,} Ø¯Ø§Ù†Ø´Ø¬Ùˆ</li>
    <li><strong>Ù¾Ø±ØªØ±Ø§ÙÛŒÚ©â€ŒØªØ±ÛŒÙ†:</strong> {top_name} Ø¨Ø§ {top_max:,} Ø¯Ø±Ø®ÙˆØ§Ø³Øª</li>
    <li><strong>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¹Ù…Ù„Ú©Ø±Ø¯:</strong> {province_mean:.1f}% Ø¯Ø± Ø³Ø·Ø­ Ø§Ø³ØªØ§Ù†</li>
    </ul>
    </div>
    """, unsafe_allow_html=True)

def create_clusters_analysis(clusters_df):
    """ØªØ­Ù„ÛŒÙ„ Ø¬Ø§Ù…Ø¹ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ­ØµÛŒÙ„ÛŒ"""
    st.markdown("## ğŸ¯ ØªØ­Ù„ÛŒÙ„ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ­ØµÛŒÙ„ÛŒ")
    # Ù…Ø­Ø§ÙØ¸Øª Ùˆ Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§: Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù†Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ØªØºÛŒØ± Ùˆ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø§Ø¹Ø¯Ø§Ø¯
    def _find_and_coerce(df, canonical, tokens_any=None, tokens_all=None):
        # tokens_any: any of these tokens in column name matches
        # tokens_all: all of these tokens must be in column name to match
        if df is None:
            return df
        if canonical in df.columns:
            # coerce numeric
            try:
                df[canonical] = pd.to_numeric(df[canonical], errors='coerce').fillna(0)
            except Exception:
                df[canonical] = df[canonical].apply(lambda x: pd.to_numeric(str(x).replace(',',''), errors='coerce')).fillna(0)
            return df
        cols = list(df.columns)
        for c in cols:
            low = str(c).replace('_','').replace(' ','').lower()
            matched = False
            if tokens_all:
                if all(t in low for t in tokens_all):
                    matched = True
            if not matched and tokens_any:
                if any(t in low for t in tokens_any):
                    matched = True
            if matched:
                try:
                    df[canonical] = pd.to_numeric(df[c].astype(str).str.replace(',',''), errors='coerce').fillna(0)
                except Exception:
                    df[canonical] = pd.to_numeric(df[c], errors='coerce').fillna(0)
                return df
        # not found: create default
        df[canonical] = 0
        return df

    clusters_df = clusters_df.copy()
    clusters_df = _find_and_coerce(clusters_df, 'Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§', tokens_any=['Ø¯Ø±Ø®ÙˆØ§Ø³Øª','request','total','Ú©Ù„'], tokens_all=['Ú©Ù„','Ø¯Ø±Ø®ÙˆØ§Ø³Øª'])
    clusters_df = _find_and_coerce(clusters_df, 'ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†', tokens_any=['Ø¯Ø§Ù†Ø´Ø¬Ùˆ','student','ØªØ¹Ø¯Ø§Ø¯'], tokens_all=['ØªØ¹Ø¯Ø§Ø¯','Ø¯Ø§Ù†Ø´Ø¬Ùˆ'])

    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("### ğŸ“Š ØªÙˆØ²ÛŒØ¹ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ù‚Ø·Ø¹ ØªØ­ØµÛŒÙ„ÛŒ")
        
        # ØªÙˆØ²ÛŒØ¹ Ù…Ù‚Ø§Ø·Ø¹
        degree_counts = clusters_df['Ù…Ù‚Ø·Ø¹'].value_counts()
        
        fig_degrees = px.pie(
            values=degree_counts.values,
            names=degree_counts.index,
            title="ØªÙˆØ²ÛŒØ¹ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ù‚Ø·Ø¹",
            color_discrete_sequence=px.colors.qualitative.Pastel
        )
        fig_degrees.update_traces(textposition='inside', textinfo='percent+label')
        st.plotly_chart(fig_degrees, use_container_width=True)
        _render_paragraph(
            "ØªØ­Ù„ÛŒÙ„ ØªÙˆØ²ÛŒØ¹ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ù‚Ø·Ø¹",
            """
Ù†Ù…ÙˆØ¯Ø§Ø± Ù¾Ø§ÛŒ Ù…Ù‚Ø§Ø·Ø¹ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ø³Ù‡Ù… Ù‡Ø± Ù…Ù‚Ø·Ø¹ Ø¯Ø± Ø´Ú©Ù„â€ŒÚ¯ÛŒØ±ÛŒ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ Ú†Ú¯ÙˆÙ†Ù‡ Ø§Ø³Øª Ùˆ Ú©Ø¯Ø§Ù… Ù…Ù‚Ø§Ø·Ø¹ Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ ØªÙ…Ø±Ú©Ø² Ø¨ÛŒØ´ØªØ± Ø¯Ø± Ø®Ø¯Ù…Ø§Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù‡Ø³ØªÙ†Ø¯. ØºÙ„Ø¨Ù‡ Ù…Ù‚Ø§Ø·Ø¹ Ú©Ø§Ø±Ø´Ù†Ø§Ø³ÛŒ Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø·Ø¨ÛŒØ¹ÛŒ Ø§Ø³ØªØŒ Ø§Ù…Ø§ Ø³Ù‡Ù… Ø¨Ø§Ù„Ø§ÛŒ ØªØ­ØµÛŒÙ„Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ ØªÙ‚Ø§Ø¶Ø§Ù‡Ø§ÛŒ ØªØ®ØµØµÛŒâ€ŒØªØ± Ù…Ù†Ø¬Ø± Ø´ÙˆØ¯. Ù‡Ù…Ø¨Ø³ØªÚ¯ÛŒ Ø§ÛŒÙ† ØªØ±Ú©ÛŒØ¨ Ø¨Ø§ Ø§Ù„Ú¯ÙˆÛŒ ØªÙ‚Ø§Ø¶Ø§ Ùˆ Ú©ÛŒÙÛŒØª Ù¾Ø§Ø³Ø®ØŒ Ø¬Ù‡Øªâ€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ù…Ù†Ø§Ø¨Ø¹ Ùˆ Ø·Ø±Ø§Ø­ÛŒ Ù…Ø­ØªÙˆØ§Ù‡Ø§ÛŒ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø®ØªØµØ§ØµÛŒ Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯.
            """
        )
        
        # Ø¢Ù…Ø§Ø± ØªÙØµÛŒÙ„ÛŒ Ù…Ù‚Ø§Ø·Ø¹
        st.markdown("#### ğŸ“ˆ Ø¢Ù…Ø§Ø± ØªÙØµÛŒÙ„ÛŒ Ù…Ù‚Ø§Ø·Ø¹:")
        degree_stats = clusters_df.groupby('Ù…Ù‚Ø·Ø¹').agg({
            'ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†': ['count', 'sum', 'mean'],
            'Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§': 'sum'
        }).round(1)
        
        degree_stats.columns = ['ØªØ¹Ø¯Ø§Ø¯ Ø®ÙˆØ´Ù‡', 'Ú©Ù„ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†', 'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ø§Ù†Ø´Ø¬Ùˆ/Ø®ÙˆØ´Ù‡', 'Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§']
        st.dataframe(degree_stats, use_container_width=True)
        _render_paragraph(
            "ØªØ­Ù„ÛŒÙ„ Ø¢Ù…Ø§Ø± ØªÙØµÛŒÙ„ÛŒ Ù…Ù‚Ø§Ø·Ø¹",
            """
Ø¬Ø¯ÙˆÙ„ ØªÙØµÛŒÙ„ÛŒ Ø¨Ø§ Ø§Ø±Ø§Ø¦Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ø®ÙˆØ´Ù‡ØŒ Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ùˆ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ø§Ù†Ø´Ø¬Ùˆ Ø¯Ø± Ù‡Ø± Ø®ÙˆØ´Ù‡ØŒ ØªØ±Ø§Ú©Ù… Ø¢Ù…ÙˆØ²Ø´ÛŒ Ùˆ Ø´Ø¯Øª ØªÙ‚Ø§Ø¶Ø§ÛŒ Ø¨Ø§Ù„Ù‚ÙˆÙ‡ Ø±Ø§ Ø±ÙˆØ´Ù† Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¨ÛŒÙ† Ù…Ù‚Ø§Ø·Ø¹ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯ ØªØ®ØµÛŒØµ Ù…Ù†Ø§Ø¨Ø¹ Ù…Ù†ØµÙØ§Ù†Ù‡ Ùˆ Ù…ÙˆØ«Ø± Ø¨Ø§Ø´Ø¯ Ùˆ Ø§Ù‡Ø¯Ø§Ù Ù¾ÙˆØ´Ø´ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù…Ù‚Ø·Ø¹ ØªØ¯ÙˆÛŒÙ† Ø´ÙˆØ¯. Ø±ØµØ¯ Ø±ÙˆÙ†Ø¯ÛŒ Ø§ÛŒÙ† Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ØŒ ØªØ§Ø«ÛŒØ± Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ùˆ Ø­Ù…Ø§ÛŒØªÛŒ Ø±Ø§ Ù†Ù…Ø§ÛŒØ§Ù† Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯ Ùˆ Ù…Ø³ÛŒØ± Ø¨Ù‡Ø¨ÙˆØ¯ Ù…Ø³ØªÙ…Ø± Ø±Ø§ ÙØ±Ø§Ù‡Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
            """
        )
    
    with col2:
        st.markdown("### ğŸ“š Ø±Ø´ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø·Ø±ÙØ¯Ø§Ø±")
        
        # 10 Ø±Ø´ØªÙ‡ Ø¨Ø±ØªØ±
        top_fields = clusters_df['Ø±Ø´ØªÙ‡'].value_counts().head(10)
        
        fig_fields = px.bar(
            x=top_fields.values,
            y=top_fields.index,
            orientation='h',
            title="10 Ø±Ø´ØªÙ‡ Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø®ÙˆØ´Ù‡",
            color=top_fields.values,
            color_continuous_scale='viridis'
        )
        fig_fields.update_layout(yaxis={'categoryorder':'total ascending'})
        st.plotly_chart(fig_fields, use_container_width=True)
        _render_paragraph(
            "ØªØ­Ù„ÛŒÙ„ Ø¯Ù‡ Ø±Ø´ØªÙ‡ Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø®ÙˆØ´Ù‡",
            """
Ù†Ù…ÙˆØ¯Ø§Ø± Ø±Ø´ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±ØªÚ©Ø±Ø§Ø± Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ú©Ø¯Ø§Ù… Ø­ÙˆØ²Ù‡â€ŒÙ‡Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø®ÙˆØ´Ù‡ Ø±Ø§ Ø´Ú©Ù„ Ø¯Ø§Ø¯Ù‡â€ŒØ§Ù†Ø¯ Ùˆ Ø¨Ù†Ø§Ø¨Ø±Ø§ÛŒÙ† Ú©Ø§Ù†Ø¯ÛŒØ¯Ø§ÛŒ Ø·Ø±Ø§Ø­ÛŒ Ø±Ø§Ù‡Ù†Ù…Ø§Ù‡Ø§ØŒ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ùˆ Ù…Ù†ØªÙˆØ±Ø´ÛŒÙ¾ ØªØ®ØµØµÛŒ Ù‡Ø³ØªÙ†Ø¯. ØªØ±Ú©ÛŒØ¨ Ø§ÛŒÙ† ØªØ­Ù„ÛŒÙ„ Ø¨Ø§ Ù†Ø±Ø®â€ŒÙ‡Ø§ÛŒ ØªÙ‚Ø§Ø¶Ø§ Ùˆ Ú©ÛŒÙÛŒØª Ù¾Ø§Ø³Ø® Ø¯Ø± Ù‡Ø± Ø±Ø´ØªÙ‡ØŒ Ø¨Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø¸Ø±ÙÛŒØª Ùˆ Ø¢Ù…ÙˆØ²Ø´ Ù…Ù†Ø¬Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø±ØµØ¯ ØªØºÛŒÛŒØ± Ø±ØªØ¨Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ø²Ù…Ø§Ù† Ù†ÛŒØ² Ø§Ø«Ø± Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø°ÛŒØ±Ø´ Ùˆ ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø§Ø²Ø§Ø± Ú©Ø§Ø± Ø±Ø§ Ø¨Ø§Ø²ØªØ§Ø¨ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.
            """
        )
        
        # ØªÙˆØ²ÛŒØ¹ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§
        st.markdown("#### ğŸ‘¥ ØªÙˆØ²ÛŒØ¹ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§:")
        
        def categorize_cluster_size(students):
            if students == 0: return 'Ø®Ø§Ù„ÛŒ (0)'
            elif students <= 10: return 'Ú©ÙˆÚ†Ú© (1-10)'
            elif students <= 30: return 'Ù…ØªÙˆØ³Ø· (11-30)'  
            elif students <= 50: return 'Ø¨Ø²Ø±Ú¯ (31-50)'
            else: return 'Ø¨Ø³ÛŒØ§Ø± Ø¨Ø²Ø±Ú¯ (50+)'
        
        clusters_df['Ø§Ù†Ø¯Ø§Ø²Ù‡_Ø¯Ø³ØªÙ‡'] = clusters_df['ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†'].apply(categorize_cluster_size)
        size_counts = clusters_df['Ø§Ù†Ø¯Ø§Ø²Ù‡_Ø¯Ø³ØªÙ‡'].value_counts()
        
        fig_sizes = px.bar(
            x=size_counts.index,
            y=size_counts.values,
            title="ØªÙˆØ²ÛŒØ¹ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§",
            color=size_counts.values,
            color_continuous_scale='blues'
        )
        st.plotly_chart(fig_sizes, use_container_width=True)
        _render_paragraph(
            "ØªØ­Ù„ÛŒÙ„ ØªÙˆØ²ÛŒØ¹ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§",
            """
ØªÙ‚Ø³ÛŒÙ…â€ŒØ¨Ù†Ø¯ÛŒ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ Ø³Ø§Ø®ØªØ§Ø± Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø±Ø§ Ø±ÙˆØ´Ù† Ù…ÛŒâ€ŒÚ©Ù†Ø¯. ØºÙ„Ø¨Ù‡ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ú©ÙˆÚ†Ú© Ø·Ø¨ÛŒØ¹ÛŒ Ø§Ø³ØªØŒ Ø§Ù…Ø§ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯ Ø¨Ù‡ Ù¾Ø§ÛŒØ´ Ù†Ø²Ø¯ÛŒÚ© Ú©ÛŒÙÛŒØª Ùˆ Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø® Ù†ÛŒØ§Ø² Ø¯Ø§Ø±Ù†Ø¯. ØªØ®ØµÛŒØµ Ù…Ù†ØªÙˆØ±Ù‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ±ØŒ ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§Ù‡Ø§ÛŒ Ø³Ù„Ùâ€ŒØ³Ø±ÙˆÛŒØ³ Ùˆ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ±Ø§ÛŒÙ†Ø¯ Ø«Ø¨Øª Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡ Ø­ÙØ¸ Ú©ÛŒÙÛŒØª Ø¯Ø± Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÙØ±Ø¬Ù…Ø¹ÛŒØª Ú©Ù…Ú© Ú©Ù†Ø¯. Ø±ØµØ¯ ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÙ‡Ø§ Ù†ÛŒØ² ØªØ§Ø«ÛŒØ± Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø°ÛŒØ±Ø´ Ø±Ø§ Ù…Ù†Ø¹Ú©Ø³ Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯.
            """
        )
    
    # ØªØ­Ù„ÛŒÙ„ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±ÙØ¹Ø§Ù„
    st.markdown("### ğŸ”¥ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±ÙØ¹Ø§Ù„ Ùˆ Ù¾Ø±Ø¯Ø±Ø®ÙˆØ§Ø³Øª")
    
    col3, col4 = st.columns(2)
    
    with col3:
        # Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø±Ø®ÙˆØ§Ø³Øª
        active_clusters = clusters_df[clusters_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'] > 0]
        top_active_clusters = active_clusters.nlargest(15, 'Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§')
        
        fig_active = px.bar(
            top_active_clusters,
            x='Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§',
            y=range(len(top_active_clusters)),
            orientation='h',
            title="15 Ø®ÙˆØ´Ù‡ Ù¾Ø±Ø¯Ø±Ø®ÙˆØ§Ø³Øª",
            labels={'y': 'Ø±ØªØ¨Ù‡', 'x': 'ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§'},
            color='Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§',
            color_continuous_scale='reds'
        )
        
        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ø±Ú†Ø³Ø¨ Ø±Ø´ØªÙ‡
        def _shorten_label(val):
            try:
                s = str(val) if val is not None else ''
                s = s.strip()
                return s if len(s) <= 15 else s[:15] + '...'
            except Exception:
                return ''

        fig_active.update_layout(
            yaxis=dict(
                tickmode='array',
                tickvals=list(range(len(top_active_clusters))),
                ticktext=[_shorten_label(row.get('Ø±Ø´ØªÙ‡', '')) for _, row in top_active_clusters.iterrows()]
            )
        )
        
        st.plotly_chart(fig_active, use_container_width=True)
        _render_paragraph(
            "ØªØ­Ù„ÛŒÙ„ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø±Ø®ÙˆØ§Ø³Øª",
            """
Ù†Ù…ÙˆØ¯Ø§Ø± Û±Ûµ Ø®ÙˆØ´Ù‡ Ù¾Ø±Ø¯Ø±Ø®ÙˆØ§Ø³ØªØŒ ØªÙ…Ø±Ú©Ø² ØªÙ‚Ø§Ø¶Ø§ Ø±Ø§ Ø¯Ø± Ù…ÙˆØ¶ÙˆØ¹Ø§Øª ÛŒØ§ Ø­ÙˆØ²Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø´Ø®Øµ Ø¨Ù‡ ØªØµÙˆÛŒØ± Ù…ÛŒâ€ŒÚ©Ø´Ø¯. Ø¯Ø± Ø§ÛŒÙ† Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ú©ÛŒÙÛŒØª Ù¾Ø§Ø³Ø® Ùˆ Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø® Ø¨Ù‡â€ŒØµÙˆØ±Øª ÙˆÛŒÚ˜Ù‡ Ù¾Ø§ÛŒØ´ Ø´ÙˆØ¯ Ùˆ Ù…Ù†Ø§Ø¨Ø¹ ØªØ®ØµØµÛŒ Ø§Ø®ØªØµØ§Øµ ÛŒØ§Ø¨Ø¯. ØªØ¯ÙˆÛŒÙ† Ù…Ø­ØªÙˆØ§ÛŒ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø®ØªØµØ§ØµÛŒØŒ Ù…Ù†ØªÙˆØ±Ø´ÛŒÙ¾ Ù…ÙˆØ¶ÙˆØ¹ÛŒ Ùˆ Ø¨Ù‡â€ŒÚ©Ø§Ø±Ú¯ÛŒØ±ÛŒ ØµÙ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø§Ø² Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ù„ÙˆÚ¯Ø§Ù‡ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ú©Ù†Ø¯. Ø±ØµØ¯ ØªØºÛŒÛŒØ± Ø±ØªØ¨Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ø²Ù…Ø§Ù†ØŒ Ø§Ø«Ø± Ù…Ø¯Ø§Ø®Ù„Ø§Øª Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.
            """
        )
    
    with col4:
        # Ù†Ù…ÙˆØ¯Ø§Ø± Ù¾Ø±Ø§Ú©Ù†Ø¯Ú¯ÛŒ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† vs Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§
        sample_clusters = clusters_df.sample(n=min(200, len(clusters_df)))  # Ù†Ù…ÙˆÙ†Ù‡ Ø¨Ø±Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¨Ù‡ØªØ±
        
        fig_scatter = px.scatter(
            sample_clusters,
            x='ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†',
            y='Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§',
            color='Ù…Ù‚Ø·Ø¹',
            size='Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§',
            title="Ø±Ø§Ø¨Ø·Ù‡ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ùˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§",
            labels={'x': 'ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†', 'y': 'ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§'}
        )
        st.plotly_chart(fig_scatter, use_container_width=True)
        _render_paragraph(
            "ØªØ­Ù„ÛŒÙ„ Ø±Ø§Ø¨Ø·Ù‡ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ùˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§",
            """
Ù†Ù…ÙˆØ¯Ø§Ø± Ù¾Ø±Ø§Ú©Ù†Ø¯Ú¯ÛŒ Ø±Ø§Ø¨Ø·Ù‡ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø®ÙˆØ´Ù‡ Ùˆ Ø´Ø¯Øª ØªÙ‚Ø§Ø¶Ø§ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯. Ù†Ù‚Ø§Ø·ÛŒ Ø¨Ø§ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ø²ÛŒØ§Ø¯ Ø§Ù…Ø§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ù†Ø¯Ú© Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù†Ø´Ø§Ù† Ø§Ø² Ø³Ù„Ùâ€ŒØ³Ø±ÙˆÛŒØ³ Ù‚ÙˆÛŒ ÛŒØ§ ÙØ±Ø¢ÛŒÙ†Ø¯Ù‡Ø§ÛŒ Ø³Ø§Ø¯Ù‡â€ŒØªØ± Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¯Ø± Ø­Ø§Ù„ÛŒâ€ŒÚ©Ù‡ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ú©Ù… Ùˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø²ÛŒØ§Ø¯ Ù†Ø´Ø§Ù†Ú¯Ø± Ù…Ø³Ø§Ø¦Ù„ Ø®Ø§Øµ ÛŒØ§ Ù†ÛŒØ§Ø²Ù‡Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ Ø§Ø³Øª. Ø§ÛŒÙ† ØªØ­Ù„ÛŒÙ„ Ø¨Ø§ Ø§ÙØ²ÙˆØ¯Ù† Ø±Ù†Ú¯â€ŒØ¨Ù†Ø¯ÛŒ Ù…Ù‚Ø§Ø·Ø¹ Ø¨Ù‡ Ø¯Ø±Ú© Ø¹Ù…ÛŒÙ‚â€ŒØªØ± Ø§Ù„Ú¯ÙˆÙ‡Ø§ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ù…Ø¨Ù†Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø·Ø±Ø§Ø­ÛŒ Ù…Ø¯Ø§Ø®Ù„Ø§Øª Ù‡Ø¯ÙÙ…Ù†Ø¯ ÙØ±Ø§Ù‡Ù… Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯.
            """
        )
    
    # Ø®Ù„Ø§ØµÙ‡ Ø¢Ù…Ø§Ø±ÛŒ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§
    st.markdown("### ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ø¢Ù…Ø§Ø±ÛŒ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ­ØµÛŒÙ„ÛŒ")
    
    summary_stats = {
        'Ø´Ø§Ø®Øµ': [
            'Ú©Ù„ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§',
            'Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„ (Ø¯Ø§Ø±Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª)',
            'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ø¯Ø± Ø®ÙˆØ´Ù‡',
            'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø± Ø®ÙˆØ´Ù‡',
            'Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø± ÛŒÚ© Ø®ÙˆØ´Ù‡',
            'Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø¯ÙˆÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª'
        ],
        'Ù…Ù‚Ø¯Ø§Ø±': [
            f"{len(clusters_df):,}",
            f"{len(clusters_df[clusters_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'] > 0]):,}",
            f"{clusters_df['ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†'].mean():.1f}",
            f"{clusters_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'].mean():.1f}", 
            f"{clusters_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'].max():,}",
            f"{len(clusters_df[clusters_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'] == 0]):,}"
        ]
    }
    
    summary_df = pd.DataFrame(summary_stats)
    st.dataframe(summary_df, use_container_width=True, hide_index=True)
    _render_paragraph(
        "ØªØ­Ù„ÛŒÙ„ Ø®Ù„Ø§ØµÙ‡ Ø¢Ù…Ø§Ø±ÛŒ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§",
        """
Ø§ÛŒÙ† Ø®Ù„Ø§ØµÙ‡ Ø¢Ù…Ø§Ø±ÛŒ ØªØµÙˆÛŒØ±ÛŒ Ø³Ø±ÛŒØ¹ Ø§Ø² ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ÛŒ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ Ø§Ø±Ø§Ø¦Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯: ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ØŒ Ø³Ù‡Ù… Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„ØŒ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ Ùˆ Ø­Ø¯Ø§Ú©Ø«Ø±Ù‡Ø§. ØªØ¹Ø¯Ø§Ø¯ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø¯ÙˆÙ† Ø¯Ø±Ø®ÙˆØ§Ø³ØªØŒ Ù†Ù‚Ø§Ø· ØºÛŒØ±ÙØ¹Ø§Ù„ Ø±Ø§ Ù…Ø¹Ø±ÙÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¢Ù†â€ŒÙ‡Ø§ Ø¨Ø±Ù†Ø§Ù…Ù‡ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ ØªØ¯ÙˆÛŒÙ† Ø´ÙˆØ¯. Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ Ø§ÛŒÙ† Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ØŒ Ø§Ø«Ø±Ø¨Ø®Ø´ÛŒ Ù…Ø¯Ø§Ø®Ù„Ø§Øª Ùˆ Ø±ÙˆÙ†Ø¯ Ø¨Ù‡Ø¨ÙˆØ¯ Ø±Ø§ Ø¹ÛŒØ§Ù† Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯ Ùˆ ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± Ø¯Ø§Ø¯Ù‡ Ø±Ø§ ØªØ³Ù‡ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
        """
    )

def create_arak_report(supporters_df, units_df, clusters_df):
    """Ú¯Ø²Ø§Ø±Ø´ ÙˆÛŒÚ˜Ù‡ ÙˆØ§Ø­Ø¯ Ø§Ø±Ø§Ú© Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ù„ÛŒ (CSV attachments)"""
    st.markdown("## ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ ÙˆØ§Ø­Ø¯ Ø§Ø±Ø§Ú©")

    # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¶Ù…ÛŒÙ…Ù‡ Ø¯Ø± workspace Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ù†Ø¯ (Ù¾Ø´ØªÛŒØ¨Ø§Ù†) Ùˆ ØªØ±Ø¬ÛŒØ­ Ø¨Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯Ù‡ Ø¯Ø± session_state
    workspace = os.path.abspath(os.path.dirname(__file__))
    csv13 = os.path.join(workspace, '13.csv')
    csv14 = os.path.join(workspace, '14.csv')

    extra_clusters = None
    extra_units = None
    try:
        if os.path.exists(csv13):
            extra_clusters = pd.read_csv(csv13, header=None, encoding='utf-8', engine='python')
    except Exception:
        extra_clusters = None

    try:
        if os.path.exists(csv14):
            extra_units = pd.read_csv(csv14, header=None, encoding='utf-8', engine='python')
    except Exception:
        extra_units = None

    # Ø§Ù†ØªØ®Ø§Ø¨ ÙˆØ§Ø­Ø¯ Ø§Ø±Ø§Ú© Ø§Ø² units_df (Ú©Ø¯ ÛŒØ§ Ù†Ø§Ù… Ø­Ø§ÙˆÛŒ 'Ø§Ø±Ø§Ú©' ÛŒØ§ Ú©Ø¯ '121')
    arak_unit = None
    def _find_col_by_tokens(df, tokens):
        if df is None:
            return None
        for col in df.columns:
            low = str(col).replace('_', '').replace(' ', '').lower()
            for t in tokens:
                if t in low:
                    return col
        return None

    code_col = _find_col_by_tokens(units_df, ['Ú©Ø¯ÙˆØ§Ø­Ø¯', 'Ú©Ø¯_ÙˆØ§Ø­Ø¯', 'code', 'id'])
    name_col = _find_col_by_tokens(units_df, ['Ù†Ø§Ù…ÙˆØ§Ø­Ø¯', 'Ù†Ø§Ù…_ÙˆØ§Ø­Ø¯', 'name', 'unit'])

    if code_col is not None:
        try:
            match = units_df[units_df[code_col].astype(str).str.contains('121')]
            if len(match) > 0:
                arak_unit = match.iloc[0]
        except Exception:
            pass
    if arak_unit is None and name_col is not None:
        try:
            match = units_df[units_df[name_col].astype(str).str.contains('Ø§Ø±Ø§Ú©', na=False)]
            if len(match) > 0:
                arak_unit = match.iloc[0]
        except Exception:
            pass

    if arak_unit is None:
        st.warning('ÙˆØ§Ø­Ø¯ Ø§Ø±Ø§Ú© Ø¯Ø± `units_df` Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ Ú©Ù‡ Ø³ØªÙˆÙ† "Ú©Ø¯_ÙˆØ§Ø­Ø¯" ÛŒØ§ "Ù†Ø§Ù…_ÙˆØ§Ø­Ø¯" Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯.')
        return

    # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø§Ú©
    arak_stats = {
        'Ø´Ø§Ø®Øµ': ['ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†', 'Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§', 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø¯ÛŒØ¯', 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…', 'Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡', 'Ø±Ø¯ Ø´Ø¯Ù‡', 'Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ (%)', 'Ù†Ø±Ø® Ø±Ø¯ (%)'],
        'Ù…Ù‚Ø¯Ø§Ø±': [
            int(arak_unit.get('ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†', 0)),
            int(arak_unit.get('Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§', 0)),
            int(arak_unit.get('Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¬Ø¯ÛŒØ¯', 0)),
            int(arak_unit.get('Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¯Ø±_Ø­Ø§Ù„_Ø§Ù†Ø¬Ø§Ù…', 0)),
            int(arak_unit.get('Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡', 0)),
            int(arak_unit.get('Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø±Ø¯_Ø´Ø¯Ù‡', 0)),
            float(arak_unit.get('Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„', 0.0)),
            float(arak_unit.get('Ù†Ø±Ø®_Ø±Ø¯', 0.0))
        ]
    }

    arak_df = pd.DataFrame(arak_stats)
    st.dataframe(arak_df, use_container_width=True, hide_index=True)

    # Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¨Ø§ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ø³ØªØ§Ù†
    province_avg_completion = units_df['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„'].mean() if 'Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„' in units_df.columns else 0
    st.markdown(f"### ğŸ” Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¨Ø§ Ø§Ø³ØªØ§Ù†: Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ø§Ø±Ø§Ú© {arak_unit.get('Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„', 0):.1f}%ØŒ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ø³ØªØ§Ù† {province_avg_completion:.1f}%")

    # Ù†Ù…ÙˆØ¯Ø§Ø± Ø®Ù„Ø§ØµÙ‡ ÙˆØ¶Ø¹ÛŒØª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¯Ø± Ø§Ø±Ø§Ú©
    fig = go.Figure()
    fig.add_trace(go.Bar(name='Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡', x=['Ø§Ø±Ø§Ú©'], y=[arak_unit.get('Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡', 0)], marker_color='#27AE60'))
    fig.add_trace(go.Bar(name='Ø±Ø¯ Ø´Ø¯Ù‡', x=['Ø§Ø±Ø§Ú©'], y=[arak_unit.get('Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø±Ø¯_Ø´Ø¯Ù‡', 0)], marker_color='#E74C3C'))
    fig.add_trace(go.Bar(name='Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…', x=['Ø§Ø±Ø§Ú©'], y=[arak_unit.get('Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¯Ø±_Ø­Ø§Ù„_Ø§Ù†Ø¬Ø§Ù…', 0)], marker_color='#F39C12'))
    fig.update_layout(barmode='stack', title='ÙˆØ¶Ø¹ÛŒØª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¯Ø± Ø§Ø±Ø§Ú©')
    st.plotly_chart(fig, use_container_width=True)

    # Ø§Ú¯Ø± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯ØŒ Ù†Ù…Ø§ÛŒØ´ Ø®Ù„Ø§ØµÙ‡
    if extra_units is not None:
        st.markdown('#### ğŸ” Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ Ø§Ø² `14.csv` (Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯)')
        st.write(extra_units.head())
    if extra_clusters is not None:
        st.markdown('#### ğŸ” Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ´Ù‡â€ŒØ§ÛŒ Ú©Ù…Ú©ÛŒ Ø§Ø² `13.csv` (Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯)')
        st.write(extra_clusters.head())

    # --- Additional Arak analyses derived from provided Excel summaries (12.xlsx,13.xlsx,14.xlsx) ---
    # If the detailed summary Excel files exist in workspace, prefer them for richer displays.
    x12 = os.path.join(workspace, '12.xlsx')
    x13 = os.path.join(workspace, '13.xlsx')
    x14 = os.path.join(workspace, '14.xlsx')

    # helper to safely read excel and normalize column names
    def _read_xlsx_safe(path):
        try:
            if os.path.exists(path):
                df = pd.read_excel(path)
                # normalize column names similar to uploads
                def _norm_cols(cols):
                    out = []
                    for c in cols:
                        s = str(c).strip()
                        s = s.replace('\u00A0', ' ')
                        s = s.replace('\u200C', '')
                        s = s.replace('-', '_')
                        s = s.replace(' ', '_')
                        s = s.replace('__', '_')
                        out.append(s)
                    return out
                df.columns = _norm_cols(df.columns)
                return df
        except Exception:
            return None
        return None

    # Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù‚Ø¨Ù„Ø§Ù‹ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø² Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¯Ø± session_state Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    ws_sup = st.session_state.get('uploaded_sup_df', None)
    ws_clusters = st.session_state.get('uploaded_clusters_df', None)
    ws_units = st.session_state.get('uploaded_units_df', None)
    if ws_sup is None:
        _tmp = _read_xlsx_safe(x12)
        ws_sup = _tmp if (_tmp is not None and not getattr(_tmp, 'empty', True)) else supporters_df
    if ws_clusters is None:
        _tmp = _read_xlsx_safe(x13)
        ws_clusters = _tmp if (_tmp is not None and not getattr(_tmp, 'empty', True)) else clusters_df
    if ws_units is None:
        _tmp = _read_xlsx_safe(x14)
        ws_units = _tmp if (_tmp is not None and not getattr(_tmp, 'empty', True)) else units_df

    # normalize expected column names (Persian variants)
    def _safe_col(df, wanted):
        if df is None:
            return None
        # columns already stripped
        for col in df.columns:
            for w in wanted:
                if w == col:
                    return col
        return None

    # token-based aliasing to canonical names for unit matching
    def _alias_columns_for_units(df):
        if df is None:
            return df
        cols = list(df.columns)
        rename = {}
        def canon(s):
            return ''.join([c for c in str(s) if c.isalnum()])

        for c in cols:
            low = canon(c)
            # detect code+unit
            if 'Ú©Ø¯' in c or ('Ú©Ø¯' in low and 'ÙˆØ§Ø­Ø¯' in low) or ('code' in low and 'unit' in low):
                rename[c] = 'Ú©Ø¯_ÙˆØ§Ø­Ø¯'
                continue
            if 'Ù†Ø§Ù…' in c and 'ÙˆØ§Ø­Ø¯' in c:
                rename[c] = 'Ù†Ø§Ù…_ÙˆØ§Ø­Ø¯'
                continue
            # more robust token scanning
            if 'Ù†Ø§Ù…' in low and 'ÙˆØ§Ø­Ø¯' in low:
                rename[c] = 'Ù†Ø§Ù…_ÙˆØ§Ø­Ø¯'
                continue
            if 'Ú©Ø¯' in low and 'ÙˆØ§Ø­Ø¯' in low:
                rename[c] = 'Ú©Ø¯_ÙˆØ§Ø­Ø¯'
                continue
        if rename:
            try:
                df = df.rename(columns=rename)
            except Exception:
                pass
        return df

    # apply aliasing to ws_units and units_df if they exist
    ws_units = _alias_columns_for_units(ws_units)
    units_df = _alias_columns_for_units(units_df)

    # 1) Top-10 most frequent clusters (requests by cluster)
    if ws_clusters is not None and 'Ù†Ø§Ù… Ø®ÙˆØ´Ù‡' in ws_clusters.columns:
        try:
            ccol = 'Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ø§' if 'Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ø§' in ws_clusters.columns else _safe_col(ws_clusters, ['Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ø§', 'Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ø§ '])
            if ccol is None:
                # try variants
                possible = [c for c in ws_clusters.columns if 'Ú©Ù„' in c and 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª' in c]
                ccol = possible[0] if possible else None
            if ccol is not None:
                top_clusters = ws_clusters.groupby('Ù†Ø§Ù… Ø®ÙˆØ´Ù‡')[ccol].sum().sort_values(ascending=False).head(10)
                total = top_clusters.sum()
                fig = px.bar(x=top_clusters.values, y=top_clusters.index, orientation='h', labels={'x': 'ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§', 'y': 'Ù†Ø§Ù… Ø®ÙˆØ´Ù‡'}, title='Ø¯Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø±ØªÚ©Ø±Ø§Ø± Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ùˆ Ø¯Ø±ØµØ¯ ÙØ±Ø§ÙˆØ§Ù†ÛŒ Ø¢Ù†Ù‡Ø§')
                # add percent annotations
                perc = (top_clusters / total * 100).round(1)
                for i, val in enumerate(top_clusters.values):
                    fig.add_annotation(dict(x=val, y=top_clusters.index[i], text=f"{perc.iloc[i]}%", showarrow=False, xanchor='left', xshift=6))
                st.plotly_chart(fig, use_container_width=True)
                _render_paragraph(
                    "ØªØ­Ù„ÛŒÙ„ Ø¯Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø±ØªÚ©Ø±Ø§Ø± Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ø§Ø±Ø§Ú©",
                    """
Ø§ÛŒÙ† Ù†Ù…ÙˆØ¯Ø§Ø± Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ú©Ø¯Ø§Ù… Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ ÛŒØ§ Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø­Ø¬Ù… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ Ø¯Ø± Ø§Ø±Ø§Ú© Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø±Ø¯Ù‡â€ŒØ§Ù†Ø¯ Ùˆ Ø¨Ù†Ø§Ø¨Ø±Ø§ÛŒÙ† Ú©Ø§Ù†ÙˆÙ†â€ŒÙ‡Ø§ÛŒ ØªÙ…Ø±Ú©Ø² ØªÙ‚Ø§Ø¶Ø§ Ú©Ø¬Ø§ Ù‡Ø³ØªÙ†Ø¯. ØªÙ…Ø±Ú©Ø² Ø¨Ø± Ø§ÛŒÙ† Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ø¨Ø§ ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§ÛŒ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø®ØªØµØ§ØµÛŒØŒ Ø¨Ù‡â€ŒÚ©Ø§Ø±Ú¯ÛŒØ±ÛŒ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ùˆ ØªÙˆØ³Ø¹Ù‡ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø³Ù„Ùâ€ŒØ³Ø±ÙˆÛŒØ³ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø§Ø± Ú©Ø§Ø±ÛŒ ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø±Ø§ Ú©Ø§Ù‡Ø´ Ø¯Ù‡Ø¯ Ùˆ Ú©ÛŒÙÛŒØª ØªØ¬Ø±Ø¨Ù‡ Ø¯Ø§Ù†Ø´Ø¬Ùˆ Ø±Ø§ Ø§Ø±ØªÙ‚Ø§ Ø¯Ù‡Ø¯. Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø³Ù‡Ù… Ù‡Ø± Ù…ÙˆØ¶ÙˆØ¹ Ø¯Ø± Ø¨Ø§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ø²Ù…Ø§Ù†ÛŒ Ù…Ø®ØªÙ„ÙØŒ ØªØ§Ø«ÛŒØ± Ù…Ø¯Ø§Ø®Ù„Ø§Øª Ø±Ø§ Ø±ÙˆØ´Ù† Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯ Ùˆ Ø¨Ù‡ Ø³ÛŒØ§Ø³Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± Ø´ÙˆØ§Ù‡Ø¯ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
                    """
                )
        except Exception:
            st.info('Ù†Ù…Ø§ÛŒØ´ Ù†Ù…ÙˆØ¯Ø§Ø± Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ Ù…Ù…Ú©Ù† Ù†Ø´Ø¯Ø› Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.')

    # 2) Supporters performance table (we have counts in 12.xlsx)
    if ws_sup is not None and ('Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ' in ws_sup.columns or 'Ù†Ø§Ù…' in ws_sup.columns):
        # standardize columns
        sup = ws_sup.copy()
        sup.columns = sup.columns.str.strip()
        # find total requests column
        tot_col = None
        for c in sup.columns:
            if 'Ú©Ù„' in c and 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª' in c:
                tot_col = c
                break
        closed_col = None
        for c in sup.columns:
            if 'Ø¨Ø³ØªÙ‡' in c or 'ØªÚ©Ù…ÛŒÙ„' in c:
                closed_col = c
                break
        # safely coerce to numeric
        if tot_col is not None:
            sup[tot_col] = pd.to_numeric(sup[tot_col], errors='coerce').fillna(0).astype(int)
        if closed_col is not None:
            sup[closed_col] = pd.to_numeric(sup[closed_col], errors='coerce').fillna(0).astype(int)
        # completion rate per supporter (proxy)
        if tot_col is not None:
            sup['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„_Ø­Ø§Ù…ÛŒ'] = (sup[closed_col].replace({0: 0}) / sup[tot_col].replace({0: np.nan}) * 100).round(1).fillna(0)
        else:
            sup['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„_Ø­Ø§Ù…ÛŒ'] = 0

        sup_sorted = sup.sort_values(by=tot_col if tot_col is not None else sup.columns[0], ascending=False).head(20)
        st.markdown('### ğŸ§‘â€ğŸ’» Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø­Ø§Ù…ÛŒØ§Ù† (Ø¬Ø¯ÙˆÙ„ Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§)')
        show_cols = []
        for col in ['Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ', 'Ø±Ø§ÛŒØ§Ù†Ø§Ù…Ù‡', tot_col, closed_col, 'Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„_Ø­Ø§Ù…ÛŒ']:
            if col and col in sup_sorted.columns and col not in show_cols:
                show_cols.append(col)
        if len(show_cols) == 0:
            st.write(sup_sorted.head(10))
        else:
            st.dataframe(sup_sorted[show_cols].rename(columns={tot_col: 'Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§', closed_col: 'Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡'}), use_container_width=True)
        _render_paragraph(
            "ØªØ­Ù„ÛŒÙ„ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø­Ø§Ù…ÛŒØ§Ù† Ø§Ø±Ø§Ú©",
            """
Ø¬Ø¯ÙˆÙ„ Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ø­Ø§Ù…ÛŒØ§Ù† Ø§Ø±Ø§Ú© Ø¨Ø§ ØªÙ…Ø±Ú©Ø² Ø¨Ø± Ø­Ø¬Ù… Ú©Ø§Ø± Ùˆ Ú©ÛŒÙÛŒØª Ù¾Ø§Ø³Ø®ØŒ Ù†Ù‚Ø§Ø· Ù‚ÙˆØª Ùˆ Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ø¨Ù‡Ø¨ÙˆØ¯ Ø±Ø§ Ù…Ø´Ø®Øµ Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ø¨Ø§Ù„Ø§ Ø¯Ø± Ú©Ù†Ø§Ø± Ø­Ø¬Ù… Ø²ÛŒØ§Ø¯ Ù…Ø·Ù„ÙˆØ¨ Ø§Ø³Øª Ùˆ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù‡â€ŒØ¹Ù†ÙˆØ§Ù† Ø§Ù„Ú¯ÙˆÛŒ Ø¨Ù‡ØªØ±ÛŒÙ† Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù…Ø¹Ø±ÙÛŒ Ø´ÙˆØ¯. Ø¯Ø± Ù…Ù‚Ø§Ø¨Ù„ØŒ Ù†Ø±Ø® Ø±Ø¯ Ø¨Ø§Ù„Ø§ Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ø¨Ø§Ø²Ù†Ú¯Ø±ÛŒ Ø¯Ø± ÙØ±Ø§ÛŒÙ†Ø¯Ù‡Ø§ØŒ ÙØ±Ù…â€ŒÙ‡Ø§ Ùˆ Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§Ø³Øª. Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ØµÙ Ù‡ÙˆØ´Ù…Ù†Ø¯ØŒ Ø³Ù‚Ù Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙØ¹Ø§Ù„ Ùˆ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ù†ØªÙˆØ±Ø´ÛŒÙ¾ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ØªÙˆØ§Ø²Ù† Ø¨Ø§Ø± Ø±Ø§ Ø¨Ù‡Ø¨ÙˆØ¯ Ø¯Ù‡Ø¯ Ùˆ Ú©ÛŒÙÛŒØª Ø±Ø§ ØªØ«Ø¨ÛŒØª Ú©Ù†Ø¯.
            """
        )

        # 3) Scatter: total requests vs completion rate (proxy for response efficiency)
        try:
            if tot_col is not None:
                fig2 = px.scatter(sup, x=tot_col, y='Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„_Ø­Ø§Ù…ÛŒ', hover_name=sup.get('Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ', None), size=sup.get(closed_col, None), title='Ø³Ø±Ø¹Øª Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ (Ù¾Ø±Ø§Ú©Ø³ÛŒ): ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ vs Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ø­Ø§Ù…ÛŒØ§Ù†')
                fig2.update_layout(xaxis_title='Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§', yaxis_title='Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ (%)')
                st.plotly_chart(fig2, use_container_width=True)
        except Exception:
            pass
        _render_paragraph(
            "ØªØ­Ù„ÛŒÙ„ Ù¾Ø±Ø§Ú©Ù†Ø¯Ú¯ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø­Ø§Ù…ÛŒØ§Ù† Ø§Ø±Ø§Ú©",
            """
Ø§ÛŒÙ† Ù†Ù…ÙˆØ¯Ø§Ø± Ø±Ø§Ø¨Ø·Ù‡ Ù…ÛŒØ§Ù† Ø­Ø¬Ù… Ú©Ø§Ø± Ùˆ Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ø­Ø§Ù…ÛŒØ§Ù† Ø§Ø±Ø§Ú© Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ùˆ Ù†Ù‚Ø§Ø· Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ù…Ø¯Ø§Ø®Ù„Ù‡ Ø±Ø§ Ø¨Ù‡â€ŒØ®ÙˆØ¨ÛŒ Ù†Ù…Ø§ÛŒØ§Ù† Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯. Ù†Ù‚Ø§Ø· Ø¨Ø§ Ø­Ø¬Ù… Ø¨Ø§Ù„Ø§ Ùˆ Ù†Ø±Ø® Ù¾Ø§ÛŒÛŒÙ†ØŒ Ø§ÙˆÙ„ÙˆÛŒØª Ø§ØµÙ„Ø§Ø­Ø§Øª Ù‡Ø³ØªÙ†Ø¯Ø› Ø¯Ø± Ø­Ø§Ù„ÛŒâ€ŒÚ©Ù‡ Ù†Ù‚Ø§Ø· Ø¨Ø§ Ø­Ø¬Ù… Ù¾Ø§ÛŒÛŒÙ† Ùˆ Ù†Ø±Ø® Ø¨Ø§Ù„Ø§ Ø¸Ø±ÙÛŒØª Ø±Ø´Ø¯ Ø¯Ø§Ø±Ù†Ø¯. Ø±ØµØ¯ Ø¬Ø§Ø¨Ù‡â€ŒØ¬Ø§ÛŒÛŒ Ù†Ù‚Ø§Ø· Ø¯Ø± Ø·ÙˆÙ„ Ø²Ù…Ø§Ù†ØŒ Ø§Ø«Ø± Ø¢Ù…ÙˆØ²Ø´â€ŒÙ‡Ø§ØŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ø³Ø§Ø²ÛŒ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ Ùˆ Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ØªÙˆØ²ÛŒØ¹ Ø¨Ø§Ø± Ø±Ø§ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø¹ÛŒÙ†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.
            """
        )

        # 4) Distribution plots for available numeric summaries
        st.markdown('### ğŸ“ˆ ØªÙˆØ²ÛŒØ¹ Ø¢Ù…Ø§Ø±ÛŒ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¯Ø± Ø¯Ø³ØªØ±Ø³')
        num_cols = []
        for c in sup.columns:
            if sup[c].dtype.kind in 'biufc' and c in [tot_col, closed_col, 'Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„_Ø­Ø§Ù…ÛŒ']:
                num_cols.append(c)
        try:
            if len(num_cols) > 0:
                fig3 = make_subplots(rows=1, cols=len(num_cols), subplot_titles=[c for c in num_cols])
                for i, c in enumerate(num_cols):
                    hist = np.histogram(sup[c].dropna(), bins=20)
                    fig3.add_trace(go.Bar(x=hist[1][:-1], y=hist[0], name=c), row=1, col=i+1)
                fig3.update_layout(height=350)
                st.plotly_chart(fig3, use_container_width=True)
        except Exception:
            pass
        _render_paragraph(
            "ØªØ­Ù„ÛŒÙ„ ØªÙˆØ²ÛŒØ¹ Ø¢Ù…Ø§Ø±ÛŒ Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ÛŒ Ø­Ø§Ù…ÛŒØ§Ù† Ø§Ø±Ø§Ú©",
            """
Ù‡ÛŒØ³ØªÙˆÚ¯Ø±Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒØŒ Ø´Ú©Ù„ ØªÙˆØ²ÛŒØ¹ Ùˆ ÙˆØ¬ÙˆØ¯ Ø¯Ù… Ø¨Ù„Ù†Ø¯ ÛŒØ§ Ù†Ù‚Ø§Ø· Ù¾Ø±Øª Ø±Ø§ Ø¢Ø´Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯. Ø§ÛŒÙ† Ø¢Ú¯Ø§Ù‡ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ¹ÛŒÛŒÙ† Ø¢Ø³ØªØ§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ù‡Ø´Ø¯Ø§Ø±ØŒ Ø·Ø±Ø§Ø­ÛŒ Ù…Ø¯Ø§Ø®Ù„Ø§Øª Ù‡Ø¯ÙÙ…Ù†Ø¯ Ùˆ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø«Ø±Ø¨Ø®Ø´ÛŒ Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ù¾Ø³ Ø§Ø² Ø§Ø¬Ø±Ø§ Ø¶Ø±ÙˆØ±ÛŒ Ø§Ø³Øª. Ù‡Ø¯Ù Ø±Ø§Ù‡Ø¨Ø±Ø¯ÛŒ Ú©Ø§Ù‡Ø´ Ù¾Ø±Ø§Ú©Ù†Ø¯Ú¯ÛŒ Ù†Ø§Ù…Ø·Ù„ÙˆØ¨ Ùˆ Ø§Ø±ØªÙ‚Ø§ÛŒ Ù…ÛŒØ§Ù†Ù‡ Ùˆ Ú†Ø§Ø±Ú©â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù„Ø§ÛŒÛŒ Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ø§Ø³Øª.
            """
        )

def create_comprehensive_insights(supporters_df, units_df, clusters_df):
    """ØªØ­Ù„ÛŒÙ„ Ø¬Ø§Ù…Ø¹ Ùˆ Ø¨ÛŒÙ†Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒÚ©"""
    st.markdown("## ğŸ” Ø¨ÛŒÙ†Ø´â€ŒÙ‡Ø§ÛŒ Ø¬Ø§Ù…Ø¹ Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒÚ©")
    
    # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒØ¯ÛŒ
    active_supporters = len(supporters_df[supporters_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'] > 0])
    inactive_supporters = len(supporters_df[supporters_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'] == 0])
    # Ù…Ø­Ø§ÙØ¸Øª Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ù…Ø´ØªÙ‚â€ŒØ´Ø¯Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù‚Ø¨Ù„Ø§Ù‹ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ù†Ø¯
    units_df = units_df.copy()
    # Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªÙ‚Ø³ÛŒÙ… Ø¨Ø± ØµÙØ±
    if 'Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„' not in units_df.columns or units_df['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„'].isnull().any():
        safe_total = units_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'].replace({0: np.nan})
        units_df['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„'] = (units_df['Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡'] / safe_total * 100).round(1).fillna(0)
    if 'Ù†Ø±Ø®_Ø±Ø¯' not in units_df.columns or units_df['Ù†Ø±Ø®_Ø±Ø¯'].isnull().any():
        safe_total = units_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'].replace({0: np.nan})
        units_df['Ù†Ø±Ø®_Ø±Ø¯'] = (units_df['Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø±Ø¯_Ø´Ø¯Ù‡'] / safe_total * 100).round(1).fillna(0)
    if 'Ù†Ø§Ù…_Ú©ÙˆØªØ§Ù‡' not in units_df.columns:
        units_df['Ù†Ø§Ù…_Ú©ÙˆØªØ§Ù‡'] = units_df.get('Ù†Ø§Ù…_ÙˆØ§Ø­Ø¯', '').astype(str).str.split('-').str[0]

    # Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ú©Ù„ÛŒ Ø§Ø³ØªØ§Ù†
    total_completion_rate = (units_df['Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡'].sum() / units_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'].sum() * 100)
    # Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ù‡ØªØ±ÛŒÙ†/Ø¶Ø¹ÛŒÙâ€ŒØªØ±ÛŒÙ† ÙˆØ§Ø­Ø¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„
    # Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ù‡ Ù‡Ù…Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± ØµÙØ± Ø¨Ø§Ø´Ù†Ø¯ØŒ Ø§Ø² idxmax/idxmin Ù…Ø­Ø§ÙØ¸Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    if units_df['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„'].count() == 0 or units_df['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„'].sum() == 0:
        best_unit = units_df.iloc[0] if len(units_df) > 0 else pd.Series()
        worst_unit = units_df.iloc[0] if len(units_df) > 0 else pd.Series()
    else:
        best_unit = units_df.loc[units_df['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„'].idxmax()]
        worst_unit = units_df.loc[units_df['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„'].idxmin()]
    
    # Ù†Ù‚Ø§Ø· Ù‚ÙˆØª
    st.markdown("""
    <div class="insight-box">
    <h3>âœ… Ù†Ù‚Ø§Ø· Ù‚ÙˆØª Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯Ù‡</h3>
    <ul>
    <li><strong>Ø¹Ù…Ù„Ú©Ø±Ø¯ Ú©Ù„ÛŒ Ù…Ø·Ù„ÙˆØ¨:</strong> Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ {:.1f}% Ú©Ù‡ Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² Ù‡Ø¯Ù 90% Ø§Ø³Øª</li>
    <li><strong>ÙˆØ§Ø­Ø¯ Ø§Ø±Ø§Ú©:</strong> Ø¨Ø§ {:.1f}% Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ø¹Ù„ÛŒâ€ŒØ±ØºÙ… Ø­Ø¬Ù… Ø¨Ø§Ù„Ø§ÛŒ Ú©Ø§Ø± ({:,} Ø¯Ø§Ù†Ø´Ø¬Ùˆ)</li>
    <li><strong>Ø­Ø§Ù…ÛŒØ§Ù† Ù…ØªØ®ØµØµ:</strong> {} Ø­Ø§Ù…ÛŒ ÙØ¹Ø§Ù„ Ø¨Ø§ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¨Ø§Ù„Ø§</li>
    <li><strong>Ù¾ÙˆØ´Ø´ Ø¬Ø§Ù…Ø¹:</strong> {:,} Ø®ÙˆØ´Ù‡ ØªØ­ØµÛŒÙ„ÛŒ Ø¯Ø± ØªÙ…Ø§Ù… Ù…Ù‚Ø§Ø·Ø¹</li>
    <li><strong>Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ Ø³Ø±ÛŒØ¹:</strong> Ø¨ÛŒØ´ØªØ± Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¯Ø± Ú©Ù…ØªØ± Ø§Ø² 48 Ø³Ø§Ø¹Øª Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</li>
    </ul>
    </div>
    """.format(
        total_completion_rate,
        best_unit['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„'],
        best_unit['ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†'],
        active_supporters,
        len(clusters_df)
    ), unsafe_allow_html=True)
    
    # Ú†Ø§Ù„Ø´â€ŒÙ‡Ø§ Ùˆ Ù†Ù‚Ø§Ø· Ø¶Ø¹Ù
    st.markdown("""
    <div class="warning-box">
    <h3>âš ï¸ Ú†Ø§Ù„Ø´â€ŒÙ‡Ø§ Ùˆ Ù†Ù‚Ø§Ø· Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ø¨Ù‡Ø¨ÙˆØ¯</h3>
    <ul>
    <li><strong>Ù†Ø§Ø¨Ø±Ø§Ø¨Ø±ÛŒ Ø¨Ø§Ø± Ú©Ø§Ø±ÛŒ:</strong> {} Ø­Ø§Ù…ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ ({:.1f}% Ø§Ø² Ú©Ù„) Ø¯Ø± Ù…Ù‚Ø§Ø¨Ù„ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù…ÛŒ Ø­Ø§Ù…ÛŒ Ù¾Ø±Ú©Ø§Ø±</li>
    <li><strong>Ø´Ú©Ø§Ù Ø¹Ù…Ù„Ú©Ø±Ø¯:</strong> ØªÙØ§ÙˆØª {:.1f}% Ø¨ÛŒÙ† Ø¨Ù‡ØªØ±ÛŒÙ† Ùˆ Ø¶Ø¹ÛŒÙâ€ŒØªØ±ÛŒÙ† ÙˆØ§Ø­Ø¯</li>
    <li><strong>ØªÙ…Ø±Ú©Ø² Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯:</strong> 20% Ø­Ø§Ù…ÛŒØ§Ù† Ø¨Ø±ØªØ±ØŒ 70% Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯</li>
    <li><strong>ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ú©ÙˆÚ†Ú©:</strong> Ø¨Ø±Ø®ÛŒ ÙˆØ§Ø­Ø¯Ù‡Ø§ Ù†Ø±Ø® Ø±Ø¯ Ø¨Ø§Ù„Ø§ÛŒÛŒ Ø¯Ø§Ø±Ù†Ø¯ Ú©Ù‡ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø§Ø±Ø¯</li>
    <li><strong>Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„:</strong> {:,} Ø®ÙˆØ´Ù‡ Ø¨Ø¯ÙˆÙ† Ù‡ÛŒÚ† Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ</li>
    </ul>
    </div>
    """.format(
        inactive_supporters,
        (inactive_supporters / len(supporters_df) * 100),
        (best_unit['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„'] - worst_unit['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„']),
        len(clusters_df[clusters_df['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'] == 0])
    ), unsafe_allow_html=True)
    
    # Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒÚ©
    st.markdown("### ğŸ¯ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒÚ©")
    
    tab1, tab2, tab3 = st.tabs(["ğŸš€ Ú©ÙˆØªØ§Ù‡â€ŒÙ…Ø¯Øª (1-3 Ù…Ø§Ù‡)", "ğŸ“ˆ Ù…ÛŒØ§Ù†â€ŒÙ…Ø¯Øª (3-6 Ù…Ø§Ù‡)", "ğŸ”® Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª (6-12 Ù…Ø§Ù‡)"])
    
    with tab1:
        st.markdown("""
        <div class="recommendation-box">
        <h4>ğŸš€ Ø§Ù‚Ø¯Ø§Ù…Ø§Øª ÙÙˆØ±ÛŒ (1-3 Ù…Ø§Ù‡)</h4>
        <ol>
        <li><strong>ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø­Ø§Ù…ÛŒØ§Ù† ØºÛŒØ±ÙØ¹Ø§Ù„</strong>
           <ul>
           <li>Ø¨Ø±Ú¯Ø²Ø§Ø±ÛŒ Ø¬Ù„Ø³Ø§Øª Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø¨Ø±Ø§ÛŒ {} Ø­Ø§Ù…ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„</li>
           <li>Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ù„Ø§ÛŒÙ„ Ø¹Ø¯Ù… ÙØ¹Ø§Ù„ÛŒØª Ùˆ Ø±ÙØ¹ Ù…ÙˆØ§Ù†Ø¹</li>
           <li>ØªØ¹ÛŒÛŒÙ† Ù‡Ø¯Ù Ø­Ø¯Ø§Ù‚Ù„ÛŒ 10 Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø­Ø§Ù…ÛŒ</li>
           </ul>
        </li>
        
        <li><strong>Ø¨Ø§Ø²ØªÙˆØ²ÛŒØ¹ Ø¨Ø§Ø± Ú©Ø§Ø±ÛŒ</strong>
           <ul>
           <li>Ø§Ù†ØªÙ‚Ø§Ù„ 20% Ø§Ø² Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø­Ø§Ù…ÛŒØ§Ù† Ù¾Ø±Ú©Ø§Ø± Ø¨Ù‡ Ø³Ø§ÛŒØ±ÛŒÙ†</li>
           <li>Ø§ÛŒØ¬Ø§Ø¯ Ø³ÛŒØ³ØªÙ… ØµÙ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø±Ø§ÛŒ ØªÙˆØ²ÛŒØ¹ Ù…ØªØ¹Ø§Ø¯Ù„</li>
           <li>ØªØ¹Ø±ÛŒÙ Ø³Ù‚Ù Ø­Ø¯Ø§Ú©Ø«Ø±ÛŒ 200 Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙØ¹Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø­Ø§Ù…ÛŒ</li>
           </ul>
        </li>
        
        <li><strong>Ø¨Ù‡Ø¨ÙˆØ¯ Ø¹Ù…Ù„Ú©Ø±Ø¯ ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ø¶Ø¹ÛŒÙ</strong>
           <ul>
           <li>Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ù…ÛŒÙ‚ ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒÛŒ Ø¨Ø§ Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ú©Ù…ØªØ± Ø§Ø² 90%</li>
           <li>Ø§Ø¹Ø²Ø§Ù… ØªÛŒÙ… Ù…Ø´Ø§ÙˆØ±Ø§Ù† Ø¨Ù‡ ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ù†ÛŒØ§Ø²Ù…Ù†Ø¯</li>
           <li>Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø³ÛŒØ³ØªÙ… Ù†Ø¸Ø§Ø±Øª Ù‡ÙØªÚ¯ÛŒ</li>
           </ul>
        </li>
        </ol>
        </div>
        """.format(inactive_supporters), unsafe_allow_html=True)
    
    with tab2:
        st.markdown("""
        <div class="recommendation-box">
        <h4>ğŸ“ˆ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ù…ÛŒØ§Ù†â€ŒÙ…Ø¯Øª (3-6 Ù…Ø§Ù‡)</h4>
        <ol>
        <li><strong>Ø§ÛŒØ¬Ø§Ø¯ Ø³ÛŒØ³ØªÙ… Ù…Ù†ØªÙˆØ±Ø´ÛŒÙ¾</strong>
           <ul>
           <li>Ø¬ÙØªâ€ŒØ³Ø§Ø²ÛŒ Ø­Ø§Ù…ÛŒØ§Ù† Ø¨Ø±ØªØ± Ø¨Ø§ Ø¶Ø¹ÛŒÙâ€ŒØªØ±Ù‡Ø§</li>
           <li>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¯Ø§Ù†Ø´ Ùˆ ØªØ¬Ø±Ø¨Ù‡</li>
           <li>Ø¬Ù„Ø³Ø§Øª Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯</li>
           </ul>
        </li>
        
        <li><strong>ØªÙˆØ³Ø¹Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù†Ø¸Ø§Ø±ØªÛŒ</strong>
           <ul>
           <li>Ø³ÛŒØ³ØªÙ… Ù‡Ø´Ø¯Ø§Ø± Ø¢Ù†Ù„Ø§ÛŒÙ† Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¹Ø·Ù„</li>
           <li>Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¹Ù…Ù„Ú©Ø±Ø¯</li>
           <li>Ù†Ù…Ø§ÛŒØ´ Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ ÙˆØ§Ø­Ø¯Ù‡Ø§ Ùˆ Ø­Ø§Ù…ÛŒØ§Ù†</li>
           </ul>
        </li>
        
        <li><strong>Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ø³Ø§Ø²ÛŒ ÙØ±Ø¢ÛŒÙ†Ø¯Ù‡Ø§</strong>
           <ul>
           <li>ØªÙ‡ÛŒÙ‡ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¬Ø§Ù…Ø¹ Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ</li>
           <li>Ø§ÛŒØ¬Ø§Ø¯ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡</li>
           <li>ØªØ¹Ø±ÛŒÙ SLA Ø¨Ø±Ø§ÛŒ Ø§Ù†ÙˆØ§Ø¹ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§</li>
           </ul>
        </li>
        </ol>
        </div>
        """, unsafe_allow_html=True)
    
    with tab3:
        st.markdown("""
        <div class="recommendation-box">
        <h4>ğŸ”® Ú†Ø´Ù…â€ŒØ§Ù†Ø¯Ø§Ø² Ø¨Ù„Ù†Ø¯Ù…Ø¯Øª (6-12 Ù…Ø§Ù‡)</h4>
        <ol>
        <li><strong>Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ùˆ Ø®ÙˆØ¯Ú©Ø§Ø±Ø³Ø§Ø²ÛŒ</strong>
           <ul>
           <li>Ø³ÛŒØ³ØªÙ… ØªØ´Ø®ÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø± Ù†ÙˆØ¹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</li>
           <li>Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„</li>
           <li>Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø­Ø¬Ù… Ú©Ø§Ø± Ùˆ ØªØ®ØµÛŒØµ Ù…Ù†Ø§Ø¨Ø¹</li>
           </ul>
        </li>
        
        <li><strong>Ø³ÛŒØ³ØªÙ… Ø¬Ø§Ù…Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ø¹Ù…Ù„Ú©Ø±Ø¯</strong>
           <ul>
           <li>KPI Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ùˆ Ù…ØªØ±ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ú©ÛŒÙÛŒ</li>
           <li>Ø³ÛŒØ³ØªÙ… Ø§Ù…ØªÛŒØ§Ø²Ø¯Ù‡ÛŒ Ùˆ ØªØ´ÙˆÛŒÙ‚</li>
           <li>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§Ø±ØªÙ‚Ø§Ø¡ Ø´ØºÙ„ÛŒ Ù…Ø¨ØªÙ†ÛŒ Ø¨Ø± Ø¹Ù…Ù„Ú©Ø±Ø¯</li>
           </ul>
        </li>
        
        <li><strong>ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§</strong>
           <ul>
           <li>Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø§ÛŒØ± Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡</li>
           <li>Ù¾ÙˆØ±ØªØ§Ù„ ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒ</li>
           <li>Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ú†Ù†Ø¯Ø³Ø·Ø­Ù‡</li>
           </ul>
        </li>
        </ol>
        </div>
        """, unsafe_allow_html=True)
    
    # Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ ØªØ£Ø«ÛŒØ±Ø§Øª
    st.markdown("### ğŸ“Š Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ ØªØ£Ø«ÛŒØ±Ø§Øª Ø§Ø¬Ø±Ø§ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª")
    
    impact_data = {
        'Ø´Ø§Ø®Øµ Ø¹Ù…Ù„Ú©Ø±Ø¯': [
            'Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ú©Ù„ÛŒ',
            'Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†', 
            'Ø±Ø¶Ø§ÛŒØª Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†',
            'Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ Ø­Ø§Ù…ÛŒØ§Ù†',
            'ØªØ¹Ø§Ø¯Ù„ Ø¨Ø§Ø± Ú©Ø§Ø±ÛŒ',
            'Ú©ÛŒÙÛŒØª Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§'
        ],
        'ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ': ['94.2%', '36 Ø³Ø§Ø¹Øª', '75%', '65%', '40%', '70%'],
        'Ù‡Ø¯Ù 6 Ù…Ø§Ù‡Ù‡': ['97%', '24 Ø³Ø§Ø¹Øª', '85%', '80%', '75%', '85%'],
        'Ù‡Ø¯Ù 1 Ø³Ø§Ù„Ù‡': ['98.5%', '12 Ø³Ø§Ø¹Øª', '92%', '90%', '90%', '95%'],
        'Ø¯Ø±ØµØ¯ Ø¨Ù‡Ø¨ÙˆØ¯': ['+4.3%', '-67%', '+17%', '+25%', '+50%', '+25%']
    }
    
    impact_df = pd.DataFrame(impact_data)
    st.dataframe(impact_df, use_container_width=True, hide_index=True)

def create_arak_detailed_report(supporters_df, units_df, clusters_df):
    """ØªØ­Ù„ÛŒÙ„ ÙˆÛŒÚ˜Ù‡ Ùˆ ØªÙÚ©ÛŒÚ©ÛŒ ÙˆØ§Ø­Ø¯ Ø§Ø±Ø§Ú© Ø¨Ø§ Ú¯Ø²Ø§Ø±Ø´ Ù…ØªÙ†ÛŒ Ù…ÙØµÙ„ (â‰ˆ25 Ø®Ø· Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¨Ø®Ø´)."""
    st.markdown("## ğŸ“Œ ØªØ­Ù„ÛŒÙ„ ÙˆÛŒÚ˜Ù‡ ÙˆØ§Ø­Ø¯ Ø§Ø±Ø§Ú© (Ú©Ø§Ù…Ù„)")

    # ÙÛŒÙ„ØªØ± Ø§ÛŒÙ…Ù† Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø§Ú© Ø¯Ø± Ø¬Ø¯Ø§ÙˆÙ„ Ø¯Ø± Ø¯Ø³ØªØ±Ø³
    def _contains_arÄk(val: str) -> bool:
        try:
            s = str(val)
            return 'Ø§Ø±Ø§Ú©' in s or 'Arak' in s or 'arak' in s
        except Exception:
            return False

    # ÙˆØ§Ø­Ø¯ Ø§Ø±Ø§Ú© Ø§Ø² units_df
    arak_row = None
    if units_df is not None and not getattr(units_df, 'empty', True):
        try:
            mask = units_df['Ù†Ø§Ù…_ÙˆØ§Ø­Ø¯'].astype(str).apply(_contains_arÄk) if 'Ù†Ø§Ù…_ÙˆØ§Ø­Ø¯' in units_df.columns else pd.Series([False]*len(units_df))
        except Exception:
            mask = pd.Series([False]*len(units_df))
        if mask.any():
            arak_row = units_df[mask].iloc[0]
        elif 'Ú©Ø¯_ÙˆØ§Ø­Ø¯' in units_df.columns:
            # Ú©Ø¯ Ø±Ø§ÛŒØ¬ Ø§Ø±Ø§Ú© 121
            try:
                mask2 = units_df['Ú©Ø¯_ÙˆØ§Ø­Ø¯'].astype(str).str.contains('121', na=False)
                if mask2.any():
                    arak_row = units_df[mask2].iloc[0]
            except Exception:
                pass

    # Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø§Ú©: ØªØ±Ø¬ÛŒØ­ Ø¨Ø§ Ø¯Ø§Ø¯Ù‡ Ø¢Ù¾Ù„ÙˆØ¯ÛŒ Ùˆ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø§Ù†Ø¹Ø·Ø§Ùâ€ŒÙ¾Ø°ÛŒØ± Ø³ØªÙˆÙ† ÙˆØ§Ø­Ø¯
    def _normalize_cols(df: pd.DataFrame) -> pd.DataFrame:
        try:
            cols = []
            for c in df.columns:
                s = str(c).strip()
                s = s.replace('\u00A0', ' ')
                s = s.replace('\u200C', '')
                s = s.replace('-', '_')
                s = s.replace(' ', '_')
                s = s.replace('__', '_')
                cols.append(s)
            df = df.copy()
            df.columns = cols
            return df
        except Exception:
            return df

    def _find_col(df: pd.DataFrame, candidates: list[str]) -> str | None:
        if df is None:
            return None
        names = list(df.columns)
        # Ø¯Ù‚ÛŒÙ‚
        for cand in candidates:
            if cand in names:
                return cand
        # ØªØ·Ø¨ÛŒÙ‚ ØªÙˆÚ©Ù†ÛŒ Ø³Ø§Ø¯Ù‡
        for col in names:
            low = str(col).replace('_','').lower()
            for cand in candidates:
                if all(tok in low for tok in cand.replace('_','').lower().split()):
                    return col
        return None

    src_clusters = st.session_state.get('uploaded_clusters_df', None)
    clusters_arak = None
    if src_clusters is not None and not getattr(src_clusters, 'empty', True):
        src_clusters = _normalize_cols(src_clusters)
        unit_col = _find_col(src_clusters, ['ÙˆØ§Ø­Ø¯','Ù†Ø§Ù…_ÙˆØ§Ø­Ø¯','unit','unit_name','unitname'])
        # Ø§Ú¯Ø± Ø³ØªÙˆÙ† Ù…Ø´Ø®Øµ Ù†Ø´Ø¯ØŒ Ø³ØªÙˆÙ† Ø§ÙˆÙ„ Ø±Ø§ Ù…Ø¨Ù†Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ… (Ù…Ø·Ø§Ø¨Ù‚ ØªÙˆØ¶ÛŒØ­ Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ 13.xlsx)
        if unit_col is None and len(src_clusters.columns) > 0:
            unit_col = src_clusters.columns[0]
        if unit_col is not None:
            try:
                clusters_arak = src_clusters[src_clusters[unit_col].astype(str).apply(_contains_arÄk)].copy()
            except Exception:
                clusters_arak = src_clusters.copy()
    # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ Ù…Ø­Ù„ÛŒ Â«Ú¯Ø²Ø§Ø±Ø´ Ø®ÙˆØ´Ù‡ Ù‡Ø§ÛŒ Ø§Ø³ØªØ§Ù†.xlsxÂ» Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ù„Ø§
    if (clusters_arak is None or getattr(clusters_arak, 'empty', True)):
        try:
            workspace = os.path.abspath(os.path.dirname(__file__))
            candidates = [
                os.path.join(workspace, 'Ú¯Ø²Ø§Ø±Ø´ Ø®ÙˆØ´Ù‡ Ù‡Ø§ÛŒ Ø§Ø³ØªØ§Ù†.xlsx'),
                os.path.join(workspace, 'Ú¯Ø²Ø§Ø±Ø´_Ø®ÙˆØ´Ù‡_Ù‡Ø§ÛŒ_Ø§Ø³ØªØ§Ù†.xlsx'),
                os.path.join(workspace, '13.xlsx'),
            ]
            for path in candidates:
                if os.path.exists(path):
                    try:
                        df_try = pd.read_excel(path)
                    except Exception:
                        # Ø§Ú¯Ø± Ø³Ø·Ø± Ø§ÙˆÙ„ Ù‡Ø¯Ø± Ù†Ø¨Ø§Ø´Ø¯
                        df_try = pd.read_excel(path, header=None)
                        # Ø§Ø±ØªÙ‚Ø§ÛŒ Ø±Ø¯ÛŒÙ Ø§ÙˆÙ„ Ø¨Ù‡ Ù‡Ø¯Ø± Ø¯Ø± ØµÙˆØ±Øª Ø§Ù…Ú©Ø§Ù†
                        if df_try.shape[0] > 1:
                            df_try.columns = df_try.iloc[0].astype(str)
                            df_try = df_try.iloc[1:].reset_index(drop=True)
                    df_try = _normalize_cols(df_try)
                    unit_col = _find_col(df_try, ['ÙˆØ§Ø­Ø¯','Ù†Ø§Ù…_ÙˆØ§Ø­Ø¯','unit','unit_name','unitname'])
                    if unit_col is None and df_try.shape[1] >= 2:
                        # ØªÙ„Ø§Ø´ Ù†Ù‡Ø§ÛŒÛŒ: Ø¬Ø³Øªâ€ŒÙˆØ¬ÙˆÛŒ Ø³ØªÙˆÙ†ÛŒ Ú©Ù‡ Ø´Ø§Ù…Ù„ ÙˆØ§Ú˜Ù‡ Ø§Ø±Ø§Ú© Ø¯Ø± Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¨Ø§Ø´Ø¯
                        for c in df_try.columns:
                            try:
                                if df_try[c].astype(str).apply(_contains_arÄk).any():
                                    unit_col = c
                                    break
                            except Exception:
                                continue
                    # Ø§Ú¯Ø± Ù‡Ù…Ú†Ù†Ø§Ù† Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ø·Ø¨Ù‚ Ø¯Ø³ØªÙˆØ± Ø´Ù…Ø§ Ø³ØªÙˆÙ† Ø§ÙˆÙ„ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø³ØªÙˆÙ†ÛŒ Ú©Ù‡ ÙˆØ§Ø­Ø¯/Ù†Ø§Ù… Ø±Ø§ Ø¯Ø§Ø±Ø¯ ÙØ±Ø¶ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                    if unit_col is None and len(df_try.columns) > 0:
                        unit_col = df_try.columns[0]
                    if unit_col is not None:
                        try:
                            candidate = df_try[df_try[unit_col].astype(str).apply(_contains_arÄk)].copy()
                            if not candidate.empty:
                                clusters_arak = candidate
                                break
                        except Exception:
                            clusters_arak = df_try.copy()
                            break
        except Exception:
            pass
    if clusters_arak is None:
        tmp = clusters_df.copy() if clusters_df is not None else pd.DataFrame()
        tmp = _normalize_cols(tmp) if not getattr(tmp, 'empty', True) else tmp
        unit_col = _find_col(tmp, ['ÙˆØ§Ø­Ø¯','Ù†Ø§Ù…_ÙˆØ§Ø­Ø¯','unit','unit_name','unitname'])
        if unit_col is not None and not getattr(tmp, 'empty', True):
            try:
                clusters_arak = tmp[tmp[unit_col].astype(str).apply(_contains_arÄk)].copy()
            except Exception:
                clusters_arak = tmp.copy()
        else:
            clusters_arak = tmp

    # Ø­Ø§Ù…ÛŒØ§Ù† Ø§Ø±Ø§Ú©: Ø§Ú¯Ø± Ù†Ø´Ø§Ù†Ù‡â€ŒØ§ÛŒ Ø§Ø² ØªØ¹Ù„Ù‚ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ù…Ø­Ø§ÙØ¸Ù‡â€ŒÚ©Ø§Ø±Ø§Ù†Ù‡ Ø¨Ø§ Ø§Ù„Ú¯ÙˆÛŒ Ø§ÛŒÙ…ÛŒÙ„ Ø´Ø§Ù…Ù„ 121 ÙÛŒÙ„ØªØ± Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…Ø› Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ†â€ŒØµÙˆØ±Øª Ú©Ù„ Ø±Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
    supporters_arak = supporters_df.copy() if supporters_df is not None else pd.DataFrame()
    if not getattr(supporters_arak, 'empty', True) and 'Ø±Ø§ÛŒØ§Ù†Ø§Ù…Ù‡' in supporters_arak.columns:
        try:
            cand = supporters_arak[supporters_arak['Ø±Ø§ÛŒØ§Ù†Ø§Ù…Ù‡'].astype(str).str.contains('121', na=False)]
            if len(cand) >= 3:
                supporters_arak = cand
        except Exception:
            pass

    # Ø¨Ø®Ø´ 1: Ø­Ø§Ù…ÛŒØ§Ù† Ø§Ø±Ø§Ú©
    st.markdown("### ğŸ‘¥ Ø­Ø§Ù…ÛŒØ§Ù† ÙˆØ§Ø­Ø¯ Ø§Ø±Ø§Ú©")
    if not getattr(supporters_arak, 'empty', True):
        # Ø§ÛŒÙ…Ù†â€ŒØ³Ø§Ø²ÛŒ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø¹Ø¯Ø¯ÛŒ
        for _c in ['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§', 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡', 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø±Ø¯_Ø´Ø¯Ù‡']:
            if _c in supporters_arak.columns:
                supporters_arak[_c] = pd.to_numeric(supporters_arak[_c], errors='coerce').fillna(0)
        top_n = min(10, len(supporters_arak))
        if 'Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§' in supporters_arak.columns:
            top_sup = supporters_arak[supporters_arak['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'] > 0].nlargest(top_n, 'Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§').copy()
        else:
            top_sup = supporters_arak.head(top_n).copy()

        if 'Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§' in top_sup.columns and 'Ù†Ø§Ù…_Ù†Ù…Ø§ÛŒØ´ÛŒ' in top_sup.columns:
            fig_sup = px.bar(top_sup, y='Ù†Ø§Ù…_Ù†Ù…Ø§ÛŒØ´ÛŒ', x='Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§', orientation='h', title='Û±Û° Ø­Ø§Ù…ÛŒ Ù¾Ø±ØªØ±Ø§ÙÛŒÚ© Ø§Ø±Ø§Ú©', color='Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§', color_continuous_scale='viridis')
            fig_sup.update_layout(yaxis={'categoryorder':'total ascending'})
            st.plotly_chart(fig_sup, use_container_width=True)

        # Ø¬Ø¯ÙˆÙ„ Ø¹Ù…Ù„Ú©Ø±Ø¯
        if 'Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§' in top_sup.columns:
            safe_total = top_sup['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§'].replace({0: np.nan})
            top_sup['Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„'] = ((top_sup.get('Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡', 0) / safe_total) * 100).round(1).fillna(0)
            top_sup['Ù†Ø±Ø®_Ø±Ø¯'] = ((top_sup.get('Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø±Ø¯_Ø´Ø¯Ù‡', 0) / safe_total) * 100).round(1).fillna(0)
        show_cols = [c for c in ['Ù†Ø§Ù…_Ù†Ù…Ø§ÛŒØ´ÛŒ','Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§','Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡','Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø±Ø¯_Ø´Ø¯Ù‡','Ù†Ø±Ø®_ØªÚ©Ù…ÛŒÙ„','Ù†Ø±Ø®_Ø±Ø¯'] if c in top_sup.columns]
        if show_cols:
            st.dataframe(top_sup[show_cols], use_container_width=True, hide_index=True)

        _render_paragraph(
            "Ú¯Ø²Ø§Ø±Ø´ ØªÙØµÛŒÙ„ÛŒ Ø­Ø§Ù…ÛŒØ§Ù† Ø§Ø±Ø§Ú©",
            """
Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ù‡ ØµÙˆØ±Øª Ø§Ø®ØªØµØ§ØµÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø­Ø§Ù…ÛŒØ§Ù† Ù…Ø±ØªØ¨Ø· Ø¨Ø§ ÙˆØ§Ø­Ø¯ Ø§Ø±Ø§Ú© Ø±Ø§ ÙˆØ§Ú©Ø§ÙˆÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯. ØªÙ…Ø±Ú©Ø² Ø¨Ø± Ø¯Ù‡ Ø­Ø§Ù…ÛŒ Ù¾Ø±ØªØ±Ø§ÙÛŒÚ© Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ù†Ù‚Ø§Ø· ÙØ´Ø§Ø± Ùˆ ÙØ±ØµØªâ€ŒÙ‡Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´ÙˆØ¯. Ø§Ú¯Ø± ÙØ§ØµÙ„Ù‡ Ù…ÛŒØ§Ù† Ù†ÙØ±Ø§Øª Ø§ÙˆÙ„ ØªØ§ Ø³Ø§ÛŒØ±ÛŒÙ† Ø²ÛŒØ§Ø¯ Ø¨Ø§Ø´Ø¯ØŒ Ø®Ø·Ø± Ø§ØªÚ©Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ø¨Ù‡ Ø§ÙØ±Ø§Ø¯ Ù…Ø­Ø¯ÙˆØ¯ Ø§ÙØ²Ø§ÛŒØ´ Ù…ÛŒâ€ŒÛŒØ§Ø¨Ø¯ Ùˆ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒÛŒ Ù…Ø§Ù†Ù†Ø¯ Ø³Ù‚Ù Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙØ¹Ø§Ù„ Ùˆ Ø§Ø±Ø¬Ø§Ø¹ Ù‡ÙˆØ´Ù…Ù†Ø¯ØŒ Ø±ÛŒØ³Ú© Ø±Ø§ Ú©Ù†ØªØ±Ù„ Ú©Ø±Ø¯. Ù…Ù‚Ø§ÛŒØ³Ù‡ Ù‡Ù…Ø²Ù…Ø§Ù† Ø­Ø¬Ù… Ú©Ø§Ø± Ø¨Ø§ Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ùˆ Ù†Ø±Ø® Ø±Ø¯ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ú©Ù‡ Ø¢ÛŒØ§ Ø§ÙØ²Ø§ÛŒØ´ Ø¨Ø§Ø± Ø¨Ù‡ Ø§ÙØª Ú©ÛŒÙÛŒØª Ù…Ù†Ø¬Ø± Ø´Ø¯Ù‡ Ø§Ø³Øª ÛŒØ§ Ø®ÛŒØ±. Ø¯Ø± Ù…ÙˆØ§Ø±Ø¯ÛŒ Ú©Ù‡ Ù†Ø±Ø® Ø±Ø¯ Ø¨Ø§Ù„Ø§ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ø§Ø²Ù†Ú¯Ø±ÛŒ ÙØ±Ù…â€ŒÙ‡Ø§ØŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ø³Ø§Ø²ÛŒ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ Ùˆ Ø¢Ù…ÙˆØ²Ø´ Ù‡Ø¯ÙÙ…Ù†Ø¯ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…ÙˆØ«Ø± Ø¨Ø§Ø´Ø¯. ØªØ­Ù„ÛŒÙ„ Ø±ÙˆÙ†Ø¯ÛŒ Ø§ÛŒÙ† Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ Ø¯Ø± Ø¨Ø§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù‡Ø§Ù†Ù‡ØŒ ØªØ§Ø«ÛŒØ± Ù…Ø¯Ø§Ø®Ù„Ø§Øª Ø±Ø§ Ø¨Ù‡â€ŒØ·ÙˆØ± Ø¹ÛŒÙ†ÛŒ Ø¢Ø´Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ù‡Ù…Ú†Ù†ÛŒÙ† Ù…Ø³ØªÙ†Ø¯Ø³Ø§Ø²ÛŒ ØªØ¬Ø±Ø¨ÛŒØ§Øª Ù…ÙˆÙÙ‚ Ø§ÙØ±Ø§Ø¯ Ø¨Ø±ØªØ± Ùˆ Ø§Ù†ØªØ´Ø§Ø± Ø¢Ù† Ø¨Ù‡â€ŒØ¹Ù†ÙˆØ§Ù† Ø§Ù„Ú¯ÙˆØŒ Ù…Ø³ÛŒØ± Ø§Ø±ØªÙ‚Ø§ÛŒ Ø¬Ù…Ø¹ÛŒ ØªÛŒÙ… Ø±Ø§ Ù‡Ù…ÙˆØ§Ø± Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯. Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ù¾Ø±ØªÚ©Ø±Ø§Ø± Ùˆ Ù¾ÛŒÙˆÙ†Ø¯ Ø¢Ù† Ø¨Ø§ ØªØ®ØµØµ Ø­Ø§Ù…ÛŒØ§Ù†ØŒ ØªÙˆØ²ÛŒØ¹ Ú©Ø§Ø±Ø¢Ù…Ø¯ØªØ± Ø§Ø±Ø¬Ø§Ø¹Ø§Øª Ø±Ø§ Ù…Ù…Ú©Ù† Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ø¯Ø± Ù†Ù‡Ø§ÛŒØª Ù‡Ø¯ÙØŒ Ø§ÛŒØ¬Ø§Ø¯ ØªØ¹Ø§Ø¯Ù„ Ù¾Ø§ÛŒØ¯Ø§Ø± Ø¨ÛŒÙ† Ú©Ù…ÛŒØª Ùˆ Ú©ÛŒÙÛŒØª Ø§Ø³Øª ØªØ§ Ø¶Ù…Ù† Ù¾Ø§Ø³Ø®â€ŒÚ¯ÙˆÛŒÛŒ Ø¨Ù‡ ØªÙ‚Ø§Ø¶Ø§ÛŒ Ø±Ùˆ Ø¨Ù‡ Ø±Ø´Ø¯ØŒ Ø±Ø¶Ø§ÛŒØª Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ù†ÛŒØ² Ø¯Ø± Ø³Ø·Ø­ Ù…Ø·Ù„ÙˆØ¨ Ø¨Ø§Ù‚ÛŒ Ø¨Ù…Ø§Ù†Ø¯. Ø§ÛŒÙ† Ú¯Ø²Ø§Ø±Ø´ Ù…Ø¨Ù†Ø§ÛŒ ØªØµÙ…ÛŒÙ…â€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§ØªÛŒ Ù…Ø§Ù†Ù†Ø¯ ØªØ®ØµÛŒØµ Ù…Ù†Ø§Ø¨Ø¹ØŒ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ùˆ ØªØ¹Ø±ÛŒÙ SLA Ù‡Ø§ÛŒ Ø§Ø®ØªØµØ§ØµÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø§Ú© Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯.
            """
        )
    else:
        st.info('Ø¯Ø§Ø¯Ù‡ Ù‚Ø§Ø¨Ù„ Ø§ØªÚ©Ø§ Ø¨Ø±Ø§ÛŒ ØªÙÚ©ÛŒÚ© Ø­Ø§Ù…ÛŒØ§Ù† Ø§Ø±Ø§Ú© ÛŒØ§ÙØª Ù†Ø´Ø¯Ø› Ù„Ø·ÙØ§Ù‹ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªÙØµÛŒÙ„ÛŒ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯.')

    st.markdown("---")
    # Ø¨Ø®Ø´ 2: Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø§Ú©
    st.markdown("### ğŸ¯ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ­ØµÛŒÙ„ÛŒ ÙˆØ§Ø­Ø¯ Ø§Ø±Ø§Ú©")
    if clusters_arak is not None and not getattr(clusters_arak, 'empty', True):
        # Ø§ÛŒÙ…Ù†â€ŒØ³Ø§Ø²ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¹Ø¯Ø¯ÛŒ
        for _c in ['Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§', 'ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†']:
            if _c in clusters_arak.columns:
                clusters_arak[_c] = pd.to_numeric(clusters_arak[_c], errors='coerce').fillna(0)

        active = clusters_arak[clusters_arak.get('Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§', 0) > 0]
        top_active = active.nlargest(min(15, len(active)), 'Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§') if 'Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§' in active.columns else active.head(15)
        if not top_active.empty:
            fig_ca = px.bar(top_active, x='Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§', y=range(len(top_active)), orientation='h', title='Û±Ûµ Ø®ÙˆØ´Ù‡ Ù¾Ø±Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø±Ø§Ú©', color='Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§', color_continuous_scale='reds')
            st.plotly_chart(fig_ca, use_container_width=True)

        sample = clusters_arak.sample(n=min(200, len(clusters_arak))) if len(clusters_arak) > 0 else clusters_arak
        if 'ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†' in sample.columns and 'Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§' in sample.columns:
            fig_cs = px.scatter(sample, x='ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†', y='Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§', color=sample.get('Ù…Ù‚Ø·Ø¹', None), size='Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§', title='Ø±Ø§Ø¨Ø·Ù‡ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ùˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¯Ø± Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø§Ú©')
            st.plotly_chart(fig_cs, use_container_width=True)

        _render_paragraph(
            "Ú¯Ø²Ø§Ø±Ø´ ØªÙØµÛŒÙ„ÛŒ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø§Ú©",
            """
Ø§ÛŒÙ† ØªØ­Ù„ÛŒÙ„ Ø¨ÛŒØ§Ù† Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ú©Ø¯Ø§Ù… Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ø§Ø±Ø§Ú© Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø¨Ø§Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø§ ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯ Ùˆ Ø±Ø§Ø¨Ø·Ù‡ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ø´Ø¯Øª ØªÙ‚Ø§Ø¶Ø§ Ú†Ú¯ÙˆÙ†Ù‡ Ø§Ø³Øª. ØªÙ…Ø±Ú©Ø² ØªÙ‚Ø§Ø¶Ø§ Ø¨Ø± Ú†Ù†Ø¯ Ù…ÙˆØ¶ÙˆØ¹ Ù¾Ø±ØªÚ©Ø±Ø§Ø±ØŒ Ù„Ø²ÙˆÙ… Ø·Ø±Ø§Ø­ÛŒ Ù…Ø­ØªÙˆØ§Ù‡Ø§ÛŒ Ø±Ø§Ù‡Ù†Ù…Ø§ Ùˆ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø®ØªØµØ§ØµÛŒ Ø±Ø§ Ø¨Ø±Ø¬Ø³ØªÙ‡ Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯. Ø¯Ø± Ú†Ù†ÛŒÙ† Ø´Ø±Ø§ÛŒØ·ÛŒ Ø¨Ù‡â€ŒÚ©Ø§Ø±Ú¯ÛŒØ±ÛŒ ØµÙ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ùˆ Ù…Ù†ØªÙˆØ±Ø´ÛŒÙ¾ ØªØ®ØµØµÛŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø§Ø² Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ù„ÙˆÚ¯Ø§Ù‡ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ú©Ù†Ø¯. Ù†Ù…ÙˆØ¯Ø§Ø± Ù¾Ø±Ø§Ú©Ù†Ø¯Ú¯ÛŒ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ø¢ÛŒØ§ Ø§ÙØ²Ø§ÛŒØ´ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø®ÙˆØ´Ù‡ Ø§Ù„Ø²Ø§Ù…Ø§Ù‹ Ø¨Ù‡ Ø§ÙØ²Ø§ÛŒØ´ ØªÙ‚Ø§Ø¶Ø§ Ù…Ù†Ø¬Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ ÛŒØ§ Ø¹ÙˆØ§Ù…Ù„ Ø¯ÛŒÚ¯Ø±ÛŒ (Ù…Ø§Ù†Ù†Ø¯ Ù¾ÛŒÚ†ÛŒØ¯Ú¯ÛŒ Ù…ÙˆØ¶ÙˆØ¹Ø§Øª ÛŒØ§ Ú©ÛŒÙÛŒØª Ø±Ø§Ù‡Ù†Ù…Ø§Ù‡Ø§) Ø¯Ø®ÛŒÙ„â€ŒØ§Ù†Ø¯. Ø¨Ø§ Ø±ØµØ¯ ØªØºÛŒÛŒØ±Ø§Øª Ø§ÛŒÙ† Ø§Ù„Ú¯ÙˆÙ‡Ø§ Ø¯Ø± Ø²Ù…Ø§Ù†ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù† ØªØ§Ø«ÛŒØ± Ø³ÛŒØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒØŒ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ùˆ Ø®ÙˆØ¯ÛŒØ§Ø±ÛŒ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ø±Ø§ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ú©Ø±Ø¯. Ù‡Ø¯Ù Ø±Ø§Ù‡Ø¨Ø±Ø¯ÛŒ Ø¢Ù† Ø§Ø³Øª Ú©Ù‡ Ø¯Ø± Ø¹ÛŒÙ† Ù¾Ø§Ø³Ø® Ø¨Ù‡ ØªÙ‚Ø§Ø¶Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒØŒ Ú©ÛŒÙÛŒØª Ù¾Ø§Ø³Ø® Ùˆ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø¯Ø± Ø³Ø·Ø­ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø­ÙØ¸ Ø´ÙˆØ¯ Ùˆ Ø±Ø¶Ø§ÛŒØª Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ø§Ø±ØªÙ‚Ø§ ÛŒØ§Ø¨Ø¯. Ø§ÛŒÙ† Ú¯Ø²Ø§Ø±Ø´ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ÙˆØ±ÙˆØ¯ÛŒ Ø§Ø±Ø²Ø´Ù…Ù†Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ®ØµÛŒØµ Ù…Ù†Ø§Ø¨Ø¹ØŒ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ ØªÙˆØ¬ÛŒÙ‡ÛŒ Ùˆ ØªÙˆØ³Ø¹Ù‡ Ø³Ø§Ù…Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ù„Ùâ€ŒØ³Ø±ÙˆÛŒØ³ Ø¯Ø± Ø³Ø·Ø­ ÙˆØ§Ø­Ø¯ Ø§Ø±Ø§Ú© Ø¨Ø§Ø´Ø¯.
            """
        )
    else:
        st.info('Ø¯Ø§Ø¯Ù‡ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø§Ú© ÛŒØ§ÙØª Ù†Ø´Ø¯Ø› Ù„Ø·ÙØ§Ù‹ ØµØ­Øª Ø³ØªÙˆÙ† Â«ÙˆØ§Ø­Ø¯/Ù†Ø§Ù…_ÙˆØ§Ø­Ø¯Â» Ø¯Ø± 13.xlsx Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.')

    st.markdown("---")
    # Ø¨Ø®Ø´ 3: Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ùˆ ÙˆØ¶Ø¹ÛŒØª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø§Ú©
    st.markdown("### ğŸ“ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ùˆ ÙˆØ¶Ø¹ÛŒØª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¯Ø± Ø§Ø±Ø§Ú©")
    if arak_row is not None:
        done = int(arak_row.get('Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡', 0))
        rej = int(arak_row.get('Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø±Ø¯_Ø´Ø¯Ù‡', 0))
        ip = int(arak_row.get('Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¯Ø±_Ø­Ø§Ù„_Ø§Ù†Ø¬Ø§Ù…', 0))
        fig_st = go.Figure()
        fig_st.add_trace(go.Bar(name='Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡', x=['Ø§Ø±Ø§Ú©'], y=[done], marker_color='#27AE60'))
        fig_st.add_trace(go.Bar(name='Ø±Ø¯ Ø´Ø¯Ù‡', x=['Ø§Ø±Ø§Ú©'], y=[rej], marker_color='#E74C3C'))
        fig_st.add_trace(go.Bar(name='Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…', x=['Ø§Ø±Ø§Ú©'], y=[ip], marker_color='#F39C12'))
        fig_st.update_layout(barmode='stack', title='ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¯Ø± Ø§Ø±Ø§Ú©')
        st.plotly_chart(fig_st, use_container_width=True)

        _render_paragraph(
            "Ú¯Ø²Ø§Ø±Ø´ ØªÙØµÛŒÙ„ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø§Ú©",
            """
Ù†Ù…ÙˆØ¯Ø§Ø± Ø§Ù†Ø¨Ø§Ø´ØªÙ‡ ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø¯Ø± Ø§Ø±Ø§Ú© Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ùˆ Ø¨Ù‡â€ŒØ³Ø±Ø¹Øª Ø±ÙˆØ´Ù† Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ø³Ù‡Ù… Ù‡Ø± ÙˆØ¶Ø¹ÛŒØª Ú†Ú¯ÙˆÙ†Ù‡ Ø§Ø³Øª. ØºÙ„Ø¨Ù‡ Ø¨Ø®Ø´ Â«Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡Â» Ù†Ø´Ø§Ù†Ù‡ Ú©ÛŒÙÛŒØª ÙØ±Ø¢ÛŒÙ†Ø¯ Ùˆ Ú©ÙØ§ÛŒØª Ù…Ù†Ø§Ø¨Ø¹ Ø§Ø³ØªØŒ Ø¯Ø± Ø­Ø§Ù„ÛŒâ€ŒÚ©Ù‡ Ø§ÙØ²Ø§ÛŒØ´ Â«Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…Â» Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¹Ù„Ø§Ù…Øª ÙˆØ¬ÙˆØ¯ ØµÙâ€ŒÙ‡Ø§ ÛŒØ§ Ú©Ù…Ø¨ÙˆØ¯ Ø¸Ø±ÙÛŒØª Ø¨Ø§Ø´Ø¯. Ø¯Ø± ØµÙˆØ±Øª Ø±Ø´Ø¯ Â«Ø±Ø¯ Ø´Ø¯Ù‡Â»ØŒ Ø¨Ø§ÛŒØ¯ Ú©ÛŒÙÛŒØª ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ØŒ Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§ Ùˆ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ù¾Ø°ÛŒØ±Ø´ Ø¨Ø§Ø²Ù†Ú¯Ø±ÛŒ Ø´ÙˆØ¯. Ù¾Ø§ÛŒØ´ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ Ø§ÛŒÙ† Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ Ø§Ø«Ø± Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø§ØµÙ„Ø§Ø­ÛŒ Ø±Ø§ Ù‚Ø§Ø¨Ù„ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯ Ùˆ Ø¨Ù‡ Ú†Ø§Ø¨Ú©ÛŒ ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯. ØªØ¹Ø±ÛŒÙ Ø¢Ø³ØªØ§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ù‡Ø´Ø¯Ø§Ø±ØŒ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ Ø±Ø³ÛŒØ¯Ú¯ÛŒ Ø¨Ù‡ Ù¾Ø±ÙˆÙ†Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¹Ø·Ù„ Ùˆ ØªÙ‚ÙˆÛŒØª ØªÛŒÙ… Ù¾Ø§Ø³Ø® Ø¯Ø± Ø¯ÙˆØ±Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒÚ©ØŒ Ø§Ø² Ø§Ù„Ø²Ø§Ù…Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¢Ù…Ø¯ Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ø± Ø¯Ø± Ø§Ø±Ø§Ú© Ø§Ø³Øª. Ø¯Ø± Ù†Ù‡Ø§ÛŒØªØŒ Ù‡Ø¯Ù Ø­ÙØ¸ ØªØ¹Ø§Ø¯Ù„ Ù¾Ø§ÛŒØ¯Ø§Ø± Ù…ÛŒØ§Ù† Ø³Ø±Ø¹Øª Ùˆ Ú©ÛŒÙÛŒØª Ù¾Ø§Ø³Ø® Ùˆ Ø§Ø±ØªÙ‚Ø§ÛŒ ØªØ¬Ø±Ø¨Ù‡ Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ø§Ø³Øª.
            """
        )
    else:
        st.info('Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ø­Ø¯ Ø§Ø±Ø§Ú© Ø¯Ø± Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø­Ø¯Ù‡Ø§ ÛŒØ§ÙØª Ù†Ø´Ø¯Ø› Ù„Ø·ÙØ§Ù‹ 14.xlsx Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯.')

def create_download_section(supporters_df, units_df, clusters_df):
    """Ø¨Ø®Ø´ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§"""
    st.markdown("## ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§")
    
    col1, col2, col3 = st.columns(3)
    
    # ØªØ¹ÛŒÛŒÙ† Ø§ÛŒÙ†Ú©Ù‡ Ú©Ø¯Ø§Ù… engine Ø§Ú©Ø³Ù„ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³ØªØ› Ø§Ú¯Ø± Ù‡ÛŒÚ†â€ŒÚ©Ø¯Ø§Ù… Ù†ØµØ¨ Ù†Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ù‡ CSV Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯ÛŒÙ…
    import importlib
    excel_engine = None
    if importlib.util.find_spec('openpyxl') is not None:
        excel_engine = 'openpyxl'
    elif importlib.util.find_spec('xlsxwriter') is not None:
        excel_engine = 'xlsxwriter'

    with col1:
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´ Ø­Ø§Ù…ÛŒØ§Ù†
        # Ù‡Ù…ÛŒØ´Ù‡ Ø§ÙˆÙ„ ØªÙ„Ø§Ø´ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ÙØ§ÛŒÙ„ XLSX Ø¨Ø³Ø§Ø²ÛŒÙ…Ø› Ø§Ú¯Ø± engine Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†Ø¨ÙˆØ¯ØŒ Ø®Ø·Ø§ÛŒ Ø§Ù…Ù† Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ… Ùˆ CSV Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
        xlsx_supported = excel_engine is not None
        if xlsx_supported:
            try:
                supporters_excel = BytesIO()
                supporters_df.to_excel(supporters_excel, index=False, engine=excel_engine)
                supporters_excel.seek(0)
                st.download_button(
                    label="ğŸ“Š Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´ Ø­Ø§Ù…ÛŒØ§Ù† (XLSX)",
                    data=supporters_excel,
                    file_name=f"Ú¯Ø²Ø§Ø±Ø´_Ø­Ø§Ù…ÛŒØ§Ù†_{datetime.now().strftime('%Y%m%d')}.xlsx",
                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                )
            except Exception:
                xlsx_supported = False

        if not xlsx_supported:
            supporters_csv = BytesIO()
            supporters_df.to_csv(supporters_csv, index=False)
            supporters_csv.seek(0)
            st.info("ØªÙˆØ¬Ù‡: Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ ÙØ§ÛŒÙ„ Excel (XLSX) Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒÛŒ Ù…Ø§Ù†Ù†Ø¯ openpyxl ÛŒØ§ xlsxwriter Ù†ÛŒØ§Ø² Ø§Ø³ØªØ› Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± CSV Ø¹Ø±Ø¶Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.")
            st.download_button(
                label="ğŸ“Š Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´ Ø­Ø§Ù…ÛŒØ§Ù† (CSV)",
                data=supporters_csv,
                file_name=f"Ú¯Ø²Ø§Ø±Ø´_Ø­Ø§Ù…ÛŒØ§Ù†_{datetime.now().strftime('%Y%m%d')}.csv",
                mime="text/csv"
            )
    
    with col2:
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´ ÙˆØ§Ø­Ø¯Ù‡Ø§ (XLSX ÛŒØ§ CSV)
        xlsx_supported = excel_engine is not None
        if xlsx_supported:
            try:
                units_excel = BytesIO()
                units_df.to_excel(units_excel, index=False, engine=excel_engine)
                units_excel.seek(0)
                st.download_button(
                    label="ğŸ›ï¸ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´ ÙˆØ§Ø­Ø¯Ù‡Ø§ (XLSX)",
                    data=units_excel,
                    file_name=f"Ú¯Ø²Ø§Ø±Ø´_ÙˆØ§Ø­Ø¯Ù‡Ø§_{datetime.now().strftime('%Y%m%d')}.xlsx",
                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                )
            except Exception:
                xlsx_supported = False

        if not xlsx_supported:
            units_csv = BytesIO()
            units_df.to_csv(units_csv, index=False)
            units_csv.seek(0)
            st.info("ØªÙˆØ¬Ù‡: Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ ÙØ§ÛŒÙ„ Excel (XLSX) Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒÛŒ Ù…Ø§Ù†Ù†Ø¯ openpyxl ÛŒØ§ xlsxwriter Ù†ÛŒØ§Ø² Ø§Ø³ØªØ› Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± CSV Ø¹Ø±Ø¶Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.")
            st.download_button(
                label="ğŸ›ï¸ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´ ÙˆØ§Ø­Ø¯Ù‡Ø§ (CSV)",
                data=units_csv,
                file_name=f"Ú¯Ø²Ø§Ø±Ø´_ÙˆØ§Ø­Ø¯Ù‡Ø§_{datetime.now().strftime('%Y%m%d')}.csv",
                mime="text/csv"
            )
    
    with col3:
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ (XLSX ÛŒØ§ CSV)
        xlsx_supported = excel_engine is not None
        if xlsx_supported:
            try:
                clusters_excel = BytesIO()
                clusters_df.to_excel(clusters_excel, index=False, engine=excel_engine)
                clusters_excel.seek(0)
                st.download_button(
                    label="ğŸ¯ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ (XLSX)", 
                    data=clusters_excel,
                    file_name=f"Ú¯Ø²Ø§Ø±Ø´_Ø®ÙˆØ´Ù‡_Ù‡Ø§_{datetime.now().strftime('%Y%m%d')}.xlsx",
                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                )
            except Exception:
                xlsx_supported = False

        if not xlsx_supported:
            clusters_csv = BytesIO()
            clusters_df.to_csv(clusters_csv, index=False)
            clusters_csv.seek(0)
            st.info("ØªÙˆØ¬Ù‡: Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ ÙØ§ÛŒÙ„ Excel (XLSX) Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒÛŒ Ù…Ø§Ù†Ù†Ø¯ openpyxl ÛŒØ§ xlsxwriter Ù†ÛŒØ§Ø² Ø§Ø³ØªØ› Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± CSV Ø¹Ø±Ø¶Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.")
            st.download_button(
                label="ğŸ¯ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ (CSV)", 
                data=clusters_csv,
                file_name=f"Ú¯Ø²Ø§Ø±Ø´_Ø®ÙˆØ´Ù‡_Ù‡Ø§_{datetime.now().strftime('%Y%m%d')}.csv",
                mime="text/csv"
            )

def main():
    """ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†"""
    # Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ â€” Ø§Ø¬Ø§Ø²Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ… Ú©Ø§Ø±Ø¨Ø± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†Ø¯ (Ø§Ú¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ Ù†Ø´Ø¯ØŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡ Ù…ÛŒâ€ŒØ¢ÛŒÙ†Ø¯)
    st.sidebar.markdown("## ğŸ“ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)")
    sup_file = st.sidebar.file_uploader("ÙØ§ÛŒÙ„ Ø­Ø§Ù…ÛŒØ§Ù† (CSV/XLSX)", type=['csv', 'xls', 'xlsx'], key='sup')
    units_file = st.sidebar.file_uploader("ÙØ§ÛŒÙ„ ÙˆØ§Ø­Ø¯Ù‡Ø§ (CSV/XLSX)", type=['csv', 'xls', 'xlsx'], key='units')
    clusters_file = st.sidebar.file_uploader("ÙØ§ÛŒÙ„ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§ (CSV/XLSX)", type=['csv', 'xls', 'xlsx'], key='clusters')

    def _read_table_with_fallback(uploaded_file):
        """Read CSV or Excel-like uploads with multiple encoding/engine fallbacks.
        Returns a DataFrame or None.
        """
        if uploaded_file is None:
            return None

        name = getattr(uploaded_file, 'name', '') or ''
        lower = name.lower()

        # helper: try csv with several encodings
        def try_csv(fileobj):
            for enc in ('utf-8', 'cp1256', 'cp1252', 'latin1'):
                try:
                    fileobj.seek(0)
                    return pd.read_csv(fileobj, encoding=enc)
                except Exception:
                    continue
            try:
                fileobj.seek(0)
                return pd.read_csv(fileobj, engine='python', encoding='utf-8', sep=',')
            except Exception:
                return None

        def _normalize_cols(df):
            cols = []
            for c in df.columns:
                s = str(c).strip()
                s = s.replace('\u00A0', ' ')
                s = s.replace('\u200C', '')
                s = s.replace('-', '_')
                s = s.replace(' ', '_')
                s = s.replace('ÛŒ', 'ÛŒ')
                s = s.replace('__', '_')
                cols.append(s)
            df.columns = cols
            return df

        # If filename indicates Excel, try read_excel first
        if lower.endswith(('.xls', '.xlsx')):
            try:
                uploaded_file.seek(0)
                df = pd.read_excel(uploaded_file)
                return _normalize_cols(df)
            except Exception:
                # fall back to csv attempts
                try:
                    uploaded_file.seek(0)
                    csv_df = try_csv(uploaded_file)
                    if csv_df is not None:
                        return _normalize_cols(csv_df)
                except Exception:
                    return None

        # otherwise try CSV first, then try Excel
        csv_df = try_csv(uploaded_file)
        if csv_df is not None:
            return _normalize_cols(csv_df)

        # last resort: try read_excel
        try:
            uploaded_file.seek(0)
            df = pd.read_excel(uploaded_file)
            return _normalize_cols(df)
        except Exception:
            return None

    def _map_columns(df, expected_cols):
        # expected_cols is ordered list; try exact match, substring match, then positional map
        if df is None:
            return None
        cols = list(df.columns)
        # exact match
        if set(expected_cols).issubset(set(cols)):
            return df[expected_cols].copy()

        # normalized substring matching
        import re

        def normalize(s):
            if s is None:
                return ''
            s = str(s).lower()
            # keep Persian/Arabic letters and ASCII word chars
            s = re.sub(r"[^\w\u0600-\u06FF]", '', s)
            return s

        col_norm = {c: normalize(c) for c in cols}
        exp_norm = {e: normalize(e) for e in expected_cols}

        rename_map = {}
        for c, cn in col_norm.items():
            for e, en in exp_norm.items():
                if en and (en in cn or cn in en):
                    rename_map[c] = e
                    break
            if c in rename_map:
                continue

        # lightweight keyword fallback for common tokens
        keywords = {
            'name': ['name', 'Ù†Ø§Ù…', 'display'],
            'email': ['email', 'Ø±Ø§ÛŒØ§Ù†Ø§Ù…Ù‡', '@'],
            'cluster': ['cluster', 'Ø®ÙˆØ´Ù‡'],
            'total': ['Ú©Ù„', 'total', 'requests', 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª'],
            'new': ['new', 'Ø¬Ø¯ÛŒØ¯'],
            'in_progress': ['in_progress', 'Ø¯Ø± Ø­Ø§Ù„', 'Ø¯Ø±_Ø­Ø§Ù„'],
            'closed': ['closed', 'Ø¨Ø³ØªÙ‡', 'ØªÚ©Ù…ÛŒÙ„'],
            'rejected': ['rejected', 'Ø±Ø¯']
        }
        for c in cols:
            if c in rename_map:
                continue
            low = c.lower()
            for token, keys in keywords.items():
                for k in keys:
                    if k in low:
                        # map to an expected column that contains a matching token
                        for e in expected_cols:
                            if token in normalize(e) or token in e.lower():
                                rename_map[c] = e
                                break
                        if c in rename_map:
                            break
                if c in rename_map:
                    break

        mapped = df.rename(columns=rename_map)
        if set(expected_cols).issubset(set(mapped.columns)):
            return mapped[expected_cols].copy()

        # positional fallback
        if df.shape[1] >= len(expected_cols):
            out = df.iloc[:, :len(expected_cols)].copy()
            out.columns = expected_cols
            return out

        # last resort: return mapped copy (may be missing some expected cols)
        return mapped.copy()

    def _ensure_columns(df, expected_cols):
        """Ensure expected columns exist in df; if missing, create with safe defaults (zeros or empty strings).
        Returns a DataFrame with all expected_cols present in the same order.
        """
        if df is None:
            return None
        df = df.copy()
        for col in expected_cols:
            if col not in df.columns:
                # choose default type: numeric -> 0, otherwise empty string
                df[col] = 0 if any(tok in col for tok in ['ØªØ¹Ø¯Ø§Ø¯', 'Ú©Ù„', 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª', 'new', 'total', 'rejected']) else ''
        # reorder
        try:
            return df[expected_cols].copy()
        except Exception:
            return df.copy()

    # load uploaded or fallback to sample data
    if sup_file or units_file or clusters_file:
        sup_df = _read_table_with_fallback(sup_file)
        tmp_units = _read_table_with_fallback(units_file)
        units_df = tmp_units if (tmp_units is not None) else pd.DataFrame()
        tmp_clusters = _read_table_with_fallback(clusters_file)
        clusters_df = tmp_clusters if (tmp_clusters is not None) else pd.DataFrame()

        # map supporters columns
        expected_supporters = ['Ù†Ø§Ù…_Ù†Ù…Ø§ÛŒØ´ÛŒ', 'Ø±Ø§ÛŒØ§Ù†Ø§Ù…Ù‡', 'Ø®ÙˆØ´Ù‡_Ù‡Ø§', 'Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§', 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¬Ø¯ÛŒØ¯', 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¯Ø±_Ø­Ø§Ù„_Ø§Ù†Ø¬Ø§Ù…', 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡', 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø±Ø¯_Ø´Ø¯Ù‡']
        if sup_df is not None:
            sup_df = _map_columns(sup_df, expected_supporters)
            sup_df = _ensure_columns(sup_df, expected_supporters)
            # ensure numeric columns
            for col in ['Ø®ÙˆØ´Ù‡_Ù‡Ø§','Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§','Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¬Ø¯ÛŒØ¯','Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¯Ø±_Ø­Ø§Ù„_Ø§Ù†Ø¬Ø§Ù…','Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡','Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø±Ø¯_Ø´Ø¯Ù‡']:
                if col in sup_df.columns:
                    sup_df[col] = pd.to_numeric(sup_df[col], errors='coerce').fillna(0).astype(int)
        else:
            sup_df = None

        # map units columns
        expected_units = ['Ù†Ø§Ù…_ÙˆØ§Ø­Ø¯','Ú©Ø¯_ÙˆØ§Ø­Ø¯','Ø§Ø³ØªØ§Ù†','ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†','Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§','Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¬Ø¯ÛŒØ¯','Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¯Ø±_Ø­Ø§Ù„_Ø§Ù†Ø¬Ø§Ù…','Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡','Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø±Ø¯_Ø´Ø¯Ù‡']
        if units_df is not None and not units_df.empty:
            units_df = _map_columns(units_df, expected_units)
            units_df = _ensure_columns(units_df, expected_units)
            for col in ['ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†','Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§','Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¬Ø¯ÛŒØ¯','Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¯Ø±_Ø­Ø§Ù„_Ø§Ù†Ø¬Ø§Ù…','Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø¨Ø³ØªÙ‡_Ø´Ø¯Ù‡','Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ø±Ø¯_Ø´Ø¯Ù‡']:
                if col in units_df.columns:
                    units_df[col] = pd.to_numeric(units_df[col], errors='coerce').fillna(0).astype(int)
        else:
            units_df = None

        # map clusters columns
        expected_clusters = ['Ù†Ø§Ù…_Ø®ÙˆØ´Ù‡','ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†','Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§','Ù…Ù‚Ø·Ø¹','Ø±Ø´ØªÙ‡','ÙˆØ§Ø­Ø¯']
        if clusters_df is not None and not clusters_df.empty:
            clusters_df = _map_columns(clusters_df, expected_clusters)
            clusters_df = _ensure_columns(clusters_df, expected_clusters)
            for col in ['ØªØ¹Ø¯Ø§Ø¯_Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù†','Ú©Ù„_Ø¯Ø±Ø®ÙˆØ§Ø³Øª_Ù‡Ø§']:
                if col in clusters_df.columns:
                    clusters_df[col] = pd.to_numeric(clusters_df[col], errors='coerce').fillna(0).astype(int)
        else:
            clusters_df = None

        # if any required df is None, fallback to sample for missing ones
        sample_sup, sample_units, sample_clusters = load_sample_data()
        supporters_df = sup_df if (sup_df is not None and not sup_df.empty) else sample_sup
        units_df = units_df if (units_df is not None and not units_df.empty) else sample_units
        clusters_df = clusters_df if (clusters_df is not None and not clusters_df.empty) else sample_clusters
        # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢Ù¾Ù„ÙˆØ¯Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Ú¯Ø²Ø§Ø±Ø´ Ø§Ø±Ø§Ú©
        try:
            st.session_state['uploaded_sup_df'] = sup_df
            st.session_state['uploaded_units_df'] = units_df
            st.session_state['uploaded_clusters_df'] = clusters_df
        except Exception:
            pass
    else:
        # no uploads â€” use sample data
        supporters_df, units_df, clusters_df = load_sample_data()

    # Ù‡Ø¯Ø± Ø§ØµÙ„ÛŒ
    create_main_header()
    
    # Ø³Ø§ÛŒØ¯ Ø¨Ø§Ø± Ø¨Ø±Ø§ÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ
    st.sidebar.markdown("## ğŸ§­ Ù†Ø§ÙˆØ¨Ø±ÛŒ")
    
    page = st.sidebar.selectbox(
        "Ø§Ù†ØªØ®Ø§Ø¨ ØµÙØ­Ù‡:",
        [
            "ğŸ  Ø®Ù„Ø§ØµÙ‡ Ø§Ø¬Ø±Ø§ÛŒÛŒ",
            "ğŸ‘¥ ØªØ­Ù„ÛŒÙ„ Ø­Ø§Ù…ÛŒØ§Ù†", 
            "ğŸ›ï¸ ØªØ­Ù„ÛŒÙ„ ÙˆØ§Ø­Ø¯Ù‡Ø§",
            "ğŸ¯ ØªØ­Ù„ÛŒÙ„ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§",
            "ğŸ” Ø¨ÛŒÙ†Ø´â€ŒÙ‡Ø§ Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª",
            "ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ ÙˆØ§Ø­Ø¯ Ø§Ø±Ø§Ú©",
            "ğŸ“Œ ØªØ­Ù„ÛŒÙ„ ÙˆÛŒÚ˜Ù‡ Ø§Ø±Ø§Ú© (Ú©Ø§Ù…Ù„)",
            "ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§"
        ]
    )
    
    # ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø¬Ø§Ù†Ø¨ÛŒ
    st.sidebar.markdown("## ğŸ”§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª")
    
    show_details = st.sidebar.checkbox("Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª Ø§Ø¶Ø§ÙÛŒ", value=True)
    show_charts = st.sidebar.checkbox("Ù†Ù…Ø§ÛŒØ´ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ÛŒ ØªØ¹Ø§Ù…Ù„ÛŒ", value=True) 
    
    # Ù†Ù…Ø§ÛŒØ´ Ù…Ø­ØªÙˆØ§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±
    if page == "ğŸ  Ø®Ù„Ø§ØµÙ‡ Ø§Ø¬Ø±Ø§ÛŒÛŒ":
        display_key_metrics(supporters_df, units_df, clusters_df)
        
        if show_details:
            st.markdown("---")
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("### ğŸ“ˆ Ø±ÙˆÙ†Ø¯ Ú©Ù„ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯")
                # Ù†Ù…ÙˆØ¯Ø§Ø± Ø±ÙˆÙ†Ø¯ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡)
                dates = pd.date_range(start='2024-01-01', end='2024-12-01', freq='M')
                trend_data = pd.DataFrame({
                    'ØªØ§Ø±ÛŒØ®': dates,
                    'Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„': np.random.normal(94, 2, len(dates)),
                    'ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§': np.random.normal(2800, 200, len(dates))
                })
                
                fig_trend = px.line(trend_data, x='ØªØ§Ø±ÛŒØ®', y='Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„', 
                                  title="Ø±ÙˆÙ†Ø¯ Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ø¯Ø± Ø³Ø§Ù„")
                st.plotly_chart(fig_trend, use_container_width=True)
            
            with col2:
                st.markdown("### ğŸ¯ Ø§Ù‡Ø¯Ø§Ù Ùˆ Ø¯Ø³ØªØ§ÙˆØ±Ø¯")
                
                goals_data = {
                    'Ø´Ø§Ø®Øµ': ['Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„', 'Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ', 'Ø±Ø¶Ø§ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†'],
                    'Ù‡Ø¯Ù': ['95%', '24 Ø³Ø§Ø¹Øª', '85%'],
                    'ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ': ['94.2%', '36 Ø³Ø§Ø¹Øª', '78%'],
                    'ÙˆØ¶Ø¹ÛŒØª': ['Ù†Ø²Ø¯ÛŒÚ© Ø¨Ù‡ Ù‡Ø¯Ù', 'Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ù‡Ø¨ÙˆØ¯', 'Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ù‡Ø¨ÙˆØ¯']
                }
                
                goals_df = pd.DataFrame(goals_data)
                st.dataframe(goals_df, use_container_width=True, hide_index=True)
    
    elif page == "ğŸ‘¥ ØªØ­Ù„ÛŒÙ„ Ø­Ø§Ù…ÛŒØ§Ù†":
        create_supporters_analysis(supporters_df)
    
    elif page == "ğŸ›ï¸ ØªØ­Ù„ÛŒÙ„ ÙˆØ§Ø­Ø¯Ù‡Ø§":
        create_units_analysis(units_df)
    
    elif page == "ğŸ¯ ØªØ­Ù„ÛŒÙ„ Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§":
        create_clusters_analysis(clusters_df)
    
    elif page == "ğŸ” Ø¨ÛŒÙ†Ø´â€ŒÙ‡Ø§ Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª":
        create_comprehensive_insights(supporters_df, units_df, clusters_df)
    elif page == "ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ ÙˆØ§Ø­Ø¯ Ø§Ø±Ø§Ú©":
        create_arak_report(supporters_df, units_df, clusters_df)
    elif page == "ğŸ“Œ ØªØ­Ù„ÛŒÙ„ ÙˆÛŒÚ˜Ù‡ Ø§Ø±Ø§Ú© (Ú©Ø§Ù…Ù„)":
        create_arak_detailed_report(supporters_df, units_df, clusters_df)
    
    elif page == "ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§":
        create_download_section(supporters_df, units_df, clusters_df)
    
    # ÙÙˆØªØ±
    st.markdown("---")
    st.markdown("""
    <div style='text-align: center; color: #666; font-size: 14px;'>
    ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªØ­Ù„ÛŒÙ„ÛŒ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ Ø¢Ø²Ø§Ø¯ Ø§Ø³Ù„Ø§Ù…ÛŒ Ø§Ø³ØªØ§Ù† Ù…Ø±Ú©Ø²ÛŒ<br>
    ğŸ‘¥ ØªÙ‡ÛŒÙ‡ Ø´Ø¯Ù‡ ØªÙˆØ³Ø·: Ø¨Ø§Ø´Ú¯Ø§Ù‡ Ù¾Ú˜ÙˆÙ‡Ø´Ú¯Ø±Ø§Ù† Ø¬ÙˆØ§Ù† Ùˆ Ù†Ø®Ø¨Ú¯Ø§Ù†<br>
    ğŸ“… Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: {} | ğŸŒ Ø³Ø§Ù…Ø§Ù†Ù‡: mail.iau.ir
    </div>
    """.format(datetime.now().strftime('%Y/%m/%d - %H:%M')), unsafe_allow_html=True)
    
    # Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙÙ†ÛŒ Ø¯Ø± Ø³Ø§ÛŒØ¯ Ø¨Ø§Ø±
    st.sidebar.markdown("---")
    st.sidebar.markdown("### â„¹ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙÙ†ÛŒ")
    st.sidebar.info(f"""
    **Ø¢Ù…Ø§Ø± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:**
    - Ø­Ø§Ù…ÛŒØ§Ù†: {len(supporters_df):,}
    - ÙˆØ§Ø­Ø¯Ù‡Ø§: {len(units_df):,}  
    - Ø®ÙˆØ´Ù‡â€ŒÙ‡Ø§: {len(clusters_df):,}
    - Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: {datetime.now().strftime('%H:%M')}
    """)
    
    st.sidebar.success("âœ… ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯")

if __name__ == "__main__":
    main()